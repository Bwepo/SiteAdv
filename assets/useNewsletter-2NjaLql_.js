import{u as l,a as m}from"./useMutation-COuFGjyM.js";import{a7 as c,E as u}from"./index-BdXZqJOp.js";function f(){const e=c();return l({mutationFn:async t=>{var n,a,o;const s=t.email.trim().toLowerCase(),r=((n=t.source)==null?void 0:n.trim())||"website",{error:i}=await u.from("mladv_newsletter_subscribers").upsert({email:s,name:((a=t.name)==null?void 0:a.trim())||null,source:r,confirmed:!0,unsubscribed_at:null},{onConflict:"email"});if(i)throw i;return{email:s,name:((o=t.name)==null?void 0:o.trim())||null,source:r}},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function y(){const e=c();return l({mutationFn:async t=>{var a;const s=t.email.trim().toLowerCase(),r=((a=t.name)==null?void 0:a.trim())||null,{data:i,error:n}=await u.from("mladv_newsletter_subscribers").upsert({email:s,name:r,source:"admin",confirmed:!0,unsubscribed_at:null},{onConflict:"email"}).select("*").single();if(n)throw n;return i},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function p(){return m({queryKey:["newsletter-subscribers"],queryFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_subscribers").select("*").order("subscribed_at",{ascending:!1});if(t)throw t;return e||[]}})}function _(){return m({queryKey:["newsletter-stats"],queryFn:async()=>{const{data:e,error:t,count:s}=await u.from("mladv_newsletter_subscribers").select("*",{count:"exact"}).is("unsubscribed_at",null);if(t)throw t;const r=new Date;r.setDate(r.getDate()-7);const i=(e||[]).filter(n=>new Date(n.subscribed_at)>=r).length;return{total:s||0,active:s||0,newThisWeek:i}}})}function v(){const e=c();return l({mutationFn:async t=>{const{error:s}=await u.from("mladv_newsletter_subscribers").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function q(){return l({mutationFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_subscribers").select("email, name, subscribed_at").is("unsubscribed_at",null).order("subscribed_at",{ascending:!1});if(t)throw t;const s=["Email","Nome","Data de Inscrição"],r=(e||[]).map(o=>[o.email,o.name||"",new Date(o.subscribed_at).toLocaleDateString("pt-BR")]),i=[s.join(","),...r.map(o=>o.map(d=>`"${d}"`).join(","))].join(`
`),n=new Blob([i],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");return a.href=URL.createObjectURL(n),a.download=`newsletter-subscribers-${new Date().toISOString().split("T")[0]}.csv`,a.click(),i}})}function g(){return m({queryKey:["newsletter-campaigns"],queryFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_campaigns").select("id, subject, status, created_at, sent_at, post_id, mladv_posts(title, slug)").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function h(e){return m({queryKey:["newsletter-campaign",e],enabled:!!e,queryFn:async()=>{const{data:t,error:s}=await u.from("mladv_newsletter_campaigns").select("*, mladv_posts(title, slug)").eq("id",e).single();if(s)throw s;const{data:r,error:i}=await u.from("mladv_newsletter_deliveries").select("status").eq("campaign_id",e);if(i)throw i;const n={queued:0,sent:0,failed:0,skipped:0};return(r||[]).forEach(a=>{a.status==="queued"?n.queued++:a.status==="sent"?n.sent++:a.status==="failed"?n.failed++:a.status==="skipped"&&n.skipped++}),{campaign:t,deliveryCounts:n}}})}function C(){const e=c();return l({mutationFn:async t=>{const{data:s,error:r}=await u.functions.invoke("send-newsletter-campaign",{body:{campaignId:t}});if(r)throw r;return s},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-campaigns"]}),e.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function S(){const e=c();return l({mutationFn:async t=>{const{error:s}=await u.from("mladv_newsletter_campaigns").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-campaigns"]}),e.invalidateQueries({queryKey:["newsletter-campaign"]})}})}export{_ as a,g as b,p as c,y as d,v as e,q as f,C as g,S as h,h as i,f as u};
