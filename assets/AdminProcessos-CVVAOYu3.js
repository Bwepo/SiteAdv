import{$ as ke,r as t,j as e,m as Te,s as _e,h as j}from"./index-CVzGJF2N.js";import{u as oe}from"./useQuery-RTZn8e0k.js";import{P as De,B as Ee}from"./badge-Dy-ieKTE.js";import{B as C}from"./button-Dp0xCEGR.js";import{I as f}from"./input-CxTL6WJX.js";import{L as n}from"./label-DNBl39_v.js";import{n as ce,c as Pe,d as Ie,E as Le,A as Oe,p as qe}from"./formatters-BEt9lIUu.js";import{S as Be}from"./skeleton-BbohHaW4.js";import{D as Fe,a as Ve,c as Me,d as Re,f as $e}from"./dialog-B4bpYOXw.js";import{A as Ke,a as Qe,b as ze,c as He,d as Ue,e as Ye,f as Je,g as Ge}from"./alert-dialog-C13luzIc.js";import{T as We,a as Xe,b as ie,c as d,d as Ze,e as m}from"./table-CF9W06Qy.js";import{S as R,a as $,b as K,c as Q,d as y}from"./select-WlgZieLP.js";import{C as es}from"./ClientSelect-DedlqBRc.js";import{f as ss,P as ne}from"./crmTypes-Dh7W-NG9.js";import{S as de}from"./scale-D7gx5vxg.js";import{S as as}from"./search-BWha_JlO.js";import{F as me}from"./filter-igjmESf9.js";import{C as ts}from"./clipboard-list-BLuCtXo4.js";import{P as rs}from"./pencil-CBy8Igod.js";import{T as ls}from"./trash-2-ckFcwNDt.js";import{L as os}from"./loader-circle-r4BGt9rb.js";import{A as cs}from"./arrow-up-down-1HFu1hsh.js";import"./download-1H2aEg1E.js";import"./file-text-C-PxbLHZ.js";import"./tabs-B23R9_G6.js";import"./index-lT-4g4UI.js";import"./index-1twT0wpt.js";import"./TipTapEditor-DP2WAqOS.js";import"./index-I8U44dou.js";import"./dropdown-menu-BCBZMuOv.js";import"./index-6Y30UARU.js";import"./chevron-right-357Eeodz.js";import"./check-OmfZpSNp.js";import"./link-dQBTCl-b.js";import"./list-BCiphOTr.js";import"./quote-mRBnBuy2.js";import"./textarea-giQEuHH0.js";import"./index-Cjr0FG3_.js";import"./index-BM9oB-LH.js";import"./chevron-up-DLiT2VpM.js";import"./popover-BkRPVcRI.js";const w=l=>_e.from(l);function is(l){return{id:l.id,clienteAirtableId:l.cliente_airtable_id||"",numero:l.numero||"",titulo:l.titulo||void 0,vara:l.vara||void 0,comarca:l.comarca||void 0,status:l.status||"Ativo",observacoes:l.observacoes||void 0,valorCausa:l.valor_causa!=null?Number(l.valor_causa):null,createdAt:l.created_at||"",updatedAt:l.updated_at||""}}const ue=["crm","processos-page"];function Gs(){const l=ke(),{clients:S}=ss(),{data:c=[],isLoading:xe}=oe({queryKey:ue,queryFn:async()=>{const{data:s,error:a}=await w("mladv_crm_processos").select("*").order("created_at",{ascending:!1});if(a)throw a;return(s||[]).map(is)}}),z=t.useCallback(()=>{l.invalidateQueries({queryKey:ue}),l.invalidateQueries({queryKey:["crm-processos"]})},[l]),[v,he]=t.useState(""),[i,H]=t.useState("all"),[x,pe]=t.useState("all"),[A,ge]=t.useState("created_at"),[U,Y]=t.useState("desc"),[je,N]=t.useState(!1),[h,J]=t.useState(null),[G,W]=t.useState(!1),[D,E]=t.useState(null),[k,P]=t.useState(""),[X,I]=t.useState(""),[Z,L]=t.useState(""),[ee,O]=t.useState(""),[se,q]=t.useState("Ativo"),[ae,B]=t.useState(""),[te,F]=t.useState(""),[fe,V]=t.useState(""),[ve,M]=t.useState(""),{data:T=new Map}=oe({queryKey:["crm","processo-task-counts"],queryFn:async()=>{const{data:s,error:a}=await w("mladv_crm_tarefas").select("numero_processo");if(a)throw a;const r=new Map;(s||[]).forEach(u=>{const g=u.numero_processo;g&&r.set(g,(r.get(g)||0)+1)});const o=new Map;return c.forEach(u=>{o.set(u.id,r.get(u.numero)||0)}),o},enabled:c.length>0}),p=t.useMemo(()=>{const s=new Map;return S.forEach(a=>s.set(a.id,a.name)),s},[S]),Ne=s=>{A===s?Y(a=>a==="asc"?"desc":"asc"):(ge(s),Y("asc"))},_=t.useMemo(()=>{let s=c;if(v.trim()){const a=v.toLowerCase();s=s.filter(r=>{var o,u,g,le;return r.numero.toLowerCase().includes(a)||((o=r.titulo)==null?void 0:o.toLowerCase().includes(a))||((u=r.vara)==null?void 0:u.toLowerCase().includes(a))||((g=r.comarca)==null?void 0:g.toLowerCase().includes(a))||((le=p.get(r.clienteAirtableId))==null?void 0:le.toLowerCase().includes(a))})}return i!=="all"&&(s=s.filter(a=>a.status===i)),x!=="all"&&(s=s.filter(a=>a.clienteAirtableId===x)),[...s].sort((a,r)=>{let o=0;switch(A){case"numero":o=a.numero.localeCompare(r.numero);break;case"titulo":o=(a.titulo||"").localeCompare(r.titulo||"");break;case"status":o=a.status.localeCompare(r.status);break;case"cliente":o=(p.get(a.clienteAirtableId)||"").localeCompare(p.get(r.clienteAirtableId)||"");break;case"tarefas":o=(T.get(a.id)??0)-(T.get(r.id)??0);break;case"created_at":o=(a.createdAt||"").localeCompare(r.createdAt||"");break}return U==="asc"?o:-o})},[c,v,i,x,A,U,p,T]),be=t.useMemo(()=>{const s=new Set(c.map(a=>a.status));return Array.from(s).sort()},[c]),Ce=t.useMemo(()=>{const s=new Set(c.map(a=>a.clienteAirtableId).filter(Boolean));return S.filter(a=>s.has(a.id))},[c,S]),ye=()=>{J(null),P(""),I(""),L(""),O(""),q("Ativo"),B(""),F(""),V(""),M(""),N(!0)},re=s=>{J(s),P(s.numero),I(s.titulo||""),L(s.vara||""),O(s.comarca||""),q(s.status),B(s.observacoes||""),F(s.valorCausa!=null?ce(s.valorCausa):""),V(s.clienteAirtableId),M(p.get(s.clienteAirtableId)||""),N(!0)},we=async()=>{if(!k.trim()){j.error("Número do processo é obrigatório");return}W(!0);try{const s={numero:k.trim(),titulo:X.trim()||null,vara:Z.trim()||null,comarca:ee.trim()||null,status:se,observacoes:ae.trim()||null,valor_causa:qe(te),cliente_airtable_id:fe||null};if(h){const{error:a}=await w("mladv_crm_processos").update(s).eq("id",h.id);if(a)throw a;j.success("Processo atualizado!")}else{const{error:a}=await w("mladv_crm_processos").insert(s);if(a)throw a;j.success("Processo criado!")}z(),N(!1)}catch(s){j.error("Erro: "+s.message)}finally{W(!1)}},Se=async()=>{if(D)try{const{error:s}=await w("mladv_crm_processos").delete().eq("id",D);if(s)throw s;j.success("Processo removido"),z()}catch(s){j.error("Erro: "+s.message)}finally{E(null)}},Ae=s=>{switch(s){case"Ativo":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";case"Arquivado":return"bg-gray-100 text-gray-800 dark:bg-gray-800/30 dark:text-gray-400";case"Encerrado":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400";case"Suspenso":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400";default:return"bg-muted text-muted-foreground"}},b=({field:s,label:a})=>e.jsxs("button",{onClick:()=>Ne(s),className:"flex items-center gap-1 hover:text-foreground transition-colors",children:[a,e.jsx(cs,{className:`h-3 w-3 ${A===s?"text-primary":"text-muted-foreground/50"}`})]});return xe?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(Be,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(Te.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"h-7 w-7 text-primary"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.length," processo",c.length!==1?"s":""," cadastrado",c.length!==1?"s":"",i!=="all"||x!=="all"?` • ${_.length} exibido${_.length!==1?"s":""}`:""]})]})]}),e.jsxs(C,{onClick:ye,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx(De,{className:"mr-2 h-4 w-4"})," Novo Processo"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(as,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(f,{value:v,onChange:s=>he(s.target.value),placeholder:"Buscar nº processo, título, vara, comarca, cliente...",className:"pl-9 min-w-[220px]"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(R,{value:i,onValueChange:H,children:[e.jsxs($,{className:"w-[140px]",children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(K,{placeholder:"Status"})]}),e.jsxs(Q,{children:[e.jsx(y,{value:"all",children:"Todos Status"}),be.map(s=>e.jsx(y,{value:s,children:s},s))]})]}),e.jsxs(R,{value:x,onValueChange:pe,children:[e.jsxs($,{className:"w-[160px]",children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(K,{placeholder:"Cliente"})]}),e.jsxs(Q,{children:[e.jsx(y,{value:"all",children:"Todos Clientes"}),Ce.map(s=>e.jsx(y,{value:s.id,children:s.name},s.id))]})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:ne.map(s=>{const a=c.filter(r=>r.status===s).length;return e.jsxs("button",{onClick:()=>H(i===s?"all":s),className:`rounded-lg border p-3 text-left transition-all hover:shadow-sm ${i===s?"ring-2 ring-primary border-primary":"border-border"}`,children:[e.jsx("p",{className:"text-2xl font-bold",children:a}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s,a!==1?"s":""]})]},s)})}),_.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(de,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum processo encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:v||i!=="all"||x!=="all"?"Tente ajustar os filtros.":"Adicione seu primeiro processo."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card overflow-x-auto",children:e.jsxs(We,{children:[e.jsx(Xe,{children:e.jsxs(ie,{children:[e.jsx(d,{children:e.jsx(b,{field:"numero",label:"Nº Processo"})}),e.jsx(d,{className:"hidden md:table-cell",children:e.jsx(b,{field:"titulo",label:"Título"})}),e.jsx(d,{className:"hidden sm:table-cell",children:e.jsx(b,{field:"cliente",label:"Cliente"})}),e.jsx(d,{className:"w-[100px]",children:e.jsx(b,{field:"status",label:"Status"})}),e.jsx(d,{className:"hidden lg:table-cell",children:"Vara / Comarca"}),e.jsx(d,{className:"hidden md:table-cell w-[120px] text-right",children:"Valor"}),e.jsx(d,{className:"hidden sm:table-cell w-[80px] text-center",children:e.jsx(b,{field:"tarefas",label:"Tarefas"})}),e.jsx(d,{className:"w-[90px] text-right",children:"Ações"})]})}),e.jsx(Ze,{children:_.map(s=>{const a=p.get(s.clienteAirtableId),r=T.get(s.id)??0;return e.jsxs(ie,{className:"cursor-pointer",onClick:()=>re(s),children:[e.jsx(m,{children:e.jsx("span",{className:"font-mono text-sm font-medium",children:s.numero})}),e.jsx(m,{className:"hidden md:table-cell",children:e.jsx("span",{className:"text-sm truncate max-w-[200px] block",children:s.titulo||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{className:"hidden sm:table-cell",children:e.jsx("span",{className:"text-sm",children:a||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{children:e.jsx(Ee,{variant:"secondary",className:Ae(s.status),children:s.status})}),e.jsx(m,{className:"hidden lg:table-cell",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:[s.vara,s.comarca].filter(Boolean).join(" • ")||"—"})}),e.jsx(m,{className:"hidden md:table-cell text-right",children:e.jsx("span",{className:"text-sm font-medium",children:s.valorCausa!=null?ce(s.valorCausa):e.jsx("span",{className:"text-muted-foreground",children:"—"})})}),e.jsx(m,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-muted-foreground",children:[e.jsx(ts,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:r})]})}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",onClick:o=>o.stopPropagation(),children:[e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>re(s),title:"Editar",children:e.jsx(rs,{className:"h-3.5 w-3.5"})}),e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>E(s.id),title:"Excluir",children:e.jsx(ls,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(Fe,{open:je,onOpenChange:N,children:e.jsxs(Ve,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(Me,{children:e.jsx(Re,{children:h?"Editar Processo":"Novo Processo"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Número do Processo *"}),e.jsx(f,{value:k,onChange:s=>P(Pe(s.target.value)),placeholder:"NNNNNNN-DD.AAAA.J.TR.OOOO",maxLength:25,autoFocus:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Título / Descrição breve"}),e.jsx(f,{value:X,onChange:s=>I(s.target.value),placeholder:"Ex: Ação de Indenização por Danos Morais"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Cliente vinculado"}),e.jsx(es,{value:ve,onValueChange:(s,a)=>{M(s),V(a)}})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Vara"}),e.jsx(f,{value:Z,onChange:s=>L(s.target.value),placeholder:"Ex: 3ª Vara Cível"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Comarca"}),e.jsx(f,{value:ee,onChange:s=>O(s.target.value),placeholder:"Ex: São Paulo/SP"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Status"}),e.jsxs(R,{value:se,onValueChange:q,children:[e.jsx($,{children:e.jsx(K,{})}),e.jsx(Q,{children:ne.map(s=>e.jsx(y,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Valor da Causa"}),e.jsx(f,{value:te,onChange:s=>F(Ie(s.target.value)),placeholder:"R$ 0,00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Observações"}),e.jsx(Le,{value:ae,onChange:B,placeholder:"Notas internas sobre o processo, decisões relevantes, próximos passos...",modalTitle:"Editar Observações do Processo"})]}),h&&e.jsx(Oe,{folder:`processos/${h.id}`})]}),e.jsxs($e,{children:[e.jsx(C,{variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsxs(C,{onClick:we,disabled:!k.trim()||G,children:[G&&e.jsx(os,{className:"h-4 w-4 animate-spin mr-2"}),h?"Salvar":"Criar Processo"]})]})]})}),e.jsx(Ke,{open:!!D,onOpenChange:s=>!s&&E(null),children:e.jsxs(Qe,{children:[e.jsxs(ze,{children:[e.jsx(He,{children:"Excluir processo?"}),e.jsx(Ue,{children:"Esta ação é permanente e não pode ser desfeita. Tarefas vinculadas a este processo não serão removidas."})]}),e.jsxs(Ye,{children:[e.jsx(Je,{children:"Cancelar"}),e.jsx(Ge,{onClick:Se,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{Gs as default};
