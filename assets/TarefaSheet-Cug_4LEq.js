import{r as d,aj as le,j as e,e as P}from"./index--VkK_6xW.js";import{u as ie,F as re,a as p,b as g,c as f,d as v,e as S,t as oe}from"./form-1xsfOPso.js";import{S as ce,a as de,b as me,c as xe,f as he,g as ue,P as je}from"./AdminLayout-BBlkaNDR.js";import{I as E}from"./input-XXLJvWnV.js";import{B as N}from"./button-BNnjEdlp.js";import{T as $}from"./textarea-pt7U9Oic.js";import{B as q}from"./badge-Dt7x2lqa.js";import{S as pe,U as G}from"./separator-BOrQnTwg.js";import{S as C,a as y,b as T,d as b,e as x}from"./select-BEs-C6p3.js";import{A as ge,a as fe,b as ve,c as Se,d as Ne,e as Ce,f as ye,g as Te}from"./alert-dialog-DdJCDIQ2.js";import{f as J,d as be,b as we,S as Ae,g as Q}from"./crmTypes-DP3iBdIv.js";import{L as W}from"./loader-circle-D38fRm10.js";import{C as _e}from"./chevron-up-BuO1GvTp.js";import{C as De}from"./chevron-right-8Qug1pP7.js";import{C as Ie}from"./circle-check-byz_LTwl.js";import{C as Ee}from"./circle-DpjQhG_t.js";import{C as Fe}from"./clock-DCptoS8H.js";import{P as Oe}from"./pencil-DtrytP-J.js";import{T as ze}from"./trash-2-CTyzDFyk.js";import{o as Be,s as _,e as H}from"./types-C9wiu8_K.js";const Pe=Be({title:_().trim().min(1,"Título obrigatório").max(200),deadline:_().optional(),priority:H(["alta","media","baixa"]),status:H(["pendente","agendado","em_andamento","em_tramite","concluida","cancelada"]),clientName:_().optional(),assignee:_().optional(),description:_().max(2e3).optional()}),Le=Object.entries(be),Re=Object.entries(we),Ve=Object.entries(Q);function Y({initial:l,onSave:u,onCancel:a,saving:j}){const[r,c]=d.useState(l??{title:"",deadline:"",status:"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(E,{placeholder:"Título da sub-tarefa *",value:r.title,onChange:n=>c(i=>({...i,title:n.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(E,{type:"date",value:r.deadline,onChange:n=>c(i=>({...i,deadline:n.target.value}))}),e.jsxs(C,{value:r.status,onValueChange:n=>c(i=>({...i,status:n})),children:[e.jsx(y,{children:e.jsx(T,{})}),e.jsx(b,{children:Ve.map(([n,i])=>e.jsx(x,{value:n,children:i},n))})]})]}),e.jsxs(C,{value:r.assignee||"_none_",onValueChange:n=>c(i=>({...i,assignee:n==="_none_"?"":n})),children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(T,{placeholder:"Responsável..."})]})}),e.jsxs(b,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),J.map(n=>e.jsx(x,{value:n,children:n},n))]})]}),e.jsx($,{placeholder:"Observações...",className:"resize-none min-h-[60px]",value:r.notes,onChange:n=>c(i=>({...i,notes:n.target.value}))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:a,disabled:j,children:"Cancelar"}),e.jsxs(N,{type:"button",size:"sm",disabled:!r.title.trim()||j,onClick:()=>u(r),children:[j&&e.jsx(W,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function Ue({sub:l,onEdit:u,onDelete:a,onToggleStatus:j}){const r=l.dueDate&&l.dueDate<new Date().toISOString().split("T")[0]&&l.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:j,className:"mt-0.5 shrink-0",children:l.completed?e.jsx(Ie,{className:"w-4 h-4 text-primary"}):e.jsx(Ee,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:P("text-sm",l.completed&&"line-through text-muted-foreground"),children:l.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx(q,{variant:"secondary",className:P("text-[10px]",Ae[l.status]),children:Q[l.status]}),l.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(G,{className:"w-3 h-3"}),l.assignee]}),l.dueDate&&e.jsxs("span",{className:P("text-[10px] flex items-center gap-0.5",r?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(Fe,{className:"w-3 h-3"}),new Date(l.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),l.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:l.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:u,children:e.jsx(Oe,{className:"w-3 h-3"})}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:a,children:e.jsx(ze,{className:"w-3 h-3"})})]})]})}function rs({open:l,onOpenChange:u,task:a,onSave:j,onCreateSubtask:r,onUpdateSubtask:c,onDeleteSubtask:n}){const i=!a,[F,L]=d.useState(!1),[R,D]=d.useState(!1),{clients:O}=le(),[z,X]=d.useState(!0),[V,w]=d.useState(!1),[Z,A]=d.useState(null),[I,B]=d.useState(null),m=ie({resolver:oe(Pe),defaultValues:{title:"",deadline:"",priority:"media",status:"pendente",clientName:"",assignee:"",description:""}});d.useEffect(()=>{l&&(w(!1),A(null),a?m.reset({title:a.title,deadline:a.dueDate??"",priority:a.priority,status:a.status,clientName:a.client??"",assignee:a.assignee??"",description:a.description??""}):m.reset({title:"",deadline:"",priority:"media",status:"pendente",clientName:"",assignee:"",description:""}))},[l,a]);const k=async s=>{L(!0);try{await j(s,i,a==null?void 0:a.airtableId),u(!1)}finally{L(!1)}},ee=d.useCallback(async s=>{if(!(!(a!=null&&a.airtableId)||!r)){D(!0);try{await r(a.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),w(!1)}finally{D(!1)}}},[a,r]),se=d.useCallback(async(s,t)=>{if(c){D(!0);try{await c(s,{title:t.title,deadline:t.deadline||void 0,status:t.status,assignee:t.assignee||void 0,notes:t.notes||void 0}),A(null)}finally{D(!1)}}},[c]),ae=d.useCallback(async s=>{if(!c)return;const t=s.completed?"A fazer":"Concluído";await c(s.id,{status:t})},[c]),te=d.useCallback(async()=>{if(!(!I||!n))try{await n(I)}finally{B(null)}},[I,n]),h=(a==null?void 0:a.subtasks)??[],U=h.filter(s=>s.completed).length,M=h.length>0?Math.round(U/h.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(ce,{open:l,onOpenChange:u,children:e.jsxs(de,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(me,{className:"mb-6",children:[e.jsx(xe,{children:i?"Nova Tarefa":"Editar Tarefa"}),e.jsx(he,{children:i?"Preencha os dados para criar a tarefa e sincronizar com o Airtable.":"Altere os campos e salve. A atualização será sincronizada automaticamente."})]}),e.jsx(re,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(k),className:"space-y-5",children:[e.jsx(p,{control:m.control,name:"title",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Título *"}),e.jsx(v,{children:e.jsx(E,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(S,{})]})}),e.jsx(p,{control:m.control,name:"deadline",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Prazo"}),e.jsx(v,{children:e.jsx(E,{type:"date",...s})}),e.jsx(S,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(p,{control:m.control,name:"priority",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Prioridade"}),e.jsxs(C,{onValueChange:s.onChange,value:s.value,children:[e.jsx(v,{children:e.jsx(y,{children:e.jsx(T,{})})}),e.jsx(b,{children:Re.map(([t,o])=>e.jsx(x,{value:t,children:o},t))})]}),e.jsx(S,{})]})}),e.jsx(p,{control:m.control,name:"status",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Status"}),e.jsxs(C,{onValueChange:s.onChange,value:s.value,children:[e.jsx(v,{children:e.jsx(y,{children:e.jsx(T,{})})}),e.jsx(b,{children:Le.map(([t,o])=>e.jsx(x,{value:t,children:o},t))})]}),e.jsx(S,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(p,{control:m.control,name:"clientName",render:({field:s})=>{var t;return e.jsxs(g,{children:[e.jsx(f,{children:"Cliente"}),e.jsxs(C,{onValueChange:o=>{var K;return s.onChange(o==="none"?"":((K=O.find(ne=>ne.id===o))==null?void 0:K.name)??o)},value:((t=O.find(o=>o.name===s.value))==null?void 0:t.id)||(s.value?s.value:""),children:[e.jsx(v,{children:e.jsx(y,{children:e.jsx(T,{placeholder:"Selecione..."})})}),e.jsxs(b,{children:[e.jsx(x,{value:"none",children:"— Sem cliente —"}),O.map(o=>e.jsx(x,{value:o.id,children:o.name},o.id))]})]}),e.jsx(S,{})]})}}),e.jsx(p,{control:m.control,name:"assignee",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Responsável"}),e.jsxs(C,{onValueChange:t=>s.onChange(t==="_none_"?"":t),value:s.value||"_none_",children:[e.jsx(v,{children:e.jsx(y,{children:e.jsx(T,{placeholder:"Selecione..."})})}),e.jsxs(b,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),J.map(t=>e.jsx(x,{value:t,children:t},t))]})]}),e.jsx(S,{})]})})]}),e.jsx(p,{control:m.control,name:"description",render:({field:s})=>e.jsxs(g,{children:[e.jsx(f,{children:"Descrição"}),e.jsx(v,{children:e.jsx($,{placeholder:"Detalhes sobre a tarefa...",className:"resize-none min-h-[80px]",...s})}),e.jsx(S,{})]})}),e.jsxs(ue,{className:"pt-2 gap-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>u(!1),disabled:F,children:"Cancelar"}),e.jsxs(N,{type:"submit",disabled:F,children:[F&&e.jsx(W,{className:"w-4 h-4 mr-2 animate-spin"}),i?"Criar tarefa":"Salvar alterações"]})]})]})}),!i&&a&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>X(!z),children:[z?e.jsx(_e,{className:"w-4 h-4"}):e.jsx(De,{className:"w-4 h-4"}),"Sub-tarefas",h.length>0&&e.jsxs(q,{variant:"secondary",className:"text-[10px] ml-1",children:[U,"/",h.length]})]}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{w(!0),A(null)},children:[e.jsx(je,{className:"w-3.5 h-3.5"})," Nova"]})]}),h.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${M}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[M,"%"]})]}),z&&e.jsxs("div",{className:"space-y-1",children:[h.map(s=>Z===s.id?e.jsx(Y,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:t=>se(s.id,t),onCancel:()=>A(null),saving:R},s.id):e.jsx(Ue,{sub:s,onEdit:()=>{A(s.id),w(!1)},onDelete:()=>B(s.id),onToggleStatus:()=>ae(s)},s.id)),h.length===0&&!V&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),V&&e.jsx(Y,{onSave:ee,onCancel:()=>w(!1),saving:R})]})]})]})]})}),e.jsx(ge,{open:!!I,onOpenChange:s=>!s&&B(null),children:e.jsxs(fe,{children:[e.jsxs(ve,{children:[e.jsx(Se,{children:"Excluir sub-tarefa?"}),e.jsx(Ne,{children:"Esta ação removerá a sub-tarefa do Airtable e não pode ser desfeita."})]}),e.jsxs(Ce,{children:[e.jsx(ye,{children:"Cancelar"}),e.jsx(Te,{onClick:te,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{rs as T};
