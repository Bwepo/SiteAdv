import{$ as q,r as _,h as b,s as h}from"./index-DQ4BcdQP.js";import{u as P}from"./useQuery-CY_b4SRx.js";const d=t=>h.from(t),w={agenda:["crm","agenda"],tarefas:["crm","tarefas"],clientes:["crm","clientes"],projetos:["crm","projetos"],all:["crm"]};function j(){return`local_${crypto.randomUUID().slice(0,12)}`}async function M(){const{data:t,error:c}=await d("mladv_crm_agenda").select("airtable_id,titulo,data_local,hora_local,tipo,status,cliente,local_evento,descricao,projeto_airtable_id").order("data_local",{ascending:!1});if(c)throw c;return{events:(t||[]).map(a=>({id:a.airtable_id,title:a.titulo||"",date:a.data_local||"",time:a.hora_local||void 0,type:a.tipo||"reuniao",status:a.status||"pendente",client:a.cliente||void 0,location:a.local_evento||void 0,description:a.descricao||void 0,projectId:a.projeto_airtable_id||void 0,airtableId:a.airtable_id}))}}async function x(){const[{data:t,error:c},{data:y,error:a}]=await Promise.all([d("mladv_crm_tarefas").select("airtable_id,titulo,descricao,status,prioridade,deadline,cliente,responsavel,projeto_airtable_id,numero_processo,relatorio_mensal").order("deadline",{ascending:!0,nullsFirst:!1}),d("mladv_crm_subtarefas").select("airtable_id,titulo,status,deadline,responsavel,tarefa_airtable_id,numero_processo,raw_fields,relatorio_mensal")]);if(c)throw c;if(a)throw a;return{tasks:(t||[]).map(u=>{const n=(y||[]).filter(v=>v.tarefa_airtable_id===u.airtable_id).map(v=>{const S=v.raw_fields||{},E=v.status||"A fazer";return{id:v.airtable_id,title:v.titulo||"",completed:E==="Concluído",status:E,dueDate:v.deadline||void 0,assignee:v.responsavel||void 0,notes:S.Observações||void 0,numeroProcesso:v.numero_processo||void 0,parentTaskId:u.airtable_id,relatorioMensal:!!v.relatorio_mensal}});return{id:u.airtable_id,title:u.titulo||"",description:u.descricao||void 0,status:u.status||"pendente",priority:u.prioridade||"media",dueDate:u.deadline||void 0,client:u.cliente||void 0,assignee:u.responsavel||void 0,projectId:u.projeto_airtable_id||void 0,numeroProcesso:u.numero_processo||void 0,subtasks:n,createdAt:"",updatedAt:"",airtableId:u.airtable_id,relatorioMensal:!!u.relatorio_mensal}})}}async function L(){const{data:t,error:c}=await d("mladv_crm_clientes").select("airtable_id,nome,slug,numero_processo,raw_fields").order("nome",{ascending:!0});if(c)throw console.error("[CRM] fetchClientes error:",c),c;return console.log("[CRM] fetchClientes returned",t==null?void 0:t.length,"rows"),{clients:(t||[]).map(a=>{const l=a.raw_fields||{};return{id:a.airtable_id,name:a.nome||"",slug:a.slug||"",email:l.email||l.Email||void 0,telefone:l.telefone||l.Telefone||void 0,endereco:l.endereco||l.Endereco||l.Endereço||void 0,documento:l.documento||l.Documento||l.CPF||l.CNPJ||void 0,tipoDocumento:l.tipo_documento||"cpf",numeroProcesso:a.numero_processo||void 0,dataNascimento:l.data_nascimento||l["Data de Nascimento"]||void 0}})}}async function I(){console.log("[CRM] fetchProjetos: starting query...");const{data:t,error:c}=await d("mladv_crm_projetos").select("airtable_id,nome,slug,status,tipo,data_inicio,observacoes,raw_fields,cover_url,cliente").order("nome",{ascending:!0});if(console.log("[CRM] fetchProjetos result:",{rows:t==null?void 0:t.length,error:c}),c)throw console.error("[CRM] fetchProjetos error:",c),c;return{projects:(t||[]).map(a=>{const l=a.raw_fields||{};return{id:a.airtable_id,name:a.nome||"",slug:a.slug||"",status:a.status||"Ativo",tipo:a.tipo||void 0,dataInicio:a.data_inicio||void 0,observacoes:a.observacoes||void 0,coverUrl:a.cover_url||l.cover_url||void 0,cliente:a.cliente||void 0}})}}function O(){const t=q(),{data:c,isLoading:y,error:a}=P({queryKey:w.agenda,queryFn:M}),l=(c==null?void 0:c.events)??[],u=a?a.message:null,n=_.useCallback(()=>{t.invalidateQueries({queryKey:w.agenda})},[t]),v=_.useCallback(async(s,r)=>{t.setQueryData(w.agenda,p=>p&&{...p,events:p.events.map(T=>T.id===s?{...T,status:r}:T)});try{await d("mladv_crm_agenda").update({status:r}).eq("airtable_id",s)}catch{n()}},[n,t]),S=_.useCallback(async s=>{await d("mladv_crm_agenda").delete().eq("airtable_id",s),n(),b.success("Compromisso removido com sucesso.")},[n]),E=_.useCallback(async s=>{const r=j();await d("mladv_crm_agenda").insert({airtable_id:r,titulo:s.title,data_local:s.date,hora_local:s.time||null,tipo:s.type,status:s.status,cliente:s.clientName||null,local_evento:s.location||null,descricao:s.description||null,projeto_airtable_id:s.projectAirtableId||null}),n(),b.success("Compromisso criado.")},[n]),g=_.useCallback(async(s,r)=>{const p={};r.title!==void 0&&(p.titulo=r.title),r.date!==void 0&&(p.data_local=r.date),r.time!==void 0&&(p.hora_local=r.time||null),r.type!==void 0&&(p.tipo=r.type),r.status!==void 0&&(p.status=r.status),r.clientName!==void 0&&(p.cliente=r.clientName||null),r.location!==void 0&&(p.local_evento=r.location||null),r.description!==void 0&&(p.descricao=r.description||null),await d("mladv_crm_agenda").update(p).eq("airtable_id",s),n(),b.success("Compromisso atualizado.")},[n]);return{events:l,loading:y,error:u,updateEventStatus:v,updateEvent:g,createEvent:E,deleteEvent:S}}function f(){const t=q(),{data:c,isLoading:y,error:a}=P({queryKey:w.tarefas,queryFn:x}),l=(c==null?void 0:c.tasks)??[],u=a?a.message:null,n=_.useCallback(()=>{t.invalidateQueries({queryKey:w.tarefas})},[t]),v=_.useCallback(i=>{t.setQueryData(w.tarefas,e=>{if(!e)return e;const o=typeof i=="function"?i(e.tasks):i;return{...e,tasks:o}})},[t]),S=_.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,o=>o&&{...o,tasks:o.tasks.map(m=>m.id===i?{...m,status:e}:m)});try{await d("mladv_crm_tarefas").update({status:e}).eq("airtable_id",i)}catch{n()}},[n,t]),E=_.useCallback(async i=>{await d("mladv_crm_tarefas").delete().eq("airtable_id",i),n(),b.success("Tarefa removida.")},[n]),g=_.useCallback(async i=>{const e=j();await d("mladv_crm_tarefas").insert({airtable_id:e,titulo:i.title,deadline:i.deadline||null,prioridade:i.priority,status:i.status,cliente:i.clientName||null,responsavel:i.assignee||null,descricao:i.description||null,projeto_airtable_id:i.projectId||null,numero_processo:i.numeroProcesso||null,relatorio_mensal:i.relatorioMensal??!1}),n(),b.success("Tarefa criada.")},[n]),s=_.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,m=>m&&{...m,tasks:m.tasks.map(A=>{if(A.id!==i)return A;const C={...A};return e.title!==void 0&&(C.title=e.title),e.deadline!==void 0&&(C.dueDate=e.deadline||void 0),e.priority!==void 0&&(C.priority=e.priority),e.status!==void 0&&(C.status=e.status),e.clientName!==void 0&&(C.client=e.clientName||void 0),e.assignee!==void 0&&(C.assignee=e.assignee||void 0),e.description!==void 0&&(C.description=e.description||void 0),e.relatorioMensal!==void 0&&(C.relatorioMensal=e.relatorioMensal),C})});const o={};e.title!==void 0&&(o.titulo=e.title),e.deadline!==void 0&&(o.deadline=e.deadline||null),e.priority!==void 0&&(o.prioridade=e.priority),e.status!==void 0&&(o.status=e.status),e.clientName!==void 0&&(o.cliente=e.clientName||null),e.assignee!==void 0&&(o.responsavel=e.assignee||null),e.description!==void 0&&(o.descricao=e.description||null),e.projectId!==void 0&&(o.projeto_airtable_id=e.projectId||null),e.numeroProcesso!==void 0&&(o.numero_processo=e.numeroProcesso||null),e.relatorioMensal!==void 0&&(o.relatorio_mensal=e.relatorioMensal),e.status!==void 0&&(o.status=e.status),e.clientName!==void 0&&(o.cliente=e.clientName||null),e.assignee!==void 0&&(o.responsavel=e.assignee||null),e.description!==void 0&&(o.descricao=e.description||null),e.projectId!==void 0&&(o.projeto_airtable_id=e.projectId||null),e.numeroProcesso!==void 0&&(o.numero_processo=e.numeroProcesso||null);try{await d("mladv_crm_tarefas").update(o).eq("airtable_id",i)}catch{n(),b.error("Erro ao atualizar tarefa.");return}b.success("Tarefa atualizada.")},[n,t]),r=_.useCallback(async(i,e)=>{const o=j(),{error:m}=await d("mladv_crm_subtarefas").insert({airtable_id:o,titulo:e.title,tarefa_airtable_id:i,status:e.status??"A fazer",deadline:e.deadline||null,responsavel:e.assignee||null,raw_fields:e.notes?{Observações:e.notes}:{},numero_processo:e.numeroProcesso||null});if(m)throw console.error("[CRM] createSubtask error:",m),b.error("Erro ao criar sub-tarefa: "+m.message),m;return n(),b.success("Sub-tarefa criada."),o},[n]),p=_.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,m=>m&&{...m,tasks:m.tasks.map(A=>({...A,subtasks:A.subtasks.map(C=>{if(C.id!==i)return C;const k={...C};return e.title!==void 0&&(k.title=e.title),e.status!==void 0&&(k.status=e.status,k.completed=e.status==="Concluído"),e.deadline!==void 0&&(k.dueDate=e.deadline||void 0),e.assignee!==void 0&&(k.assignee=e.assignee||void 0),e.relatorioMensal!==void 0&&(k.relatorioMensal=e.relatorioMensal),k})}))});const o={};e.title!==void 0&&(o.titulo=e.title),e.status!==void 0&&(o.status=e.status),e.deadline!==void 0&&(o.deadline=e.deadline||null),e.assignee!==void 0&&(o.responsavel=e.assignee||null),e.numeroProcesso!==void 0&&(o.numero_processo=e.numeroProcesso||null),e.relatorioMensal!==void 0&&(o.relatorio_mensal=e.relatorioMensal);try{await d("mladv_crm_subtarefas").update(o).eq("airtable_id",i)}catch{n(),b.error("Erro ao atualizar sub-tarefa.");return}b.success("Sub-tarefa atualizada.")},[n,t]),T=_.useCallback(async i=>{await d("mladv_crm_subtarefas").delete().eq("airtable_id",i),n(),b.success("Sub-tarefa removida.")},[n]);return{tasks:l,setTasks:v,loading:y,error:u,updateTaskStatus:S,deleteTask:E,createTask:g,updateTask:s,createSubtask:r,updateSubtask:p,deleteSubtask:T}}function z(){const{data:t,isLoading:c,error:y}=P({queryKey:w.clientes,queryFn:L}),a=(t==null?void 0:t.clients)??[],l=y?y.message:null;return{clients:a,loading:c,error:l}}function U(){const t=q(),{data:c,isLoading:y,error:a}=P({queryKey:w.projetos,queryFn:I}),l=(c==null?void 0:c.projects)??[],u=a?a.message:null,n=_.useCallback(()=>{t.invalidateQueries({queryKey:w.projetos})},[t]),v=_.useCallback(async g=>{const s=j(),r=g.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");await d("mladv_crm_projetos").insert({airtable_id:s,nome:g.name,slug:r,status:g.status||"Ativo",tipo:g.tipo||null,observacoes:g.observacoes||null,cliente:g.cliente||null}),n(),b.success("Projeto criado.")},[n]),S=_.useCallback(async(g,s)=>{const r={};s.name!==void 0&&(r.nome=s.name,r.slug=s.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")),s.status!==void 0&&(r.status=s.status),s.tipo!==void 0&&(r.tipo=s.tipo||null),s.observacoes!==void 0&&(r.observacoes=s.observacoes||null),s.cliente!==void 0&&(r.cliente=s.cliente||null),await d("mladv_crm_projetos").update(r).eq("airtable_id",g),n(),b.success("Projeto atualizado.")},[n]),E=_.useCallback(async g=>{await d("mladv_crm_projetos").delete().eq("airtable_id",g),n(),b.success("Projeto removido.")},[n]);return{projects:l,loading:y,error:u,createProject:v,updateProject:S,deleteProject:E}}const K={Pendente:"Pendente",Agendado:"Agendado","A fazer":"A fazer","Em andamento":"Em andamento",Concluído:"Concluído"},D={Pendente:"bg-red-100 text-red-800",Agendado:"bg-slate-100 text-slate-800","A fazer":"bg-orange-100 text-orange-800","Em andamento":"bg-yellow-100 text-yellow-800",Concluído:"bg-green-100 text-green-800"},Q=["Ativo","Arquivado","Encerrado","Suspenso"],B={reuniao:"Reunião",audiencia:"Audiência",prazo:"Prazo",consulta:"Consulta",lembrete:"Lembrete",outro:"Outro"},F={confirmado:"Confirmado",pendente:"Pendente",cancelado:"Cancelado",reagendado:"Reagendado"},Y={pendente:"Pendente",agendado:"Agendado",em_andamento:"Em Andamento",em_tramite:"Em Trâmite",concluida:"Concluída",cancelada:"Cancelada"},V={alta:"Alta",media:"Média",baixa:"Baixa"},$={reuniao:"bg-blue-100 text-blue-800",audiencia:"bg-purple-100 text-purple-800",prazo:"bg-red-100 text-red-800",consulta:"bg-green-100 text-green-800",lembrete:"bg-yellow-100 text-yellow-800",outro:"bg-gray-100 text-gray-800"},J={alta:"bg-red-100 text-red-800",media:"bg-yellow-100 text-yellow-800",baixa:"bg-green-100 text-green-800"},G={pendente:"bg-red-100 text-red-800",agendado:"bg-slate-100 text-slate-800",em_andamento:"bg-yellow-100 text-yellow-800",em_tramite:"bg-blue-100 text-blue-800",concluida:"bg-green-100 text-green-800",cancelada:"bg-gray-100 text-gray-800"},H=["Mariana Lima","Equipe ML"];export{$ as E,Q as P,K as S,J as T,f as a,U as b,V as c,B as d,F as e,z as f,H as g,D as h,Y as i,G as j,O as u};
