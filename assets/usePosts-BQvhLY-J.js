import{a as f,u as h}from"./useMutation-ByvBBF59.js";import{ad as w,I as o}from"./index-DpMNL0-g.js";async function q(e){if(e.length===0)return new Map;const{data:t,error:s}=await o.from("mladv_post_categories").select("post_id, category_id").in("post_id",e);if(s||!t)return new Map;const a=[...new Set(t.map(u=>u.category_id))];if(a.length===0)return new Map;const{data:r,error:n}=await o.from("mladv_categories").select("*").in("id",a);if(n||!r)return new Map;const d=new Map(r.map(u=>[u.id,u])),i=new Map;return e.forEach(u=>{const y=t.filter(l=>l.post_id===u).map(l=>d.get(l.category_id)).filter(l=>l!==void 0);i.set(u,y)}),i}function T(e={}){const{published:t,page:s=1,pageSize:a=10,search:r,categorySlug:n,tag:d}=e;return f({queryKey:["posts",{published:t,page:s,pageSize:a,search:r,categorySlug:n,tag:d}],queryFn:async()=>{if(n){const{data:p}=await o.from("mladv_categories").select("id").eq("slug",n).maybeSingle();if(!p)return{posts:[],total:0,totalPages:0};const{data:m}=await o.from("mladv_post_categories").select("post_id").eq("category_id",p.id),v=(m==null?void 0:m.map(g=>g.post_id))||[];if(v.length===0)return{posts:[],total:0,totalPages:0};let c=o.from("mladv_posts").select("*",{count:"exact"}).in("id",v);t!==void 0&&(c=c.eq("published",t)),r&&(c=c.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),d&&(c=c.contains("tags",[d])),c=c.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((s-1)*a,s*a-1);const{data:F,error:b,count:K}=await c;if(b)throw b;const M=F||[],P=await q(M.map(g=>g.id));return{posts:M.map(g=>({...g,categories:P.get(g.id)||[]})),total:K??0,totalPages:Math.ceil((K??0)/a)}}let i=o.from("mladv_posts").select("*",{count:"exact"});t!==void 0&&(i=i.eq("published",t)),r&&(i=i.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),d&&(i=i.contains("tags",[d])),i=i.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((s-1)*a,s*a-1);const{data:u,error:y,count:l}=await i;if(y)throw y;const _=u||[],C=await q(_.map(p=>p.id));return{posts:_.map(p=>({...p,categories:C.get(p.id)||[]})),total:l??0,totalPages:Math.ceil((l??0)/a)}}})}function $(){return f({queryKey:["featured-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").eq("published",!0).eq("featured",!0).order("published_at",{ascending:!1}).limit(3);if(t)throw t;const s=e||[],a=await q(s.map(n=>n.id));return s.map(n=>({...n,categories:a.get(n.id)||[]}))}})}function x(){return f({queryKey:["all-tags"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("tags").eq("published",!0);if(t)throw t;const s=(e==null?void 0:e.flatMap(r=>r.tags||[]))||[];return[...new Set(s)].sort()}})}function E(e){return f({queryKey:["post",e],queryFn:async()=>{const{data:t,error:s}=await o.from("mladv_posts").select("*").eq("slug",e).eq("published",!0).maybeSingle();if(s)throw s;return t},enabled:!!e})}function A(e){return f({queryKey:["post-by-id",e],queryFn:async()=>{const{data:t,error:s}=await o.from("mladv_posts").select("*").eq("id",e).maybeSingle();if(s)throw s;return t},enabled:!!e})}function D(){return f({queryKey:["all-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function I(){const e=w();return h({mutationFn:async t=>{const{data:s,error:a}=await o.from("mladv_posts").insert(t).select().single();if(a)throw a;return s},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]})}})}function z(){const e=w();return h({mutationFn:async({id:t,...s})=>{const{data:a,error:r}=await o.from("mladv_posts").update({...s,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(r)throw r;return a},onSuccess:t=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post",t.slug]}),e.invalidateQueries({queryKey:["post-by-id",t.id]})}})}function B(){const e=w();return h({mutationFn:async t=>{const{error:s}=await o.from("mladv_posts").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]})}})}export{$ as a,T as b,E as c,D as d,z as e,B as f,I as g,A as h,x as u};
