import{r as o,y as P,j as e}from"./index-DnjXBAvV.js";import{P as w,A as _}from"./AdminLayout-GoPn7mOs.js";import{B as d}from"./button-C1OahYzB.js";import{I as z}from"./input-B5uriiMB.js";import{L as D}from"./label-DMd9Md2J.js";import{D as B,b as q,a as U,c as V,d as W,e as G,f as J}from"./dialog-IyiMgRDc.js";import{T as K,b as Q}from"./newsletterTemplate-ClNbuMGO.js";import{g as X,b as Y,h as Z,i as $,j as ee}from"./useNewsletter-ByFJ8B8y.js";import{g as b}from"./supabaseErrors-eYWJjREL.js";import{L as se}from"./loader-circle-wPyVPevs.js";import{C as A,a as E,b as S,c as T}from"./card-Cl5Wb-3_.js";import{T as ae,a as te,b as N,c as f,d as ie,e as u,A as re,f as ne,g as le,h as oe,i as de,j as ce,k as me,l as he}from"./alert-dialog-Pav6AKHm.js";import{S as C}from"./skeleton-DlV8S8bz.js";import"./chevron-left-BLmsAeHw.js";import"./house-B33Z6Rsp.js";import"./file-text-DxO78R_v.js";import"./mail-DIrU2tIW.js";import"./index-BhtXWOLu.js";import"./index-CHXUL98j.js";import"./index-DXcRkU2x.js";import"./dropdown-menu-qCns5ZIm.js";import"./index-CcTjtGsW.js";import"./index-Dpnq0UtW.js";import"./chevron-right-DrSqmzUQ.js";import"./check-Cn0xTTe9.js";import"./tabs-BciKV6CN.js";import"./link-BcoSu_KU.js";import"./list-DoPiUHRB.js";import"./quote-CqO9rDEq.js";import"./trash-2-BWr7n5uM.js";import"./useMutation-DBgBEdPJ.js";function ue(){const[a,x]=o.useState(!1),[n,p]=o.useState(""),[c,j]=o.useState(""),r=X(),{toast:i}=P(),m=async()=>{if(!n.trim()){i({title:"Assunto obrigatório",description:"Informe o assunto do e-mail.",variant:"destructive"});return}if(!c.trim()){i({title:"Conteúdo obrigatório",description:"Escreva o conteúdo do e-mail.",variant:"destructive"});return}try{const l=Q({title:n.trim(),content:c,postUrl:"https://marianalima.adv.br"});await r.mutateAsync({subject:n.trim(),html:l,post_id:""}),i({title:"Campanha criada!",description:"A campanha foi criada com os deliveries na fila."}),p(""),j(""),x(!1)}catch(l){i({title:"Erro ao criar campanha",description:b(l,"Não foi possível criar a campanha."),variant:"destructive"})}};return e.jsxs(B,{open:a,onOpenChange:x,children:[e.jsx(q,{asChild:!0,children:e.jsxs(d,{children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Nova campanha"]})}),e.jsxs(U,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(V,{children:[e.jsx(W,{children:"Nova campanha manual"}),e.jsx(G,{children:"Crie uma campanha sem vínculo a um post. O conteúdo será enviado a todos os inscritos ativos."})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"campaign-subject",children:"Assunto do e-mail *"}),e.jsx(z,{id:"campaign-subject",value:n,onChange:l=>p(l.target.value),placeholder:"Novidades do escritório...",maxLength:200})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Conteúdo *"}),e.jsx("div",{className:"min-h-[250px]",children:e.jsx(K,{content:c,onChange:j,placeholder:"Escreva o conteúdo da campanha..."})})]})]}),e.jsxs(J,{children:[e.jsx(d,{variant:"outline",onClick:()=>x(!1),children:"Cancelar"}),e.jsxs(d,{onClick:m,disabled:r.isPending,children:[r.isPending?e.jsx(se,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(w,{className:"w-4 h-4 mr-2"}),"Criar campanha"]})]})]})]})}const L={draft:"Rascunho",queued:"Fila",sending:"Enviando",sent:"Enviada",partial:"Parcial",failed:"Falhou"},xe={queued:"Na fila",sent:"Enviados",failed:"Falhou",skipped:"Ignorados"},H=a=>a?new Date(a).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",Ge=()=>{const{data:a,isLoading:x}=Y(),[n,p]=o.useState(null),[c,j]=o.useState(null),[r,i]=o.useState(null),{toast:m}=P(),l=Z(),g=$(),{data:h,isLoading:k}=ee(n),t=(h==null?void 0:h.campaign)??null,y=h==null?void 0:h.deliveryCounts,I=o.useMemo(()=>((a==null?void 0:a.length)??0)>0,[a]),F=s=>["draft","queued","partial"].includes(s),M=async s=>{j(s);try{await l.mutateAsync(s),m({title:"Envio iniciado",description:"A campanha foi enviada para a fila de envios."})}catch(v){const R=b(v,"Não foi possível iniciar o envio.");m({title:"Erro ao enviar",description:R,variant:"destructive"})}finally{j(null)}},O=async()=>{if(r)try{await g.mutateAsync(r),m({title:"Campanha excluída",description:"A campanha foi removida com sucesso."}),n===r&&p(null)}catch(s){const v=b(s,"Não foi possível excluir a campanha.");m({title:"Erro ao excluir",description:v,variant:"destructive"})}finally{i(null)}};return e.jsxs(_,{title:"Campanhas de Newsletter",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("div",{}),e.jsx(ue,{})]}),e.jsxs(A,{className:"mb-6",children:[e.jsx(E,{children:e.jsx(S,{children:"Campanhas"})}),e.jsx(T,{children:x?e.jsxs("div",{className:"space-y-3",children:[e.jsx(C,{className:"h-8 w-full"}),e.jsx(C,{className:"h-8 w-full"}),e.jsx(C,{className:"h-8 w-full"})]}):e.jsxs(ae,{children:[e.jsx(te,{children:e.jsxs(N,{children:[e.jsx(f,{children:"Assunto"}),e.jsx(f,{children:"Status"}),e.jsx(f,{children:"Criado em"}),e.jsx(f,{children:"Enviado em"}),e.jsx(f,{className:"text-right",children:"Ações"})]})}),e.jsx(ie,{children:I?a==null?void 0:a.map(s=>e.jsxs(N,{children:[e.jsx(u,{className:"font-medium",children:s.subject}),e.jsx(u,{children:L[s.status]??s.status}),e.jsx(u,{children:H(s.created_at)}),e.jsx(u,{children:H(s.sent_at)}),e.jsx(u,{className:"text-right",children:e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[F(s.status)&&e.jsx(d,{variant:"default",size:"sm",onClick:()=>M(s.id),disabled:c===s.id,children:c===s.id?"Enviando...":"Enviar agora"}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>p(s.id),children:"Ver detalhes"}),e.jsx(d,{variant:"destructive",size:"sm",onClick:()=>i(s.id),disabled:g.isPending,children:"Excluir"})]})})]},s.id)):e.jsx(N,{children:e.jsx(u,{colSpan:5,className:"text-center text-muted-foreground py-8",children:'Nenhuma campanha cadastrada ainda. As campanhas são criadas automaticamente ao publicar posts com a opção "Enviar newsletter" ativada.'})})})]})})]}),e.jsxs(A,{children:[e.jsx(E,{children:e.jsx(S,{children:"Detalhes da campanha"})}),e.jsx(T,{children:k?e.jsxs("div",{className:"space-y-3",children:[e.jsx(C,{className:"h-6 w-1/2"}),e.jsx(C,{className:"h-24 w-full"})]}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-wrap items-center justify-end gap-3",children:e.jsx(d,{variant:"destructive",size:"sm",onClick:()=>i(t.id),disabled:g.isPending,children:"Excluir campanha"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Assunto"}),e.jsx("p",{className:"text-base font-medium text-foreground",children:t.subject})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx("p",{className:"text-base font-medium text-foreground",children:L[t.status]??t.status})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Post relacionado"}),t.post?e.jsxs("div",{className:"text-base font-medium text-foreground",children:[t.post.title,e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["/blog/",t.post.slug]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Resumo de envios"}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-4 mt-2",children:Object.entries(xe).map(([s,v])=>e.jsxs("div",{className:"rounded-lg border border-border bg-muted/30 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:v}),e.jsx("p",{className:"text-lg font-semibold text-foreground",children:y?y[s]:0})]},s))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Preview HTML"}),e.jsx("div",{className:"mt-2 max-h-[320px] overflow-auto rounded-lg border border-border bg-background p-4",children:t.html?e.jsx("div",{className:"prose max-w-none",dangerouslySetInnerHTML:{__html:t.html}}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Sem conteúdo HTML."})})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione uma campanha para ver os detalhes."})})]}),e.jsx(re,{open:!!r,onOpenChange:()=>i(null),children:e.jsxs(ne,{children:[e.jsxs(le,{children:[e.jsx(oe,{children:"Excluir campanha?"}),e.jsx(de,{children:"Esta ação remove a campanha e seu histórico de envios. Essa ação não pode ser desfeita."})]}),e.jsxs(ce,{children:[e.jsx(me,{children:"Cancelar"}),e.jsx(he,{onClick:O,disabled:g.isPending,children:g.isPending?"Excluindo...":"Excluir"})]})]})})]})};export{Ge as default};
