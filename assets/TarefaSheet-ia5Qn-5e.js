import{c as ie,r as x,j as e,e as P,aj as oe,ai as ce,h as de}from"./index-BvZpt6_-.js";import{u as he,F as xe,a as S,b as N,c as C,d as b,e as y,S as D,f as A,g as E,h as _,i as j,t as me}from"./form-DA8uyQD9.js";import{S as ue,b as pe,c as je,d as ge,e as fe,f as ve}from"./sheet-DkUNjpgs.js";import{I as V}from"./input-Ch28ePyu.js";import{B as g}from"./button-BHZQesTD.js";import{T as Se}from"./textarea-BN4RKX2W.js";import{D as Ne,a as Ce,c as be,d as ye,f as Te}from"./dialog-0FpMd1rI.js";import{T as we}from"./TipTapEditor-CAvWvWWw.js";import{B as q}from"./badge-BTeKtkMP.js";import{S as De,U as G}from"./separator-CM9NCm4e.js";import{A as Ae,a as Ee,b as _e,c as Ie,d as Oe,e as ze,f as Fe,g as Me}from"./alert-dialog-EqxRRR-f.js";import{d as J,f as Le,a as $e,e as Pe,S as Q,P as Ve}from"./crmTypes-CmvVoXTp.js";import{L as X}from"./loader-circle-C3zyyxlp.js";import{C as Re}from"./chevron-up-BGRNgUQW.js";import{C as Be}from"./chevron-right-BXs3i7q0.js";import{P as Ue}from"./plus-BrCCLAJz.js";import{C as He}from"./circle-check-C2weMQaH.js";import{C as Ke}from"./dropdown-menu-BwNFrZKR.js";import{C as We}from"./clock-DDH2SH-p.js";import{T as Ye}from"./trash-2-BTUNUdsR.js";import{o as qe,s as z,e as W}from"./types-C9wiu8_K.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=ie("Expand",[["path",{d:"m21 21-6-6m6 6v-4.8m0 4.8h-4.8",key:"1c15vz"}],["path",{d:"M3 16.2V21m0 0h4.8M3 21l6-6",key:"1fsnz2"}],["path",{d:"M21 7.8V3m0 0h-4.8M21 3l-6 6",key:"hawz9i"}],["path",{d:"M3 7.8V3m0 0h4.8M3 3l6 6",key:"u9ee12"}]]);function Je({open:n,onOpenChange:c,title:r="Editar Observações",value:i,onChange:h}){const[d,a]=x.useState(i),l=x.useCallback(u=>{u&&a(i),c(u)},[i,c]),o=()=>{h(d),c(!1)};return e.jsx(Ne,{open:n,onOpenChange:l,children:e.jsxs(Ce,{className:"max-w-4xl w-[95vw] max-h-[90vh] flex flex-col p-0",children:[e.jsx(be,{className:"px-6 pt-6 pb-0",children:e.jsx(ye,{children:r})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4 min-h-0",children:e.jsx("div",{className:"[&_.border]:overflow-visible [&_.border]:flex [&_.border]:flex-col [&_.border]:max-h-full",children:e.jsx(we,{content:d,onChange:a,placeholder:"Escreva suas observações aqui..."})})}),e.jsxs(Te,{className:"px-6 pb-6 pt-2 gap-2 border-t border-border",children:[e.jsx(g,{variant:"outline",onClick:()=>c(!1),children:"Cancelar"}),e.jsx(g,{onClick:o,children:"Salvar"})]})]})})}function Qe(n){if(!n)return"";const c=String(n).trim();if(!c)return"";if(/<[a-z][\s\S]*>/i.test(c))return c;const r=c.split(/\r?\n/),i=[];let h=!1;const d=l=>{let o=l.replace(/\\-/g,"-");return o=o.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),o},a=()=>{h&&(i.push("</ul>"),h=!1)};for(const l of r){const o=l.trim();if(!o){a();continue}const u=o.match(/^(#{1,6})\s+(.+)$/);if(u){a();const f=Math.min(u[1].length,6);i.push(`<h${f}>${d(u[2])}</h${f}>`);continue}const T=o.match(/^\*\*(.+?)\*\*:?$/);if(T){a();const f=T[1];f.match(/^(\d+)\)\s+(.+)$/)?i.push(`<h3>${d(f)}</h3>`):i.push(`<p><strong>${d(f)}${o.endsWith(":")?":":""}</strong></p>`);continue}const I=o.match(/^(\d+)\)\s+(.+)$/);if(I){a(),i.push(`<h3>${I[1]}) ${d(I[2])}</h3>`);continue}const w=o.replace(/^\\-/,"-"),O=w.match(/^(-|•|\*)\s+(.+)$/);if(O&&!w.startsWith("**")){h||(i.push("<ul>"),h=!0),i.push(`<li>${d(O[2])}</li>`);continue}a(),i.push(`<p>${d(o)}</p>`)}return a(),i.join("")}function Xe(n){return n?/<[a-z][\s\S]*>/i.test(n)?new DOMParser().parseFromString(n,"text/html").body.textContent||"":n:""}function Z({value:n,onChange:c,placeholder:r="Observações...",className:i,modalTitle:h="Editar Observações"}){const[d,a]=x.useState(!1),l=Qe(n)||n,o=Xe(l),u=l!==o&&l.includes("<");return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative group",children:[e.jsx(Se,{placeholder:r,className:P("resize-none min-h-[80px] pr-10",i),value:o,onChange:T=>c(T.target.value)}),e.jsx(g,{type:"button",variant:"ghost",size:"icon",className:"absolute top-1.5 right-1.5 h-7 w-7 opacity-50 group-hover:opacity-100 transition-opacity",onClick:()=>a(!0),title:"Expandir editor",children:e.jsx(Ge,{className:"w-3.5 h-3.5"})}),u&&e.jsx("span",{className:"absolute bottom-1.5 right-1.5 text-[10px] text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:"Texto formatado"})]}),e.jsx(Je,{open:d,onOpenChange:a,title:h,value:l,onChange:c})]})}const Ze=qe({title:z().trim().min(1,"Título obrigatório").max(200),deadline:z().optional(),priority:W(["alta","media","baixa"]),status:W(["pendente","agendado","em_andamento","em_tramite","concluida","cancelada"]),clientName:z().optional(),projectId:z().optional(),assignee:z().optional(),description:z().max(2e3).optional()}),ke=Object.entries(Le),es=Object.entries($e),ss=Object.entries(Q);function Y({initial:n,onSave:c,onCancel:r,saving:i}){const[h,d]=x.useState(n??{title:"",deadline:"",status:"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(V,{placeholder:"Título da sub-tarefa *",value:h.title,onChange:a=>d(l=>({...l,title:a.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(V,{type:"date",value:h.deadline,onChange:a=>d(l=>({...l,deadline:a.target.value}))}),e.jsxs(D,{value:h.status,onValueChange:a=>d(l=>({...l,status:a})),children:[e.jsx(A,{children:e.jsx(E,{})}),e.jsx(_,{children:ss.map(([a,l])=>e.jsx(j,{value:a,children:l},a))})]})]}),e.jsxs(D,{value:h.assignee||"_none_",onValueChange:a=>d(l=>({...l,assignee:a==="_none_"?"":a})),children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(E,{placeholder:"Responsável..."})]})}),e.jsxs(_,{children:[e.jsx(j,{value:"_none_",children:"— Sem responsável —"}),J.map(a=>e.jsx(j,{value:a,children:a},a))]})]}),e.jsx(Z,{value:h.notes,onChange:a=>d(l=>({...l,notes:a})),placeholder:"Observações...",className:"min-h-[60px]",modalTitle:"Editar Observações da Subtarefa"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:r,disabled:i,children:"Cancelar"}),e.jsxs(g,{type:"button",size:"sm",disabled:!h.title.trim()||i,onClick:()=>c(h),children:[i&&e.jsx(X,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function as({sub:n,onEdit:c,onDelete:r,onToggleStatus:i}){const h=n.dueDate&&n.dueDate<new Date().toISOString().split("T")[0]&&n.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:i,className:"mt-0.5 shrink-0",children:n.completed?e.jsx(He,{className:"w-4 h-4 text-primary"}):e.jsx(Ke,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:P("text-sm",n.completed&&"line-through text-muted-foreground"),children:n.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx(q,{variant:"secondary",className:P("text-[10px]",Pe[n.status]),children:Q[n.status]}),n.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(G,{className:"w-3 h-3"}),n.assignee]}),n.dueDate&&e.jsxs("span",{className:P("text-[10px] flex items-center gap-0.5",h?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(We,{className:"w-3 h-3"}),new Date(n.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),n.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:n.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(g,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:c,children:e.jsx(Ve,{className:"w-3 h-3"})}),e.jsx(g,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:r,children:e.jsx(Ye,{className:"w-3 h-3"})})]})]})}function ys({open:n,onOpenChange:c,task:r,defaultClientName:i,onSave:h,onCreateSubtask:d,onUpdateSubtask:a,onDeleteSubtask:l}){const o=!r,[u,T]=x.useState(!1),[I,w]=x.useState(!1),{clients:O}=oe(),{projects:f}=ce(),[L,k]=x.useState(!0),[B,F]=x.useState(!1),[ee,M]=x.useState(null),[$,R]=x.useState(null),p=he({resolver:me(Ze),defaultValues:{title:"",deadline:"",priority:"media",status:"pendente",clientName:"",projectId:"",assignee:"",description:""}});x.useEffect(()=>{n&&(F(!1),M(null),r?p.reset({title:r.title,deadline:r.dueDate??"",priority:r.priority,status:r.status,clientName:r.client??"",projectId:r.projectId??"",assignee:r.assignee??"",description:r.description??""}):p.reset({title:"",deadline:"",priority:"media",status:"pendente",clientName:i??"",projectId:"",assignee:"",description:""}))},[n,r]);const se=async s=>{T(!0);try{await h(s,o,r==null?void 0:r.airtableId),c(!1)}catch(t){de.error("Erro ao salvar tarefa: "+t.message),console.error("Erro ao salvar tarefa:",t)}finally{T(!1)}},ae=x.useCallback(async s=>{if(!(!(r!=null&&r.airtableId)||!d)){w(!0);try{await d(r.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),F(!1)}finally{w(!1)}}},[r,d]),te=x.useCallback(async(s,t)=>{if(a){w(!0);try{await a(s,{title:t.title,deadline:t.deadline||void 0,status:t.status,assignee:t.assignee||void 0,notes:t.notes||void 0}),M(null)}finally{w(!1)}}},[a]),ne=x.useCallback(async s=>{if(!a)return;const t=s.completed?"A fazer":"Concluído";await a(s.id,{status:t})},[a]),re=x.useCallback(async()=>{if(!(!$||!l))try{await l($)}finally{R(null)}},[$,l]),v=(r==null?void 0:r.subtasks)??[],U=v.filter(s=>s.completed).length,H=v.length>0?Math.round(U/v.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(ue,{open:n,onOpenChange:c,children:e.jsxs(pe,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(je,{className:"mb-6",children:[e.jsx(ge,{children:o?"Nova Tarefa":"Editar Tarefa"}),e.jsx(fe,{children:o?"Preencha os dados para criar a tarefa e sincronizar com o Airtable.":"Altere os campos e salve. A atualização será sincronizada automaticamente."})]}),e.jsx(xe,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit(se),className:"space-y-5",children:[e.jsx(S,{control:p.control,name:"title",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Título *"}),e.jsx(b,{children:e.jsx(V,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(y,{})]})}),e.jsx(S,{control:p.control,name:"deadline",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Prazo"}),e.jsx(b,{children:e.jsx(V,{type:"date",...s})}),e.jsx(y,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(S,{control:p.control,name:"priority",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Prioridade"}),e.jsxs(D,{onValueChange:s.onChange,value:s.value,children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{})})}),e.jsx(_,{children:es.map(([t,m])=>e.jsx(j,{value:t,children:m},t))})]}),e.jsx(y,{})]})}),e.jsx(S,{control:p.control,name:"status",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Status"}),e.jsxs(D,{onValueChange:s.onChange,value:s.value,children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{})})}),e.jsx(_,{children:ke.map(([t,m])=>e.jsx(j,{value:t,children:m},t))})]}),e.jsx(y,{})]})})]}),e.jsx(S,{control:p.control,name:"projectId",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Projeto"}),e.jsxs(D,{onValueChange:t=>s.onChange(t==="none"?"":t),value:s.value||"none",children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{placeholder:"Selecione..."})})}),e.jsxs(_,{children:[e.jsx(j,{value:"none",children:"— Sem projeto —"}),f.map(t=>e.jsx(j,{value:t.id,children:t.name},t.id))]})]}),e.jsx(y,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(S,{control:p.control,name:"clientName",render:({field:s})=>{var t;return e.jsxs(N,{children:[e.jsx(C,{children:"Cliente"}),e.jsxs(D,{onValueChange:m=>{var K;return s.onChange(m==="none"?"":((K=O.find(le=>le.id===m))==null?void 0:K.name)??m)},value:((t=O.find(m=>m.name===s.value))==null?void 0:t.id)||(s.value?s.value:""),children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{placeholder:"Selecione..."})})}),e.jsxs(_,{children:[e.jsx(j,{value:"none",children:"— Sem cliente —"}),O.map(m=>e.jsx(j,{value:m.id,children:m.name},m.id))]})]}),e.jsx(y,{})]})}}),e.jsx(S,{control:p.control,name:"assignee",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Responsável"}),e.jsxs(D,{onValueChange:t=>s.onChange(t==="_none_"?"":t),value:s.value||"_none_",children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{placeholder:"Selecione..."})})}),e.jsxs(_,{children:[e.jsx(j,{value:"_none_",children:"— Sem responsável —"}),J.map(t=>e.jsx(j,{value:t,children:t},t))]})]}),e.jsx(y,{})]})})]}),e.jsx(S,{control:p.control,name:"description",render:({field:s})=>e.jsxs(N,{children:[e.jsx(C,{children:"Descrição"}),e.jsx(b,{children:e.jsx(Z,{value:s.value??"",onChange:s.onChange,placeholder:"Detalhes sobre a tarefa...",modalTitle:"Editar Descrição da Tarefa"})}),e.jsx(y,{})]})}),e.jsxs(ve,{className:"pt-2 gap-2",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:u,children:"Cancelar"}),e.jsxs(g,{type:"submit",disabled:u,children:[u&&e.jsx(X,{className:"w-4 h-4 mr-2 animate-spin"}),o?"Criar tarefa":"Salvar alterações"]})]})]})}),!o&&r&&e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>k(!L),children:[L?e.jsx(Re,{className:"w-4 h-4"}):e.jsx(Be,{className:"w-4 h-4"}),"Sub-tarefas",v.length>0&&e.jsxs(q,{variant:"secondary",className:"text-[10px] ml-1",children:[U,"/",v.length]})]}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{F(!0),M(null)},children:[e.jsx(Ue,{className:"w-3.5 h-3.5"})," Nova"]})]}),v.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${H}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[H,"%"]})]}),L&&e.jsxs("div",{className:"space-y-1",children:[v.map(s=>ee===s.id?e.jsx(Y,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:t=>te(s.id,t),onCancel:()=>M(null),saving:I},s.id):e.jsx(as,{sub:s,onEdit:()=>{M(s.id),F(!1)},onDelete:()=>R(s.id),onToggleStatus:()=>ne(s)},s.id)),v.length===0&&!B&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),B&&e.jsx(Y,{onSave:ae,onCancel:()=>F(!1),saving:I})]})]})]})]})}),e.jsx(Ae,{open:!!$,onOpenChange:s=>!s&&R(null),children:e.jsxs(Ee,{children:[e.jsxs(_e,{children:[e.jsx(Ie,{children:"Excluir sub-tarefa?"}),e.jsx(Oe,{children:"Esta ação removerá a sub-tarefa do Airtable e não pode ser desfeita."})]}),e.jsxs(ze,{children:[e.jsx(Fe,{children:"Cancelar"}),e.jsx(Me,{onClick:re,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{Z as E,ys as T,Qe as m};
