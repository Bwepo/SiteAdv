import{r as c,am as ie,an as oe,j as e,e as L,l as ce}from"./index-DH8vj_f5.js";import{u as de,F as xe,a as j,b as u,c as p,d as g,e as f,t as me}from"./form-Cxk8iRxX.js";import{S as he,a as je,b as ue,c as pe,f as ge,g as fe,B as q,P as ve}from"./AdminLayout-D1nYNvrV.js";import{I as F}from"./input-DhPErQV0.js";import{B as b}from"./button-C2YcoeDs.js";import{T as G}from"./textarea-_h8wOObh.js";import{S as Se,U as J}from"./separator-C5h3oPTF.js";import{S as N,a as C,b as y,d as T,e as x}from"./select-BaiVbtwe.js";import{A as Ne,a as Ce,b as ye,c as Te,d as be,e as Ae,f as we,g as Ie}from"./alert-dialog-DNtspTav.js";import{f as Q,T as _e,c as De,g as Ee,S as W}from"./crmTypes-C2SECzd8.js";import{L as X}from"./loader-circle-Cs5Ipx4m.js";import{C as Fe}from"./chevron-up-DEZlDq40.js";import{C as Oe}from"./chevron-right-B8KuARlY.js";import{C as Pe}from"./circle-check-DmQSNsJk.js";import{C as ze}from"./circle-C1xyOIVH.js";import{C as Be}from"./clock-5f_CqKGa.js";import{P as Le}from"./pencil-D83oiq7I.js";import{T as Re}from"./trash-2-CFx8qGvF.js";import{o as Ve,s as A,e as Y}from"./types-C9wiu8_K.js";const Ue=Ve({title:A().trim().min(1,"Título obrigatório").max(200),deadline:A().optional(),priority:Y(["alta","media","baixa"]),status:Y(["pendente","agendado","em_andamento","em_tramite","concluida","cancelada"]),clientName:A().optional(),projectId:A().optional(),assignee:A().optional(),description:A().max(2e3).optional()}),Me=Object.entries(_e),Ke=Object.entries(De),He=Object.entries(W);function $({initial:l,onSave:v,onCancel:t,saving:S}){const[d,m]=c.useState(l??{title:"",deadline:"",status:"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(F,{placeholder:"Título da sub-tarefa *",value:d.title,onChange:n=>m(r=>({...r,title:n.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(F,{type:"date",value:d.deadline,onChange:n=>m(r=>({...r,deadline:n.target.value}))}),e.jsxs(N,{value:d.status,onValueChange:n=>m(r=>({...r,status:n})),children:[e.jsx(C,{children:e.jsx(y,{})}),e.jsx(T,{children:He.map(([n,r])=>e.jsx(x,{value:n,children:r},n))})]})]}),e.jsxs(N,{value:d.assignee||"_none_",onValueChange:n=>m(r=>({...r,assignee:n==="_none_"?"":n})),children:[e.jsx(C,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(y,{placeholder:"Responsável..."})]})}),e.jsxs(T,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),Q.map(n=>e.jsx(x,{value:n,children:n},n))]})]}),e.jsx(G,{placeholder:"Observações...",className:"resize-none min-h-[60px]",value:d.notes,onChange:n=>m(r=>({...r,notes:n.target.value}))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:t,disabled:S,children:"Cancelar"}),e.jsxs(b,{type:"button",size:"sm",disabled:!d.title.trim()||S,onClick:()=>v(d),children:[S&&e.jsx(X,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function Ye({sub:l,onEdit:v,onDelete:t,onToggleStatus:S}){const d=l.dueDate&&l.dueDate<new Date().toISOString().split("T")[0]&&l.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:S,className:"mt-0.5 shrink-0",children:l.completed?e.jsx(Pe,{className:"w-4 h-4 text-primary"}):e.jsx(ze,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:L("text-sm",l.completed&&"line-through text-muted-foreground"),children:l.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx(q,{variant:"secondary",className:L("text-[10px]",Ee[l.status]),children:W[l.status]}),l.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(J,{className:"w-3 h-3"}),l.assignee]}),l.dueDate&&e.jsxs("span",{className:L("text-[10px] flex items-center gap-0.5",d?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(Be,{className:"w-3 h-3"}),new Date(l.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),l.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:l.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:v,children:e.jsx(Le,{className:"w-3 h-3"})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:t,children:e.jsx(Re,{className:"w-3 h-3"})})]})]})}function ds({open:l,onOpenChange:v,task:t,defaultClientName:S,onSave:d,onCreateSubtask:m,onUpdateSubtask:n,onDeleteSubtask:r}){const w=!t,[O,R]=c.useState(!1),[V,D]=c.useState(!1),{clients:P}=ie(),{projects:Z}=oe(),[z,k]=c.useState(!0),[U,I]=c.useState(!1),[ee,_]=c.useState(null),[E,B]=c.useState(null),o=de({resolver:me(Ue),defaultValues:{title:"",deadline:"",priority:"media",status:"pendente",clientName:"",projectId:"",assignee:"",description:""}});c.useEffect(()=>{l&&(I(!1),_(null),t?o.reset({title:t.title,deadline:t.dueDate??"",priority:t.priority,status:t.status,clientName:t.client??"",projectId:t.projectId??"",assignee:t.assignee??"",description:t.description??""}):o.reset({title:"",deadline:"",priority:"media",status:"pendente",clientName:S??"",projectId:"",assignee:"",description:""}))},[l,t]);const se=async s=>{R(!0);try{await d(s,w,t==null?void 0:t.airtableId),v(!1)}catch(a){ce.error("Erro ao salvar tarefa: "+a.message),console.error("Erro ao salvar tarefa:",a)}finally{R(!1)}},ae=c.useCallback(async s=>{if(!(!(t!=null&&t.airtableId)||!m)){D(!0);try{await m(t.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),I(!1)}finally{D(!1)}}},[t,m]),te=c.useCallback(async(s,a)=>{if(n){D(!0);try{await n(s,{title:a.title,deadline:a.deadline||void 0,status:a.status,assignee:a.assignee||void 0,notes:a.notes||void 0}),_(null)}finally{D(!1)}}},[n]),ne=c.useCallback(async s=>{if(!n)return;const a=s.completed?"A fazer":"Concluído";await n(s.id,{status:a})},[n]),le=c.useCallback(async()=>{if(!(!E||!r))try{await r(E)}finally{B(null)}},[E,r]),h=(t==null?void 0:t.subtasks)??[],M=h.filter(s=>s.completed).length,K=h.length>0?Math.round(M/h.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(he,{open:l,onOpenChange:v,children:e.jsxs(je,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(ue,{className:"mb-6",children:[e.jsx(pe,{children:w?"Nova Tarefa":"Editar Tarefa"}),e.jsx(ge,{children:w?"Preencha os dados para criar a tarefa e sincronizar com o Airtable.":"Altere os campos e salve. A atualização será sincronizada automaticamente."})]}),e.jsx(xe,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(se),className:"space-y-5",children:[e.jsx(j,{control:o.control,name:"title",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Título *"}),e.jsx(g,{children:e.jsx(F,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(f,{})]})}),e.jsx(j,{control:o.control,name:"deadline",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Prazo"}),e.jsx(g,{children:e.jsx(F,{type:"date",...s})}),e.jsx(f,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:o.control,name:"priority",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Prioridade"}),e.jsxs(N,{onValueChange:s.onChange,value:s.value,children:[e.jsx(g,{children:e.jsx(C,{children:e.jsx(y,{})})}),e.jsx(T,{children:Ke.map(([a,i])=>e.jsx(x,{value:a,children:i},a))})]}),e.jsx(f,{})]})}),e.jsx(j,{control:o.control,name:"status",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Status"}),e.jsxs(N,{onValueChange:s.onChange,value:s.value,children:[e.jsx(g,{children:e.jsx(C,{children:e.jsx(y,{})})}),e.jsx(T,{children:Me.map(([a,i])=>e.jsx(x,{value:a,children:i},a))})]}),e.jsx(f,{})]})})]}),e.jsx(j,{control:o.control,name:"projectId",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Projeto"}),e.jsxs(N,{onValueChange:a=>s.onChange(a==="none"?"":a),value:s.value||"none",children:[e.jsx(g,{children:e.jsx(C,{children:e.jsx(y,{placeholder:"Selecione..."})})}),e.jsxs(T,{children:[e.jsx(x,{value:"none",children:"— Sem projeto —"}),Z.map(a=>e.jsx(x,{value:a.id,children:a.name},a.id))]})]}),e.jsx(f,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:o.control,name:"clientName",render:({field:s})=>{var a;return e.jsxs(u,{children:[e.jsx(p,{children:"Cliente"}),e.jsxs(N,{onValueChange:i=>{var H;return s.onChange(i==="none"?"":((H=P.find(re=>re.id===i))==null?void 0:H.name)??i)},value:((a=P.find(i=>i.name===s.value))==null?void 0:a.id)||(s.value?s.value:""),children:[e.jsx(g,{children:e.jsx(C,{children:e.jsx(y,{placeholder:"Selecione..."})})}),e.jsxs(T,{children:[e.jsx(x,{value:"none",children:"— Sem cliente —"}),P.map(i=>e.jsx(x,{value:i.id,children:i.name},i.id))]})]}),e.jsx(f,{})]})}}),e.jsx(j,{control:o.control,name:"assignee",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Responsável"}),e.jsxs(N,{onValueChange:a=>s.onChange(a==="_none_"?"":a),value:s.value||"_none_",children:[e.jsx(g,{children:e.jsx(C,{children:e.jsx(y,{placeholder:"Selecione..."})})}),e.jsxs(T,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),Q.map(a=>e.jsx(x,{value:a,children:a},a))]})]}),e.jsx(f,{})]})})]}),e.jsx(j,{control:o.control,name:"description",render:({field:s})=>e.jsxs(u,{children:[e.jsx(p,{children:"Descrição"}),e.jsx(g,{children:e.jsx(G,{placeholder:"Detalhes sobre a tarefa...",className:"resize-none min-h-[80px]",...s})}),e.jsx(f,{})]})}),e.jsxs(fe,{className:"pt-2 gap-2",children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:O,children:"Cancelar"}),e.jsxs(b,{type:"submit",disabled:O,children:[O&&e.jsx(X,{className:"w-4 h-4 mr-2 animate-spin"}),w?"Criar tarefa":"Salvar alterações"]})]})]})}),!w&&t&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>k(!z),children:[z?e.jsx(Fe,{className:"w-4 h-4"}):e.jsx(Oe,{className:"w-4 h-4"}),"Sub-tarefas",h.length>0&&e.jsxs(q,{variant:"secondary",className:"text-[10px] ml-1",children:[M,"/",h.length]})]}),e.jsxs(b,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{I(!0),_(null)},children:[e.jsx(ve,{className:"w-3.5 h-3.5"})," Nova"]})]}),h.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${K}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[K,"%"]})]}),z&&e.jsxs("div",{className:"space-y-1",children:[h.map(s=>ee===s.id?e.jsx($,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:a=>te(s.id,a),onCancel:()=>_(null),saving:V},s.id):e.jsx(Ye,{sub:s,onEdit:()=>{_(s.id),I(!1)},onDelete:()=>B(s.id),onToggleStatus:()=>ne(s)},s.id)),h.length===0&&!U&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),U&&e.jsx($,{onSave:ae,onCancel:()=>I(!1),saving:V})]})]})]})]})}),e.jsx(Ne,{open:!!E,onOpenChange:s=>!s&&B(null),children:e.jsxs(Ce,{children:[e.jsxs(ye,{children:[e.jsx(Te,{children:"Excluir sub-tarefa?"}),e.jsx(be,{children:"Esta ação removerá a sub-tarefa do Airtable e não pode ser desfeita."})]}),e.jsxs(Ae,{children:[e.jsx(we,{children:"Cancelar"}),e.jsx(Ie,{onClick:le,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{ds as T};
