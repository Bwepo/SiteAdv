import{$ as we,r as t,j as e,m as Se,s as Ae,h as p}from"./index-BQQTb6fi.js";import{u as ke}from"./useQuery-CnOz2Hdf.js";import{P as Te,B as De}from"./badge-AZvcS7pt.js";import{B as v}from"./button-BYLOxE-2.js";import{I as N}from"./input-CE2c-gnk.js";import{L as n}from"./label-ULu1cug-.js";import{c as Pe,E as Ee,A as _e}from"./formatters-Bj0D2YiU.js";import{S as Ie}from"./skeleton-C2gBzZvw.js";import{D as Oe,a as Le,c as Fe,d as qe,f as Be}from"./dialog-BFbvaQ4H.js";import{A as Me,a as Ve,b as Re,c as $e,d as Qe,e as ze,f as He,g as Ke}from"./alert-dialog-ChmPdjXe.js";import{T as Ue,a as Je,b as le,c as d,d as Ye,e as m}from"./table-BN6ACmsl.js";import{S as B,a as M,b as V,c as R,d as b}from"./select-DQAAOv5a.js";import{C as Ge}from"./ClientSelect-lI4Gz5nG.js";import{f as We,a as Xe,P as oe}from"./crmTypes-CAMEoS1a.js";import{S as ie}from"./scale-IyStsT_j.js";import{S as Ze}from"./search-CUmnT7KL.js";import{F as ce}from"./filter-XozgcQzK.js";import{C as es}from"./clipboard-list-PlZO_TCQ.js";import{P as ss}from"./pencil-CSW1l7Ok.js";import{T as as}from"./trash-2-BJDwYsZn.js";import{L as ts}from"./loader-circle-xgMqgjFX.js";import{A as rs}from"./arrow-up-down-ClRUrno1.js";import"./download-rvRVf5jd.js";import"./file-text-LQDXvIUg.js";import"./tabs-BCef0ozh.js";import"./index-Q1Bk4gfk.js";import"./index-7lbmCfx5.js";import"./TipTapEditor-CIWz2ATn.js";import"./index-Bu4-nO3Z.js";import"./dropdown-menu-Dd49uv-w.js";import"./index-DPfA20xD.js";import"./chevron-right-CI2J5RP5.js";import"./check-DkMO6O-V.js";import"./link-B45bLZfa.js";import"./list-CanTGTbl.js";import"./quote-CnlEkBNF.js";import"./textarea-DR-tS-F2.js";import"./index-DejfxgUV.js";import"./index-h0b3EOcB.js";import"./chevron-up-B-WZdaNo.js";import"./popover-BKmSsf8O.js";const k=l=>Ae.from(l);function ls(l){return{id:l.id,clienteAirtableId:l.cliente_airtable_id||"",numero:l.numero||"",titulo:l.titulo||void 0,vara:l.vara||void 0,comarca:l.comarca||void 0,status:l.status||"Ativo",observacoes:l.observacoes||void 0,createdAt:l.created_at||"",updatedAt:l.updated_at||""}}const ne=["crm","processos-page"];function Us(){const l=we(),{clients:C}=We(),{tasks:$}=Xe(),{data:i=[],isLoading:de}=ke({queryKey:ne,queryFn:async()=>{const{data:s,error:a}=await k("mladv_crm_processos").select("*").order("created_at",{ascending:!1});if(a)throw a;return(s||[]).map(ls)}}),Q=t.useCallback(()=>{l.invalidateQueries({queryKey:ne}),l.invalidateQueries({queryKey:["crm-processos"]})},[l]),[g,me]=t.useState(""),[c,z]=t.useState("all"),[u,ue]=t.useState("all"),[y,xe]=t.useState("created_at"),[H,K]=t.useState("desc"),[he,j]=t.useState(!1),[x,U]=t.useState(null),[J,Y]=t.useState(!1),[T,D]=t.useState(null),[w,P]=t.useState(""),[G,E]=t.useState(""),[W,_]=t.useState(""),[X,I]=t.useState(""),[Z,O]=t.useState("Ativo"),[ee,L]=t.useState(""),[pe,F]=t.useState(""),[ge,q]=t.useState(""),S=t.useMemo(()=>{const s=new Map;return i.forEach(a=>{const r=$.filter(o=>o.numeroProcesso===a.numero).length;s.set(a.id,r)}),s},[i,$]),h=t.useMemo(()=>{const s=new Map;return C.forEach(a=>s.set(a.id,a.name)),s},[C]),je=s=>{y===s?K(a=>a==="asc"?"desc":"asc"):(xe(s),K("asc"))},A=t.useMemo(()=>{let s=i;if(g.trim()){const a=g.toLowerCase();s=s.filter(r=>{var o,ae,te,re;return r.numero.toLowerCase().includes(a)||((o=r.titulo)==null?void 0:o.toLowerCase().includes(a))||((ae=r.vara)==null?void 0:ae.toLowerCase().includes(a))||((te=r.comarca)==null?void 0:te.toLowerCase().includes(a))||((re=h.get(r.clienteAirtableId))==null?void 0:re.toLowerCase().includes(a))})}return c!=="all"&&(s=s.filter(a=>a.status===c)),u!=="all"&&(s=s.filter(a=>a.clienteAirtableId===u)),[...s].sort((a,r)=>{let o=0;switch(y){case"numero":o=a.numero.localeCompare(r.numero);break;case"titulo":o=(a.titulo||"").localeCompare(r.titulo||"");break;case"status":o=a.status.localeCompare(r.status);break;case"cliente":o=(h.get(a.clienteAirtableId)||"").localeCompare(h.get(r.clienteAirtableId)||"");break;case"tarefas":o=(S.get(a.id)??0)-(S.get(r.id)??0);break;case"created_at":o=(a.createdAt||"").localeCompare(r.createdAt||"");break}return H==="asc"?o:-o})},[i,g,c,u,y,H,h,S]),fe=t.useMemo(()=>{const s=new Set(i.map(a=>a.status));return Array.from(s).sort()},[i]),ve=t.useMemo(()=>{const s=new Set(i.map(a=>a.clienteAirtableId).filter(Boolean));return C.filter(a=>s.has(a.id))},[i,C]),Ne=()=>{U(null),P(""),E(""),_(""),I(""),O("Ativo"),L(""),F(""),q(""),j(!0)},se=s=>{U(s),P(s.numero),E(s.titulo||""),_(s.vara||""),I(s.comarca||""),O(s.status),L(s.observacoes||""),F(s.clienteAirtableId),q(h.get(s.clienteAirtableId)||""),j(!0)},be=async()=>{if(!w.trim()){p.error("Número do processo é obrigatório");return}Y(!0);try{const s={numero:w.trim(),titulo:G.trim()||null,vara:W.trim()||null,comarca:X.trim()||null,status:Z,observacoes:ee.trim()||null,cliente_airtable_id:pe||null};if(x){const{error:a}=await k("mladv_crm_processos").update(s).eq("id",x.id);if(a)throw a;p.success("Processo atualizado!")}else{const{error:a}=await k("mladv_crm_processos").insert(s);if(a)throw a;p.success("Processo criado!")}Q(),j(!1)}catch(s){p.error("Erro: "+s.message)}finally{Y(!1)}},Ce=async()=>{if(T)try{const{error:s}=await k("mladv_crm_processos").delete().eq("id",T);if(s)throw s;p.success("Processo removido"),Q()}catch(s){p.error("Erro: "+s.message)}finally{D(null)}},ye=s=>{switch(s){case"Ativo":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";case"Arquivado":return"bg-gray-100 text-gray-800 dark:bg-gray-800/30 dark:text-gray-400";case"Encerrado":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400";case"Suspenso":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400";default:return"bg-muted text-muted-foreground"}},f=({field:s,label:a})=>e.jsxs("button",{onClick:()=>je(s),className:"flex items-center gap-1 hover:text-foreground transition-colors",children:[a,e.jsx(rs,{className:`h-3 w-3 ${y===s?"text-primary":"text-muted-foreground/50"}`})]});return de?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(Ie,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(Se.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{className:"h-7 w-7 text-primary"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.length," processo",i.length!==1?"s":""," cadastrado",i.length!==1?"s":"",c!=="all"||u!=="all"?` • ${A.length} exibido${A.length!==1?"s":""}`:""]})]})]}),e.jsxs(v,{onClick:Ne,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx(Te,{className:"mr-2 h-4 w-4"})," Novo Processo"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(Ze,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(N,{value:g,onChange:s=>me(s.target.value),placeholder:"Buscar nº processo, título, vara, comarca, cliente...",className:"pl-9 min-w-[220px]"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{value:c,onValueChange:z,children:[e.jsxs(M,{className:"w-[140px]",children:[e.jsx(ce,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(V,{placeholder:"Status"})]}),e.jsxs(R,{children:[e.jsx(b,{value:"all",children:"Todos Status"}),fe.map(s=>e.jsx(b,{value:s,children:s},s))]})]}),e.jsxs(B,{value:u,onValueChange:ue,children:[e.jsxs(M,{className:"w-[160px]",children:[e.jsx(ce,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(V,{placeholder:"Cliente"})]}),e.jsxs(R,{children:[e.jsx(b,{value:"all",children:"Todos Clientes"}),ve.map(s=>e.jsx(b,{value:s.id,children:s.name},s.id))]})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:oe.map(s=>{const a=i.filter(r=>r.status===s).length;return e.jsxs("button",{onClick:()=>z(c===s?"all":s),className:`rounded-lg border p-3 text-left transition-all hover:shadow-sm ${c===s?"ring-2 ring-primary border-primary":"border-border"}`,children:[e.jsx("p",{className:"text-2xl font-bold",children:a}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s,a!==1?"s":""]})]},s)})}),A.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ie,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum processo encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:g||c!=="all"||u!=="all"?"Tente ajustar os filtros.":"Adicione seu primeiro processo."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card overflow-x-auto",children:e.jsxs(Ue,{children:[e.jsx(Je,{children:e.jsxs(le,{children:[e.jsx(d,{children:e.jsx(f,{field:"numero",label:"Nº Processo"})}),e.jsx(d,{className:"hidden md:table-cell",children:e.jsx(f,{field:"titulo",label:"Título"})}),e.jsx(d,{className:"hidden sm:table-cell",children:e.jsx(f,{field:"cliente",label:"Cliente"})}),e.jsx(d,{className:"w-[100px]",children:e.jsx(f,{field:"status",label:"Status"})}),e.jsx(d,{className:"hidden lg:table-cell",children:"Vara / Comarca"}),e.jsx(d,{className:"hidden sm:table-cell w-[80px] text-center",children:e.jsx(f,{field:"tarefas",label:"Tarefas"})}),e.jsx(d,{className:"w-[90px] text-right",children:"Ações"})]})}),e.jsx(Ye,{children:A.map(s=>{const a=h.get(s.clienteAirtableId),r=S.get(s.id)??0;return e.jsxs(le,{className:"cursor-pointer",onClick:()=>se(s),children:[e.jsx(m,{children:e.jsx("span",{className:"font-mono text-sm font-medium",children:s.numero})}),e.jsx(m,{className:"hidden md:table-cell",children:e.jsx("span",{className:"text-sm truncate max-w-[200px] block",children:s.titulo||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{className:"hidden sm:table-cell",children:e.jsx("span",{className:"text-sm",children:a||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{children:e.jsx(De,{variant:"secondary",className:ye(s.status),children:s.status})}),e.jsx(m,{className:"hidden lg:table-cell",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:[s.vara,s.comarca].filter(Boolean).join(" • ")||"—"})}),e.jsx(m,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-muted-foreground",children:[e.jsx(es,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:r})]})}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",onClick:o=>o.stopPropagation(),children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>se(s),title:"Editar",children:e.jsx(ss,{className:"h-3.5 w-3.5"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>D(s.id),title:"Excluir",children:e.jsx(as,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(Oe,{open:he,onOpenChange:j,children:e.jsxs(Le,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(Fe,{children:e.jsx(qe,{children:x?"Editar Processo":"Novo Processo"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Número do Processo *"}),e.jsx(N,{value:w,onChange:s=>P(Pe(s.target.value)),placeholder:"NNNNNNN-DD.AAAA.J.TR.OOOO",maxLength:25,autoFocus:!0}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Formato CNJ: 20 dígitos com máscara automática"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Título / Descrição breve"}),e.jsx(N,{value:G,onChange:s=>E(s.target.value),placeholder:"Ex: Ação de Indenização por Danos Morais"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Cliente vinculado"}),e.jsx(Ge,{value:ge,onValueChange:(s,a)=>{q(s),F(a)}})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Vara"}),e.jsx(N,{value:W,onChange:s=>_(s.target.value),placeholder:"Ex: 3ª Vara Cível"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Comarca"}),e.jsx(N,{value:X,onChange:s=>I(s.target.value),placeholder:"Ex: São Paulo/SP"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Status"}),e.jsxs(B,{value:Z,onValueChange:O,children:[e.jsx(M,{children:e.jsx(V,{})}),e.jsx(R,{children:oe.map(s=>e.jsx(b,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Observações"}),e.jsx(Ee,{value:ee,onChange:L,placeholder:"Notas internas sobre o processo, decisões relevantes, próximos passos...",modalTitle:"Editar Observações do Processo"})]}),x&&e.jsx(_e,{folder:`processos/${x.id}`})]}),e.jsxs(Be,{children:[e.jsx(v,{variant:"outline",onClick:()=>j(!1),children:"Cancelar"}),e.jsxs(v,{onClick:be,disabled:!w.trim()||J,children:[J&&e.jsx(ts,{className:"h-4 w-4 animate-spin mr-2"}),x?"Salvar":"Criar Processo"]})]})]})}),e.jsx(Me,{open:!!T,onOpenChange:s=>!s&&D(null),children:e.jsxs(Ve,{children:[e.jsxs(Re,{children:[e.jsx($e,{children:"Excluir processo?"}),e.jsx(Qe,{children:"Esta ação é permanente e não pode ser desfeita. Tarefas vinculadas a este processo não serão removidas."})]}),e.jsxs(ze,{children:[e.jsx(He,{children:"Cancelar"}),e.jsx(Ke,{onClick:Ce,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{Us as default};
