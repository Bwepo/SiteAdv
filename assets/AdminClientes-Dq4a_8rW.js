import{$ as re,r,j as e,m as le,s as k,h as v}from"./index-BQQTb6fi.js";import{f as oe,b as ie,a as ne}from"./crmTypes-CAMEoS1a.js";import{B as ce,P as me}from"./badge-AZvcS7pt.js";import{B as N}from"./button-BYLOxE-2.js";import{I as C}from"./input-CE2c-gnk.js";import{L as x}from"./label-ULu1cug-.js";import{T as de}from"./textarea-DR-tS-F2.js";import{S as xe}from"./skeleton-C2gBzZvw.js";import{D as pe,a as he,c as ue,d as je,f as fe}from"./dialog-BFbvaQ4H.js";import{A as ge,a as ve,b as Ne,c as Ce,d as be,e as we,f as ye,g as Se}from"./alert-dialog-ChmPdjXe.js";import{T as De,a as Ae,b as V,c as w,d as Te,e as y}from"./table-BN6ACmsl.js";import{S as Le,a as Ee,b as Fe,c as Pe,d as G}from"./select-DQAAOv5a.js";import{f as ke,a as _e,b as Be,A as Ie}from"./formatters-Bj0D2YiU.js";import{P as qe}from"./ProcessosList-CljVwuyv.js";import{S as Oe}from"./search-CUmnT7KL.js";import{U as ze}from"./users-Dr_w_yN6.js";import{F as He}from"./folder-kanban-CPklJxXh.js";import{C as Re}from"./clipboard-list-PlZO_TCQ.js";import{P as Ue}from"./pencil-CSW1l7Ok.js";import{T as $e}from"./trash-2-BJDwYsZn.js";import{L as Je}from"./loader-circle-xgMqgjFX.js";import{A as Ke}from"./arrow-up-down-ClRUrno1.js";import"./useQuery-CnOz2Hdf.js";import"./index-DejfxgUV.js";import"./index-DPfA20xD.js";import"./index-7lbmCfx5.js";import"./index-h0b3EOcB.js";import"./chevron-up-B-WZdaNo.js";import"./check-DkMO6O-V.js";import"./download-rvRVf5jd.js";import"./file-text-LQDXvIUg.js";import"./tabs-BCef0ozh.js";import"./index-Q1Bk4gfk.js";import"./TipTapEditor-CIWz2ATn.js";import"./index-Bu4-nO3Z.js";import"./dropdown-menu-Dd49uv-w.js";import"./chevron-right-CI2J5RP5.js";import"./link-B45bLZfa.js";import"./list-CanTGTbl.js";import"./quote-CnlEkBNF.js";import"./scale-IyStsT_j.js";function ks(){const{clients:p,loading:W}=oe(),{projects:_}=ie(),{tasks:B}=ne(),I=re(),[h,X]=r.useState(""),[Y,u]=r.useState(!1),[o,q]=r.useState(null),[O,z]=r.useState(!1),[S,D]=r.useState(null),[j,A]=r.useState(""),[H,T]=r.useState(""),[R,L]=r.useState(""),[U,E]=r.useState(""),[$,b]=r.useState(""),[m,F]=r.useState("cpf"),[f,Z]=r.useState("name"),[J,K]=r.useState("asc"),ee=s=>{f===s?K(t=>t==="asc"?"desc":"asc"):(Z(s),K("asc"))},d=r.useMemo(()=>{const s=new Map;return p.forEach(t=>{const a=t.name.toLowerCase(),l=_.filter(i=>{var n,g;return((n=i.cliente)==null?void 0:n.toLowerCase())===a||((g=i.name)==null?void 0:g.toLowerCase())===a}).length,c=B.filter(i=>{var n;return((n=i.client)==null?void 0:n.toLowerCase())===a||i.client===t.id}).length;s.set(t.id,{projetos:l,tarefas:c})}),s},[p,_,B]),M=r.useMemo(()=>{let s=p;if(h.trim()){const t=h.toLowerCase();s=s.filter(a=>{var l,c;return a.name.toLowerCase().includes(t)||((l=a.email)==null?void 0:l.toLowerCase().includes(t))||((c=a.documento)==null?void 0:c.includes(t))})}return[...s].sort((t,a)=>{var c,i,n,g;let l=0;return f==="name"?l=t.name.localeCompare(a.name,"pt-BR"):f==="projetos"?l=(((c=d.get(t.id))==null?void 0:c.projetos)??0)-(((i=d.get(a.id))==null?void 0:i.projetos)??0):l=(((n=d.get(t.id))==null?void 0:n.tarefas)??0)-(((g=d.get(a.id))==null?void 0:g.tarefas)??0),J==="asc"?l:-l})},[p,h,f,J,d]),se=()=>{q(null),A(""),T(""),L(""),E(""),b(""),F("cpf"),u(!0)},Q=s=>{q(s),A(s.name),T(s.email||""),L(s.telefone||""),E(s.endereco||""),b(s.documento||""),F(s.tipoDocumento||"cpf"),u(!0)},te=async()=>{if(j.trim()){z(!0);try{const s=j.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),t={nome:j.trim(),slug:s,email:H.trim()||null,telefone:R.trim()||null,endereco:U.trim()||null,documento:$.trim()||null,tipo_documento:m};if(o){const{error:a}=await k.from("mladv_crm_clientes").update(t).eq("airtable_id",o.id);if(a)throw a;v.success("Cliente atualizado!")}else{const a=`local_${Date.now()}`,{error:l}=await k.from("mladv_crm_clientes").insert({...t,airtable_id:a});if(l)throw l;v.success("Cliente adicionado!")}I.invalidateQueries({queryKey:["crm","clientes"]}),u(!1)}catch(s){v.error("Erro: "+s.message)}finally{z(!1)}}},ae=async()=>{if(S)try{const{error:s}=await k.from("mladv_crm_clientes").delete().eq("airtable_id",S);if(s)throw s;v.success("Cliente removido"),I.invalidateQueries({queryKey:["crm","clientes"]})}catch(s){v.error("Erro ao remover: "+s.message)}finally{D(null)}},P=({field:s,label:t})=>e.jsxs("button",{onClick:()=>ee(s),className:"flex items-center gap-1 hover:text-foreground transition-colors",children:[t,e.jsx(Ke,{className:`h-3 w-3 ${f===s?"text-primary":"text-muted-foreground/50"}`})]});return W?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(xe,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(le.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsxs(ce,{variant:"secondary",className:"text-xs",children:[p.length," clientes"]})]}),e.jsxs(N,{onClick:se,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx(me,{className:"mr-2 h-4 w-4"})," Novo Cliente"]})]}),e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(Oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(C,{value:h,onChange:s=>X(s.target.value),placeholder:"Buscar cliente, e-mail ou documento...",className:"pl-9 min-w-[220px]"})]}),M.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum cliente encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:h?"Tente outro termo de busca.":"Adicione seu primeiro cliente."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card",children:e.jsxs(De,{children:[e.jsx(Ae,{children:e.jsxs(V,{children:[e.jsx(w,{children:e.jsx(P,{field:"name",label:"Nome"})}),e.jsx(w,{className:"hidden sm:table-cell w-[120px] text-center",children:e.jsx(P,{field:"projetos",label:"Projetos"})}),e.jsx(w,{className:"hidden sm:table-cell w-[120px] text-center",children:e.jsx(P,{field:"tarefas",label:"Tarefas"})}),e.jsx(w,{className:"w-[100px] text-right",children:"Ações"})]})}),e.jsx(Te,{children:M.map(s=>{const t=d.get(s.id);return e.jsxs(V,{className:"cursor-pointer",onClick:()=>Q(s),children:[e.jsx(y,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.name}),s.email&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:s.email})]})}),e.jsx(y,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx(He,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(t==null?void 0:t.projetos)??0})]})}),e.jsx(y,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx(Re,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(t==null?void 0:t.tarefas)??0})]})}),e.jsx(y,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",onClick:a=>a.stopPropagation(),children:[e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>Q(s),title:"Editar",children:e.jsx(Ue,{className:"h-3.5 w-3.5"})}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>D(s.id),title:"Excluir",children:e.jsx($e,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(pe,{open:Y,onOpenChange:u,children:e.jsxs(he,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsx(je,{children:o?"Editar Cliente":"Novo Cliente"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client-name",children:"Nome *"}),e.jsx(C,{id:"client-name",value:j,onChange:s=>A(s.target.value),placeholder:"Nome do cliente",autoFocus:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client-email",children:"E-mail"}),e.jsx(C,{id:"client-email",type:"email",value:H,onChange:s=>T(s.target.value),placeholder:"email@exemplo.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client-phone",children:"Telefone"}),e.jsx(C,{id:"client-phone",value:R,onChange:s=>L(ke(s.target.value)),placeholder:"(00) 00000-0000",maxLength:16})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[140px_1fr] gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Tipo"}),e.jsxs(Le,{value:m,onValueChange:s=>{F(s),b("")},children:[e.jsx(Ee,{children:e.jsx(Fe,{})}),e.jsxs(Pe,{children:[e.jsx(G,{value:"cpf",children:"CPF"}),e.jsx(G,{value:"cnpj",children:"CNPJ"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client-doc",children:m==="cpf"?"CPF":"CNPJ"}),e.jsx(C,{id:"client-doc",value:$,onChange:s=>b(m==="cpf"?_e(s.target.value):Be(s.target.value)),placeholder:m==="cpf"?"000.000.000-00":"00.000.000/0000-00",maxLength:m==="cpf"?14:18})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client-address",children:"Endereço"}),e.jsx(de,{id:"client-address",value:U,onChange:s=>E(s.target.value),placeholder:"Rua, número, bairro, cidade - UF",rows:2})]}),o&&e.jsx(qe,{clienteAirtableId:o.id}),o&&e.jsx(Ie,{folder:`clientes/${o.id}`})]}),e.jsxs(fe,{children:[e.jsx(N,{variant:"outline",onClick:()=>u(!1),children:"Cancelar"}),e.jsxs(N,{onClick:te,disabled:!j.trim()||O,children:[O&&e.jsx(Je,{className:"h-4 w-4 animate-spin mr-2"}),o?"Salvar":"Adicionar"]})]})]})}),e.jsx(ge,{open:!!S,onOpenChange:s=>!s&&D(null),children:e.jsxs(ve,{children:[e.jsxs(Ne,{children:[e.jsx(Ce,{children:"Excluir cliente?"}),e.jsx(be,{children:"Esta ação não pode ser desfeita. O cliente será removido permanentemente."})]}),e.jsxs(we,{children:[e.jsx(ye,{children:"Cancelar"}),e.jsx(Se,{onClick:ae,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{ks as default};
