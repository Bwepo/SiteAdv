import{u as d}from"./useQuery-Bx5HeV_0.js";import{$ as c,s as o}from"./index-Bl_6Uoau.js";import{u}from"./useMutation-6vvXitli.js";function b(){const t=c();return u({mutationFn:async e=>{var n,l,a;const r=e.email.trim().toLowerCase(),s=((n=e.source)==null?void 0:n.trim())||"website",{error:i}=await o.from("mladv_newsletter_subscribers").upsert({email:r,name:((l=e.name)==null?void 0:l.trim())||null,source:s,confirmed:!0,unsubscribed_at:null},{onConflict:"email"});if(i)throw i;return{email:r,name:((a=e.name)==null?void 0:a.trim())||null,source:s}},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function g(){const t=c();return u({mutationFn:async e=>{var l;const r=e.email.trim().toLowerCase(),s=((l=e.name)==null?void 0:l.trim())||null,{data:i,error:n}=await o.from("mladv_newsletter_subscribers").upsert({email:r,name:s,source:"admin",confirmed:!0,unsubscribed_at:null},{onConflict:"email"}).select("*").single();if(n)throw n;return i},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function p(){return d({queryKey:["newsletter-subscribers"],queryFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_subscribers").select("*").order("subscribed_at",{ascending:!1});if(e)throw e;return t||[]}})}function v(){return d({queryKey:["newsletter-stats"],queryFn:async()=>{const{data:t,error:e,count:r}=await o.from("mladv_newsletter_subscribers").select("*",{count:"exact"}).is("unsubscribed_at",null);if(e)throw e;const s=new Date;s.setDate(s.getDate()-7);const i=(t||[]).filter(n=>new Date(n.subscribed_at)>=s).length;return{total:r||0,active:r||0,newThisWeek:i}}})}function q(){const t=c();return u({mutationFn:async e=>{const{error:r}=await o.from("mladv_newsletter_subscribers").delete().eq("id",e);if(r)throw r},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function h(){return u({mutationFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_subscribers").select("email, name, subscribed_at").is("unsubscribed_at",null).order("subscribed_at",{ascending:!1});if(e)throw e;const r=["Email","Nome","Data de Inscrição"],s=(t||[]).map(a=>[a.email,a.name||"",new Date(a.subscribed_at).toLocaleDateString("pt-BR")]),i=[r.join(","),...s.map(a=>a.map(m=>`"${m}"`).join(","))].join(`
`),n=new Blob([i],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");return l.href=URL.createObjectURL(n),l.download=`newsletter-subscribers-${new Date().toISOString().split("T")[0]}.csv`,l.click(),i}})}function S(){return d({queryKey:["newsletter-campaigns"],queryFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_campaigns").select("id, subject, status, created_at, sent_at, post_id, mladv_posts(title, slug)").order("created_at",{ascending:!1});if(e)throw e;return t||[]}})}function C(t){return d({queryKey:["newsletter-campaign",t],enabled:!!t,queryFn:async()=>{const{data:e,error:r}=await o.from("mladv_newsletter_campaigns").select("*, mladv_posts(title, slug)").eq("id",t).single();if(r)throw r;const{data:s,error:i}=await o.from("mladv_newsletter_deliveries").select("status").eq("campaign_id",t);if(i)throw i;const n={queued:0,sent:0,failed:0,skipped:0};(s||[]).forEach(a=>{a.status==="queued"?n.queued++:a.status==="sent"?n.sent++:a.status==="failed"?n.failed++:a.status==="skipped"&&n.skipped++});const l=n.queued+n.sent+n.failed+n.skipped;return{campaign:e,deliveryCounts:n,total:l}},refetchInterval:e=>{var s,i;const r=(i=(s=e.state.data)==null?void 0:s.campaign)==null?void 0:i.status;return r&&["sending","queued"].includes(r)?3e3:!1}})}function K(){return d({queryKey:["newsletter-send-limits"],queryFn:async()=>{const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),t.getDate()).toISOString(),r=new Date(t.getFullYear(),t.getMonth(),1).toISOString(),{data:s}=await o.from("mladv_newsletter_settings").select("daily_send_limit, monthly_send_limit").eq("id",1).maybeSingle(),{count:i,error:n}=await o.from("mladv_newsletter_deliveries").select("*",{count:"exact",head:!0}).eq("status","sent").gte("sent_at",e);if(n)throw n;const{count:l,error:a}=await o.from("mladv_newsletter_deliveries").select("*",{count:"exact",head:!0}).eq("status","sent").gte("sent_at",r);if(a)throw a;return{daily:i||0,dailyLimit:(s==null?void 0:s.daily_send_limit)||100,monthly:l||0,monthlyLimit:(s==null?void 0:s.monthly_send_limit)||3e3}},refetchInterval:3e4})}function D(){const t=c();return u({mutationFn:async e=>{const r=e.post_id&&e.post_id.length>0;if(r){const{data:a}=await o.from("mladv_newsletter_campaigns").select("id").eq("post_id",e.post_id).in("status",["draft","queued","sending"]).maybeSingle();if(a)return console.log("[newsletter] Campaign already exists for post, skipping creation"),a}const{data:s,error:i}=await o.from("mladv_newsletter_campaigns").insert({subject:e.subject,html:e.html,post_id:r?e.post_id:null,status:"queued"}).select("id").single();if(i)throw i;const{data:n,error:l}=await o.from("mladv_newsletter_subscribers").select("id, email").eq("confirmed",!0).is("unsubscribed_at",null);if(l)throw l;if(n&&n.length>0){const a=n.map(w=>({campaign_id:s.id,subscriber_id:w.id,email:w.email,status:"queued"})),{error:m}=await o.from("mladv_newsletter_deliveries").insert(a);if(m)throw m;console.log(`[newsletter] Created campaign ${s.id} with ${a.length} deliveries`)}else console.warn("[newsletter] No active subscribers found");return s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]})}})}function F(){const t=c();return u({mutationFn:async e=>{const{data:r,error:s}=await o.functions.invoke("send-newsletter-campaign",{body:{campaign_id:e}});if(s)throw s;return r},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]}),t.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function Q(){const t=c();return u({mutationFn:async e=>{const{error:r}=await o.from("mladv_newsletter_campaigns").delete().eq("id",e);if(r)throw r},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]}),t.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function E(){return d({queryKey:["newsletter-settings"],queryFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_settings").select("*").eq("id",1).maybeSingle();if(e)throw e;return t}})}function N(){const t=c();return u({mutationFn:async e=>{const{data:r,error:s}=await o.from("mladv_newsletter_settings").update({...e,updated_at:new Date().toISOString()}).eq("id",1).select().single();if(s)throw s;return r},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-settings"]})}})}export{v as a,p as b,g as c,q as d,h as e,D as f,C as g,K as h,S as i,F as j,Q as k,E as l,N as m,b as u};
