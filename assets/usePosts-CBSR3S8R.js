import{u as y}from"./useQuery-29HJf1SZ.js";import{s as o,$ as _}from"./index-dQ6KxDTD.js";import{u as v}from"./useMutation-DJP8wMme.js";async function Q(e){if(e.length===0)return new Map;const{data:t,error:a}=await o.from("mladv_post_categories").select("post_id, category_id").in("post_id",e);if(a||!t)return new Map;const s=[...new Set(t.map(c=>c.category_id))];if(s.length===0)return new Map;const{data:r,error:n}=await o.from("mladv_categories").select("*").in("id",s);if(n||!r)return new Map;const l=new Map(r.map(c=>[c.id,c])),i=new Map;return e.forEach(c=>{const g=t.filter(d=>d.post_id===c).map(d=>l.get(d.category_id)).filter(d=>d!==void 0);i.set(c,g)}),i}function x(e={}){const{published:t,page:a=1,pageSize:s=10,search:r,categorySlug:n,tag:l}=e;return y({queryKey:["posts",{published:t,page:a,pageSize:s,search:r,categorySlug:n,tag:l}],queryFn:async()=>{if(n){const{data:p}=await o.from("mladv_categories").select("id").eq("slug",n).maybeSingle();if(!p)return{posts:[],total:0,totalPages:0};const{data:f}=await o.from("mladv_post_categories").select("post_id").eq("category_id",p.id),w=(f==null?void 0:f.map(m=>m.post_id))||[];if(w.length===0)return{posts:[],total:0,totalPages:0};let u=o.from("mladv_posts").select("*",{count:"exact"}).in("id",w);t!==void 0&&(u=u.eq("published",t)),r&&(u=u.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),l&&(u=u.contains("tags",[l])),u=u.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((a-1)*s,a*s-1);const{data:S,error:h,count:b}=await u;if(h)throw h;const K=S||[],M=await Q(K.map(m=>m.id));return{posts:K.map(m=>({...m,categories:M.get(m.id)||[]})),total:b??0,totalPages:Math.ceil((b??0)/s)}}let i=o.from("mladv_posts").select("*",{count:"exact"});t!==void 0&&(i=i.eq("published",t)),r&&(i=i.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),l&&(i=i.contains("tags",[l])),i=i.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((a-1)*s,a*s-1);const{data:c,error:g,count:d}=await i;if(g)throw g;const q=c||[],P=await Q(q.map(p=>p.id));return{posts:q.map(p=>({...p,categories:P.get(p.id)||[]})),total:d??0,totalPages:Math.ceil((d??0)/s)}}})}function W(e){return y({queryKey:["post",e],queryFn:async()=>{const{data:t,error:a}=await o.from("mladv_posts").select("*").eq("slug",e).eq("published",!0).maybeSingle();if(a)throw a;return t},enabled:!!e})}function D(e){return y({queryKey:["post-by-id",e],queryFn:async()=>{const{data:t,error:a}=await o.from("mladv_posts").select("*").eq("id",e).maybeSingle();if(a)throw a;return t},enabled:!!e})}function R(){return y({queryKey:["all-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function z(){const e=_();return v({mutationFn:async t=>{const{data:a,error:s}=await o.from("mladv_posts").insert(t).select().single();if(s)throw s;return a},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]})}})}function A(){const e=_();return v({mutationFn:async({id:t,...a})=>{const{data:s,error:r}=await o.from("mladv_posts").update({...a,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(r)throw r;return s},onSuccess:t=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post",t.slug]}),e.invalidateQueries({queryKey:["post-by-id",t.id]})}})}function B(){const e=_();return v({mutationFn:async t=>{(await Promise.all([{table:"mladv_post_categories",result:o.from("mladv_post_categories").delete().eq("post_id",t)},{table:"mladv_newsletter_campaigns",result:o.from("mladv_newsletter_campaigns").update({post_id:null}).eq("post_id",t)},{table:"mladv_post_views",result:o.from("mladv_post_views").delete().eq("post_id",t)},{table:"mladv_post_likes",result:o.from("mladv_post_likes").delete().eq("post_id",t)},{table:"mladv_post_comments",result:o.from("mladv_post_comments").delete().eq("post_id",t)}])).forEach(({table:r,result:n})=>{var l;if(n.error){const i=typeof((l=n.error)==null?void 0:l.message)=="string"?n.error.message:String(n.error);throw new Error(`Erro ao limpar ${r}: ${i}`)}});const{error:s}=await o.from("mladv_posts").delete().eq("id",t);if(s){const r=typeof(s==null?void 0:s.message)=="string"?s.message:String(s);throw new Error(`Erro ao excluir post: ${r}`)}},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post-views"]}),e.invalidateQueries({queryKey:["post-likes"]}),e.invalidateQueries({queryKey:["post-comments"]}),e.invalidateQueries({queryKey:["all-comments"]})}})}export{W as a,R as b,A as c,B as d,z as e,D as f,x as u};
