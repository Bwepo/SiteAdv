import{r as d,j as e,e as V,h as oe}from"./index-DixcKx3f.js";import{u as ie,F as ce,a as j,b as p,c as g,d as N,e as v,t as de}from"./form-DJi3DG1h.js";import{E as $,A as me}from"./formatters-uDq9-6EO.js";import{D as xe}from"./DatePickerInput-CXgRWxwT.js";import{u as q}from"./useCrmFieldOptions-CIW6wzYt.js";import{S as ue,b as he,c as je,d as pe,e as ge,f as fe}from"./sheet-BjCYXMp8.js";import{I as F}from"./input-S4SE4ieG.js";import{B as b}from"./button-UQeTJvbR.js";import{B as J,P as ve}from"./badge-CmeA_QT4.js";import{S as Ce}from"./separator-ufYdAZKN.js";import{S as w,a as T,b as D,c as A,d as u}from"./select-CLbTsJJp.js";import{A as Se,a as Ne,b as be,c as ye,d as we,e as Te,f as De,g as Ae}from"./alert-dialog-BkSlHPy5.js";import{f as Ee,b as Ie,g as G,h as Pe,S as _e}from"./crmTypes-CiPVSVr_.js";import{C as Fe}from"./ClientSelect-DNdvzJbO.js";import{C as Me}from"./checkbox-MtKtJYR3.js";import{u as Le}from"./ProcessosList-DeOZ8KEM.js";import{S as Ve}from"./search-DRk7yPhG.js";import{T as Q}from"./trash-2-DfpIpLp4.js";import{L as W}from"./loader-circle-DoMssvgx.js";import{C as Be}from"./chevron-up-DsofAcH6.js";import{C as Oe}from"./chevron-right-bjNG9heW.js";import{U as X}from"./user-CwbXQKSa.js";import{a as ze}from"./circle-check-DtZLtjOO.js";import{C as Re}from"./dropdown-menu-wbYYQtYw.js";import{C as Ke}from"./clock-ChVSFK-z.js";import{P as He}from"./pencil-D2l7Rrk1.js";import{o as Ue,s as C,b as $e}from"./types-Ba-nZvwf.js";function qe({value:l,onValueChange:h,placeholder:a="Selecione um processo..."}){const{processos:m}=Le(),[x,y]=d.useState(""),o=d.useMemo(()=>{if(!x.trim())return m;const n=x.toLowerCase();return m.filter(f=>{var r;return f.numero.toLowerCase().includes(n)||((r=f.titulo)==null?void 0:r.toLowerCase().includes(n))})},[m,x]);return e.jsxs(w,{value:l||"none",onValueChange:n=>h(n==="none"?"":n),children:[e.jsx(T,{children:e.jsx(D,{placeholder:a})}),e.jsxs(A,{children:[e.jsx("div",{className:"px-2 pb-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ve,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),e.jsx(F,{value:x,onChange:n=>y(n.target.value),placeholder:"Buscar processo...",className:"h-8 pl-7 text-sm",onKeyDown:n=>n.stopPropagation()})]})}),e.jsx(u,{value:"none",children:"— Sem processo —"}),o.map(n=>e.jsxs(u,{value:n.numero,children:[e.jsx("span",{className:"font-mono text-xs",children:n.numero}),n.titulo&&e.jsxs("span",{className:"ml-1 text-xs text-muted-foreground",children:["• ",n.titulo]})]},n.id)),o.length===0&&x.trim()&&e.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"Nenhum processo encontrado"})]})]})}const Je=Ue({title:C().trim().min(1,"Título obrigatório").max(200),deadline:C().optional(),priority:C().min(1),status:C().min(1),clientName:C().optional(),projectId:C().optional(),assignee:C().optional(),description:C().max(2e3).optional(),numeroProcesso:C().max(25).optional(),relatorioMensal:$e().optional()});function U({initial:l,onSave:h,onCancel:a,saving:m}){var f;const{getOptions:x}=q(),y=x("subtarefa_status"),[o,n]=d.useState(l??{title:"",deadline:"",status:((f=y[0])==null?void 0:f.value)??"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(F,{placeholder:"Título da sub-tarefa *",value:o.title,onChange:r=>n(i=>({...i,title:r.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(F,{type:"date",value:o.deadline,onChange:r=>n(i=>({...i,deadline:r.target.value}))}),e.jsxs(w,{value:o.status,onValueChange:r=>n(i=>({...i,status:r})),children:[e.jsx(T,{children:e.jsx(D,{})}),e.jsx(A,{children:y.map(r=>e.jsx(u,{value:r.value,children:r.label},r.value))})]})]}),e.jsxs(w,{value:o.assignee||"_none_",onValueChange:r=>n(i=>({...i,assignee:r==="_none_"?"":r})),children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(D,{placeholder:"Responsável..."})]})}),e.jsxs(A,{children:[e.jsx(u,{value:"_none_",children:"— Sem responsável —"}),G.map(r=>e.jsx(u,{value:r,children:r},r))]})]}),e.jsx($,{value:o.notes,onChange:r=>n(i=>({...i,notes:r})),placeholder:"Observações...",className:"min-h-[60px]",modalTitle:"Editar Observações da Subtarefa"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:a,disabled:m,children:"Cancelar"}),e.jsxs(b,{type:"button",size:"sm",disabled:!o.title.trim()||m,onClick:()=>h(o),children:[m&&e.jsx(W,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function Ge({sub:l,onEdit:h,onDelete:a,onToggleStatus:m}){const x=l.dueDate&&l.dueDate<new Date().toISOString().split("T")[0]&&l.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:m,className:"mt-0.5 shrink-0",children:l.completed?e.jsx(ze,{className:"w-4 h-4 text-primary"}):e.jsx(Re,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:V("text-sm",l.completed&&"line-through text-muted-foreground"),children:l.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx(J,{variant:"secondary",className:V("text-[10px]",Pe[l.status]),children:_e[l.status]}),l.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(X,{className:"w-3 h-3"}),l.assignee]}),l.dueDate&&e.jsxs("span",{className:V("text-[10px] flex items-center gap-0.5",x?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(Ke,{className:"w-3 h-3"}),new Date(l.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),l.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:l.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:h,children:e.jsx(He,{className:"w-3 h-3"})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:a,children:e.jsx(Q,{className:"w-3 h-3"})})]})]})}function Ss({open:l,onOpenChange:h,task:a,defaultClientName:m,onSave:x,onDelete:y,onCreateSubtask:o,onUpdateSubtask:n,onDeleteSubtask:f}){const r=!a,[i,B]=d.useState(!1),[O,P]=d.useState(!1);Ee();const{projects:Y}=Ie(),{getOptions:z}=q(),Z=z("tarefa_status"),k=z("tarefa_prioridade"),[M,ee]=d.useState(!0),[R,E]=d.useState(!1),[se,I]=d.useState(null),[_,L]=d.useState(null),c=ie({resolver:de(Je),defaultValues:{title:"",deadline:"",priority:"media",status:"agendado",clientName:"",projectId:"",assignee:"",description:""}});d.useEffect(()=>{l&&(E(!1),I(null),a?c.reset({title:a.title,deadline:a.dueDate??"",priority:a.priority,status:a.status,clientName:a.client??"",projectId:a.projectId??"",assignee:a.assignee??"",description:a.description??"",numeroProcesso:a.numeroProcesso??"",relatorioMensal:a.relatorioMensal??!1}):c.reset({title:"",deadline:"",priority:"media",status:"agendado",clientName:m??"",projectId:"",assignee:"",description:"",numeroProcesso:"",relatorioMensal:!1}))},[l,a]);const ae=async s=>{B(!0);try{await x(s,r,a==null?void 0:a.airtableId),h(!1)}catch(t){oe.error("Erro ao salvar tarefa: "+t.message),console.error("Erro ao salvar tarefa:",t)}finally{B(!1)}},te=d.useCallback(async s=>{if(!(!(a!=null&&a.airtableId)||!o)){P(!0);try{await o(a.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),E(!1)}finally{P(!1)}}},[a,o]),re=d.useCallback(async(s,t)=>{if(n){P(!0);try{await n(s,{title:t.title,deadline:t.deadline||void 0,status:t.status,assignee:t.assignee||void 0,notes:t.notes||void 0}),I(null)}finally{P(!1)}}},[n]),ne=d.useCallback(async s=>{if(!n)return;const t=s.completed?"A fazer":"Concluído";await n(s.id,{status:t})},[n]),le=d.useCallback(async()=>{if(!(!_||!f))try{await f(_)}finally{L(null)}},[_,f]),S=(a==null?void 0:a.subtasks)??[],K=S.filter(s=>s.status==="Concluído").length,H=S.length>0?Math.round(K/S.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(ue,{open:l,onOpenChange:h,children:e.jsxs(he,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(je,{className:"mb-6",children:[e.jsx(pe,{children:r?"Nova Tarefa":"Editar Tarefa"}),e.jsx(ge,{children:r?"Preencha os dados para criar a tarefa.":"Altere os campos e salve."})]}),e.jsx(ce,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(ae),className:"space-y-5",children:[e.jsx(j,{control:c.control,name:"title",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Título *"}),e.jsx(N,{children:e.jsx(F,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(v,{})]})}),e.jsx(j,{control:c.control,name:"deadline",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Prazo"}),e.jsx(N,{children:e.jsx(xe,{value:s.value,onChange:s.onChange})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:c.control,name:"priority",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Prioridade"}),e.jsxs(w,{onValueChange:s.onChange,value:s.value,children:[e.jsx(N,{children:e.jsx(T,{children:e.jsx(D,{})})}),e.jsx(A,{children:k.map(t=>e.jsx(u,{value:t.value,children:t.label},t.value))})]}),e.jsx(v,{})]})}),e.jsx(j,{control:c.control,name:"status",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Status"}),e.jsxs(w,{onValueChange:s.onChange,value:s.value,children:[e.jsx(N,{children:e.jsx(T,{children:e.jsx(D,{})})}),e.jsx(A,{children:Z.map(t=>e.jsx(u,{value:t.value,children:t.label},t.value))})]}),e.jsx(v,{})]})})]}),e.jsx(j,{control:c.control,name:"projectId",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Projeto"}),e.jsxs(w,{onValueChange:t=>s.onChange(t==="none"?"":t),value:s.value||"none",children:[e.jsx(N,{children:e.jsx(T,{children:e.jsx(D,{placeholder:"Selecione..."})})}),e.jsxs(A,{children:[e.jsx(u,{value:"none",children:"— Sem projeto —"}),Y.map(t=>e.jsx(u,{value:t.id,children:t.name},t.id))]})]}),e.jsx(v,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:c.control,name:"clientName",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Cliente"}),e.jsx(Fe,{value:s.value,onValueChange:t=>s.onChange(t)}),e.jsx(v,{})]})}),e.jsx(j,{control:c.control,name:"assignee",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Responsável"}),e.jsxs(w,{onValueChange:t=>s.onChange(t==="_none_"?"":t),value:s.value||"_none_",children:[e.jsx(N,{children:e.jsx(T,{children:e.jsx(D,{placeholder:"Selecione..."})})}),e.jsxs(A,{children:[e.jsx(u,{value:"_none_",children:"— Sem responsável —"}),G.map(t=>e.jsx(u,{value:t,children:t},t))]})]}),e.jsx(v,{})]})})]}),e.jsx(j,{control:c.control,name:"numeroProcesso",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Processo Judicial"}),e.jsx(qe,{value:s.value??"",onValueChange:s.onChange}),e.jsx(v,{})]})}),e.jsx(j,{control:c.control,name:"description",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Descrição"}),e.jsx(N,{children:e.jsx($,{value:s.value??"",onChange:s.onChange,placeholder:"Detalhes sobre a tarefa...",modalTitle:"Editar Descrição da Tarefa"})}),e.jsx(v,{})]})}),e.jsx(j,{control:c.control,name:"relatorioMensal",render:({field:s})=>e.jsxs(p,{className:"flex items-center gap-3 space-y-0 rounded-lg border border-border p-3",children:[e.jsx(N,{children:e.jsx(Me,{checked:s.value,onCheckedChange:s.onChange})}),e.jsxs("div",{className:"leading-none",children:[e.jsx(g,{className:"text-sm font-medium cursor-pointer",children:"Relatório Mensal"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Incluir esta tarefa no relatório mensal do cliente"})]})]})}),!r&&(a==null?void 0:a.airtableId)&&e.jsx(me,{folder:`tarefas/${a.airtableId}`}),e.jsxs(fe,{className:"pt-2 gap-2 flex-col sm:flex-row",children:[!r&&a&&y&&e.jsxs(b,{type:"button",variant:"destructive",className:"sm:mr-auto",onClick:()=>{y(a.id),h(!1)},disabled:i,children:[e.jsx(Q,{className:"w-4 h-4 mr-2"})," Excluir"]}),e.jsx(b,{type:"button",variant:"outline",onClick:()=>h(!1),disabled:i,children:"Cancelar"}),e.jsxs(b,{type:"submit",disabled:i,children:[i&&e.jsx(W,{className:"w-4 h-4 mr-2 animate-spin"}),r?"Criar tarefa":"Salvar alterações"]})]})]})}),!r&&a&&e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>ee(!M),children:[M?e.jsx(Be,{className:"w-4 h-4"}):e.jsx(Oe,{className:"w-4 h-4"}),"Sub-tarefas",S.length>0&&e.jsxs(J,{variant:"secondary",className:"text-[10px] ml-1",children:[K,"/",S.length]})]}),e.jsxs(b,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{E(!0),I(null)},children:[e.jsx(ve,{className:"w-3.5 h-3.5"})," Nova"]})]}),S.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${H}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[H,"%"]})]}),M&&e.jsxs("div",{className:"space-y-1",children:[S.map(s=>se===s.id?e.jsx(U,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:t=>re(s.id,t),onCancel:()=>I(null),saving:O},s.id):e.jsx(Ge,{sub:s,onEdit:()=>{I(s.id),E(!1)},onDelete:()=>L(s.id),onToggleStatus:()=>ne(s)},s.id)),S.length===0&&!R&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),R&&e.jsx(U,{onSave:te,onCancel:()=>E(!1),saving:O})]})]})]})]})}),e.jsx(Se,{open:!!_,onOpenChange:s=>!s&&L(null),children:e.jsxs(Ne,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Excluir sub-tarefa?"}),e.jsx(we,{children:"Esta ação removerá a sub-tarefa permanentemente e não pode ser desfeita."})]}),e.jsxs(Te,{children:[e.jsx(De,{children:"Cancelar"}),e.jsx(Ae,{onClick:le,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{qe as P,Ss as T};
