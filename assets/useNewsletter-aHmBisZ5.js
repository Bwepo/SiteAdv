import{a as l,u as d}from"./useMutation-S1XUc4T2.js";import{a7 as c,E as a}from"./index-CRbxGvyX.js";function y(){const t=c();return l({mutationFn:async e=>{var n,i,o;const s=e.email.trim().toLowerCase(),r=((n=e.source)==null?void 0:n.trim())||"website",{error:u}=await a.from("mladv_newsletter_subscribers").upsert({email:s,name:((i=e.name)==null?void 0:i.trim())||null,source:r,confirmed:!0,unsubscribed_at:null},{onConflict:"email"});if(u)throw u;return{email:s,name:((o=e.name)==null?void 0:o.trim())||null,source:r}},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function p(){const t=c();return l({mutationFn:async e=>{var i;const s=e.email.trim().toLowerCase(),r=((i=e.name)==null?void 0:i.trim())||null,{data:u,error:n}=await a.from("mladv_newsletter_subscribers").upsert({email:s,name:r,source:"admin",confirmed:!0,unsubscribed_at:null},{onConflict:"email"}).select("*").single();if(n)throw n;return u},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function _(){return d({queryKey:["newsletter-subscribers"],queryFn:async()=>{const{data:t,error:e}=await a.from("mladv_newsletter_subscribers").select("*").order("subscribed_at",{ascending:!1});if(e)throw e;return t||[]}})}function g(){return d({queryKey:["newsletter-stats"],queryFn:async()=>{const{data:t,error:e,count:s}=await a.from("mladv_newsletter_subscribers").select("*",{count:"exact"}).is("unsubscribed_at",null);if(e)throw e;const r=new Date;r.setDate(r.getDate()-7);const u=(t||[]).filter(n=>new Date(n.subscribed_at)>=r).length;return{total:s||0,active:s||0,newThisWeek:u}}})}function v(){const t=c();return l({mutationFn:async e=>{const{error:s}=await a.from("mladv_newsletter_subscribers").delete().eq("id",e);if(s)throw s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function q(){return l({mutationFn:async()=>{const{data:t,error:e}=await a.from("mladv_newsletter_subscribers").select("email, name, subscribed_at").is("unsubscribed_at",null).order("subscribed_at",{ascending:!1});if(e)throw e;const s=["Email","Nome","Data de Inscrição"],r=(t||[]).map(o=>[o.email,o.name||"",new Date(o.subscribed_at).toLocaleDateString("pt-BR")]),u=[s.join(","),...r.map(o=>o.map(m=>`"${m}"`).join(","))].join(`
`),n=new Blob([u],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");return i.href=URL.createObjectURL(n),i.download=`newsletter-subscribers-${new Date().toISOString().split("T")[0]}.csv`,i.click(),u}})}function h(){return d({queryKey:["newsletter-campaigns"],queryFn:async()=>{const{data:t,error:e}=await a.from("mladv_newsletter_campaigns").select("id, subject, status, created_at, sent_at, post_id, mladv_posts(title, slug)").order("created_at",{ascending:!1});if(e)throw e;return t||[]}})}function S(t){return d({queryKey:["newsletter-campaign",t],enabled:!!t,queryFn:async()=>{const{data:e,error:s}=await a.from("mladv_newsletter_campaigns").select("*, mladv_posts(title, slug)").eq("id",t).single();if(s)throw s;const{data:r,error:u}=await a.from("mladv_newsletter_deliveries").select("status").eq("campaign_id",t);if(u)throw u;const n={queued:0,sent:0,failed:0,skipped:0};return(r||[]).forEach(i=>{i.status==="queued"?n.queued++:i.status==="sent"?n.sent++:i.status==="failed"?n.failed++:i.status==="skipped"&&n.skipped++}),{campaign:e,deliveryCounts:n}}})}function C(){const t=c();return l({mutationFn:async e=>{const s=e.post_id&&e.post_id.length>0;if(s){const{data:o}=await a.from("mladv_newsletter_campaigns").select("id").eq("post_id",e.post_id).in("status",["draft","queued","sending"]).maybeSingle();if(o)return console.log("[newsletter] Campaign already exists for post, skipping creation"),o}const{data:r,error:u}=await a.from("mladv_newsletter_campaigns").insert({subject:e.subject,html:e.html,post_id:s?e.post_id:null,status:"queued"}).select("id").single();if(u)throw u;const{data:n,error:i}=await a.from("mladv_newsletter_subscribers").select("id, email").eq("confirmed",!0).is("unsubscribed_at",null);if(i)throw i;if(n&&n.length>0){const o=n.map(w=>({campaign_id:r.id,subscriber_id:w.id,email:w.email,status:"queued"})),{error:m}=await a.from("mladv_newsletter_deliveries").insert(o);if(m)throw m;console.log(`[newsletter] Created campaign ${r.id} with ${o.length} deliveries`)}else console.warn("[newsletter] No active subscribers found");return r},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]})}})}function K(){const t=c();return l({mutationFn:async e=>{const{data:s,error:r}=await a.functions.invoke("send-newsletter-campaign",{body:{campaign_id:e}});if(r)throw r;return s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]}),t.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function Q(){const t=c();return l({mutationFn:async e=>{const{error:s}=await a.from("mladv_newsletter_campaigns").delete().eq("id",e);if(s)throw s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]}),t.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function D(){return d({queryKey:["newsletter-settings"],queryFn:async()=>{const{data:t,error:e}=await a.from("mladv_newsletter_settings").select("*").eq("id",1).maybeSingle();if(e)throw e;return t}})}function F(){const t=c();return l({mutationFn:async e=>{const{data:s,error:r}=await a.from("mladv_newsletter_settings").update({...e,updated_at:new Date().toISOString()}).eq("id",1).select().single();if(r)throw r;return s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-settings"]})}})}export{g as a,h as b,_ as c,p as d,v as e,q as f,C as g,K as h,Q as i,S as j,D as k,F as l,y as u};
