import{a as f,u as _}from"./useMutation-DbLhVrSi.js";import{ad as w,I as o}from"./index-BCEvkLav.js";async function q(e){if(e.length===0)return new Map;const{data:t,error:s}=await o.from("mladv_post_categories").select("post_id, category_id").in("post_id",e);if(s||!t)return new Map;const a=[...new Set(t.map(l=>l.category_id))];if(a.length===0)return new Map;const{data:r,error:n}=await o.from("mladv_categories").select("*").in("id",a);if(n||!r)return new Map;const d=new Map(r.map(l=>[l.id,l])),i=new Map;return e.forEach(l=>{const g=t.filter(c=>c.post_id===l).map(c=>d.get(c.category_id)).filter(c=>c!==void 0);i.set(l,g)}),i}function E(e={}){const{published:t,page:s=1,pageSize:a=10,search:r,categorySlug:n,tag:d}=e;return f({queryKey:["posts",{published:t,page:s,pageSize:a,search:r,categorySlug:n,tag:d}],queryFn:async()=>{if(n){const{data:p}=await o.from("mladv_categories").select("id").eq("slug",n).maybeSingle();if(!p)return{posts:[],total:0,totalPages:0};const{data:m}=await o.from("mladv_post_categories").select("post_id").eq("category_id",p.id),v=(m==null?void 0:m.map(y=>y.post_id))||[];if(v.length===0)return{posts:[],total:0,totalPages:0};let u=o.from("mladv_posts").select("*",{count:"exact"}).in("id",v);t!==void 0&&(u=u.eq("published",t)),r&&(u=u.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),d&&(u=u.contains("tags",[d])),u=u.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((s-1)*a,s*a-1);const{data:Q,error:b,count:K}=await u;if(b)throw b;const M=Q||[],C=await q(M.map(y=>y.id));return{posts:M.map(y=>({...y,categories:C.get(y.id)||[]})),total:K??0,totalPages:Math.ceil((K??0)/a)}}let i=o.from("mladv_posts").select("*",{count:"exact"});t!==void 0&&(i=i.eq("published",t)),r&&(i=i.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),d&&(i=i.contains("tags",[d])),i=i.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((s-1)*a,s*a-1);const{data:l,error:g,count:c}=await i;if(g)throw g;const h=l||[],P=await q(h.map(p=>p.id));return{posts:h.map(p=>({...p,categories:P.get(p.id)||[]})),total:c??0,totalPages:Math.ceil((c??0)/a)}}})}function T(){return f({queryKey:["featured-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").eq("published",!0).eq("featured",!0).order("published_at",{ascending:!1}).limit(3);if(t)throw t;const s=e||[],a=await q(s.map(n=>n.id));return s.map(n=>({...n,categories:a.get(n.id)||[]}))}})}function $(){return f({queryKey:["all-tags"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("tags").eq("published",!0);if(t)throw t;const s=(e==null?void 0:e.flatMap(r=>r.tags||[]))||[];return[...new Set(s)].sort()}})}function x(e){return f({queryKey:["post",e],queryFn:async()=>{const{data:t,error:s}=await o.from("mladv_posts").select("*").eq("slug",e).eq("published",!0).maybeSingle();if(s)throw s;return t},enabled:!!e})}function A(e){return f({queryKey:["post-by-id",e],queryFn:async()=>{const{data:t,error:s}=await o.from("mladv_posts").select("*").eq("id",e).maybeSingle();if(s)throw s;return t},enabled:!!e})}function D(){return f({queryKey:["all-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function I(){const e=w();return _({mutationFn:async t=>{const{data:s,error:a}=await o.from("mladv_posts").insert(t).select().single();if(a)throw a;return s},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]})}})}function R(){const e=w();return _({mutationFn:async({id:t,...s})=>{const{data:a,error:r}=await o.from("mladv_posts").update({...s,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(r)throw r;return a},onSuccess:t=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post",t.slug]}),e.invalidateQueries({queryKey:["post-by-id",t.id]})}})}function z(){const e=w();return _({mutationFn:async t=>{(await Promise.all([o.from("mladv_post_categories").delete().eq("post_id",t),o.from("mladv_post_views").delete().eq("post_id",t),o.from("mladv_post_likes").delete().eq("post_id",t),o.from("mladv_post_comments").delete().eq("post_id",t)])).forEach(({error:r})=>{if(r)throw r});const{error:a}=await o.from("mladv_posts").delete().eq("id",t);if(a)throw a},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post-views"]}),e.invalidateQueries({queryKey:["post-likes"]}),e.invalidateQueries({queryKey:["post-comments"]}),e.invalidateQueries({queryKey:["all-comments"]})}})}export{T as a,E as b,x as c,D as d,R as e,z as f,I as g,A as h,$ as u};
