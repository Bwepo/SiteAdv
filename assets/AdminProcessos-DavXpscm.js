import{$ as ke,r as t,j as e,m as _e,s as Te,h as f}from"./index-XOEQRGXm.js";import{u as Ee}from"./useQuery-uY6xYbHE.js";import{P as Pe,B as De}from"./badge-v8ODF_78.js";import{B as y}from"./button-WZPRmnAM.js";import{I as v}from"./input-QPY9m9ev.js";import{L as n}from"./label-vPa6cMLX.js";import{n as ce,c as Ie,d as Le,E as Oe,A as Be,p as Me}from"./formatters-zFpln4c4.js";import{S as Re}from"./skeleton-BZ-GXHEh.js";import{D as Ve,a as Fe,c as qe,d as $e,f as Qe}from"./dialog-kxtA2HCq.js";import{A as ze,a as He,b as Ke,c as Ue,d as Ye,e as Je,f as Ge,g as We}from"./alert-dialog-CpfDb7u1.js";import{T as Xe,a as Ze,b as ie,c as d,d as es,e as m}from"./table-CFaYuXwx.js";import{S as Q,a as z,b as H,c as K,d as S}from"./select-DYSfhP-F.js";import{C as ss}from"./ClientSelect-vFO4gRVg.js";import{f as as,P as ne}from"./crmTypes-Bwpny-EE.js";import{S as de}from"./scale-CHvkWviS.js";import{S as ts}from"./search-CCjaW1K8.js";import{F as me}from"./filter-Bt8L5dAR.js";import{C as rs}from"./clipboard-list-xZWX1yba.js";import{P as ls}from"./pencil-DZaHZPQc.js";import{T as os}from"./trash-2-BcokVNM2.js";import{L as cs}from"./loader-circle-BJm1TtSo.js";import{A as is}from"./arrow-up-down-Hni9L0de.js";import"./download-CJA_shTh.js";import"./file-text-BUNV8wGh.js";import"./tabs-3VGVMF8w.js";import"./index-DgJr1gDL.js";import"./index-1yva3IVh.js";import"./TipTapEditor-Cu9fwhZ_.js";import"./index-Dj_dTzr9.js";import"./dropdown-menu-BGMDfJpe.js";import"./index-Dy6WPsLk.js";import"./chevron-right-CfNKZgVH.js";import"./check-X6PQKyrX.js";import"./link-BsgpJTyT.js";import"./list-CKo6lLrZ.js";import"./quote-DQoquyU1.js";import"./textarea-DKymgsiP.js";import"./index-BZxwSUEN.js";import"./index-CtOO4acQ.js";import"./chevron-up-Fk1wAqO5.js";import"./popover-DyNZ7vZd.js";const A=l=>Te.from(l);function ns(l){return{id:l.id,clienteAirtableId:l.cliente_airtable_id||"",numero:l.numero||"",titulo:l.titulo||void 0,vara:l.vara||void 0,comarca:l.comarca||void 0,status:l.status||"Ativo",observacoes:l.observacoes||void 0,valorCausa:l.valor_causa!=null?Number(l.valor_causa):null,createdAt:l.created_at||"",updatedAt:l.updated_at||""}}const ue=["crm","processos-page"];function Ws(){const l=ke(),{clients:k}=as(),{data:x,isLoading:xe}=Ee({queryKey:ue,queryFn:async()=>{const[s,a]=await Promise.all([A("mladv_crm_processos").select("id,cliente_airtable_id,numero,titulo,vara,comarca,status,observacoes,valor_causa,created_at,updated_at").order("created_at",{ascending:!1}),A("mladv_crm_tarefas").select("numero_processo")]);if(s.error)throw s.error;const r=(s.data||[]).map(ns),o=new Map;a.error||(a.data||[]).forEach(u=>{const j=u.numero_processo;j&&o.set(j,(o.get(j)||0)+1)});const w=new Map;return r.forEach(u=>w.set(u.id,o.get(u.numero)||0)),{processos:r,taskCounts:w}}}),c=(x==null?void 0:x.processos)??[],_=(x==null?void 0:x.taskCounts)??new Map,U=t.useCallback(()=>{l.invalidateQueries({queryKey:ue}),l.invalidateQueries({queryKey:["crm-processos"]})},[l]),[N,he]=t.useState(""),[i,Y]=t.useState("all"),[h,pe]=t.useState("all"),[T,ge]=t.useState("created_at"),[J,G]=t.useState("desc"),[je,b]=t.useState(!1),[p,W]=t.useState(null),[X,Z]=t.useState(!1),[D,I]=t.useState(null),[E,L]=t.useState(""),[ee,O]=t.useState(""),[se,B]=t.useState(""),[ae,M]=t.useState(""),[te,R]=t.useState("Ativo"),[re,V]=t.useState(""),[le,F]=t.useState(""),[fe,q]=t.useState(""),[ve,$]=t.useState(""),g=t.useMemo(()=>{const s=new Map;return k.forEach(a=>s.set(a.id,a.name)),s},[k]),Ne=s=>{T===s?G(a=>a==="asc"?"desc":"asc"):(ge(s),G("asc"))},P=t.useMemo(()=>{let s=c;if(N.trim()){const a=N.toLowerCase();s=s.filter(r=>{var o,w,u,j;return r.numero.toLowerCase().includes(a)||((o=r.titulo)==null?void 0:o.toLowerCase().includes(a))||((w=r.vara)==null?void 0:w.toLowerCase().includes(a))||((u=r.comarca)==null?void 0:u.toLowerCase().includes(a))||((j=g.get(r.clienteAirtableId))==null?void 0:j.toLowerCase().includes(a))})}return i!=="all"&&(s=s.filter(a=>a.status===i)),h!=="all"&&(s=s.filter(a=>a.clienteAirtableId===h)),[...s].sort((a,r)=>{let o=0;switch(T){case"numero":o=a.numero.localeCompare(r.numero);break;case"titulo":o=(a.titulo||"").localeCompare(r.titulo||"");break;case"status":o=a.status.localeCompare(r.status);break;case"cliente":o=(g.get(a.clienteAirtableId)||"").localeCompare(g.get(r.clienteAirtableId)||"");break;case"tarefas":o=(_.get(a.id)??0)-(_.get(r.id)??0);break;case"created_at":o=(a.createdAt||"").localeCompare(r.createdAt||"");break}return J==="asc"?o:-o})},[c,N,i,h,T,J,g,_]),be=t.useMemo(()=>{const s=new Set(c.map(a=>a.status));return Array.from(s).sort()},[c]),Ce=t.useMemo(()=>{const s=new Set(c.map(a=>a.clienteAirtableId).filter(Boolean));return k.filter(a=>s.has(a.id))},[c,k]),we=()=>{W(null),L(""),O(""),B(""),M(""),R("Ativo"),V(""),F(""),q(""),$(""),b(!0)},oe=s=>{W(s),L(s.numero),O(s.titulo||""),B(s.vara||""),M(s.comarca||""),R(s.status),V(s.observacoes||""),F(s.valorCausa!=null?ce(s.valorCausa):""),q(s.clienteAirtableId),$(g.get(s.clienteAirtableId)||""),b(!0)},ye=async()=>{if(!E.trim()){f.error("Número do processo é obrigatório");return}Z(!0);try{const s={numero:E.trim(),titulo:ee.trim()||null,vara:se.trim()||null,comarca:ae.trim()||null,status:te,observacoes:re.trim()||null,valor_causa:Me(le),cliente_airtable_id:fe||null};if(p){const{error:a}=await A("mladv_crm_processos").update(s).eq("id",p.id);if(a)throw a;f.success("Processo atualizado!")}else{const{error:a}=await A("mladv_crm_processos").insert(s);if(a)throw a;f.success("Processo criado!")}U(),b(!1)}catch(s){f.error("Erro: "+s.message)}finally{Z(!1)}},Se=async()=>{if(D)try{const{error:s}=await A("mladv_crm_processos").delete().eq("id",D);if(s)throw s;f.success("Processo removido"),U()}catch(s){f.error("Erro: "+s.message)}finally{I(null)}},Ae=s=>{switch(s){case"Ativo":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";case"Arquivado":return"bg-gray-100 text-gray-800 dark:bg-gray-800/30 dark:text-gray-400";case"Encerrado":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400";case"Suspenso":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400";default:return"bg-muted text-muted-foreground"}},C=({field:s,label:a})=>e.jsxs("button",{onClick:()=>Ne(s),className:"flex items-center gap-1 hover:text-foreground transition-colors",children:[a,e.jsx(is,{className:`h-3 w-3 ${T===s?"text-primary":"text-muted-foreground/50"}`})]});return xe?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(Re,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(_e.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"h-7 w-7 text-primary"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Processos"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.length," processo",c.length!==1?"s":""," cadastrado",c.length!==1?"s":"",i!=="all"||h!=="all"?` • ${P.length} exibido${P.length!==1?"s":""}`:""]})]})]}),e.jsxs(y,{onClick:we,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"})," Novo Processo"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(ts,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(v,{value:N,onChange:s=>he(s.target.value),placeholder:"Buscar nº processo, título, vara, comarca, cliente...",className:"pl-9 min-w-[220px]"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Q,{value:i,onValueChange:Y,children:[e.jsxs(z,{className:"w-[140px]",children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(H,{placeholder:"Status"})]}),e.jsxs(K,{children:[e.jsx(S,{value:"all",children:"Todos Status"}),be.map(s=>e.jsx(S,{value:s,children:s},s))]})]}),e.jsxs(Q,{value:h,onValueChange:pe,children:[e.jsxs(z,{className:"w-[160px]",children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1.5 text-muted-foreground"}),e.jsx(H,{placeholder:"Cliente"})]}),e.jsxs(K,{children:[e.jsx(S,{value:"all",children:"Todos Clientes"}),Ce.map(s=>e.jsx(S,{value:s.id,children:s.name},s.id))]})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:ne.map(s=>{const a=c.filter(r=>r.status===s).length;return e.jsxs("button",{onClick:()=>Y(i===s?"all":s),className:`rounded-lg border p-3 text-left transition-all hover:shadow-sm ${i===s?"ring-2 ring-primary border-primary":"border-border"}`,children:[e.jsx("p",{className:"text-2xl font-bold",children:a}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s,a!==1?"s":""]})]},s)})}),P.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(de,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum processo encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:N||i!=="all"||h!=="all"?"Tente ajustar os filtros.":"Adicione seu primeiro processo."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card overflow-x-auto",children:e.jsxs(Xe,{children:[e.jsx(Ze,{children:e.jsxs(ie,{children:[e.jsx(d,{children:e.jsx(C,{field:"numero",label:"Nº Processo"})}),e.jsx(d,{className:"hidden md:table-cell",children:e.jsx(C,{field:"titulo",label:"Título"})}),e.jsx(d,{className:"hidden sm:table-cell",children:e.jsx(C,{field:"cliente",label:"Cliente"})}),e.jsx(d,{className:"w-[100px]",children:e.jsx(C,{field:"status",label:"Status"})}),e.jsx(d,{className:"hidden lg:table-cell",children:"Vara / Comarca"}),e.jsx(d,{className:"hidden md:table-cell w-[120px] text-right",children:"Valor"}),e.jsx(d,{className:"hidden sm:table-cell w-[80px] text-center",children:e.jsx(C,{field:"tarefas",label:"Tarefas"})}),e.jsx(d,{className:"w-[90px] text-right",children:"Ações"})]})}),e.jsx(es,{children:P.map(s=>{const a=g.get(s.clienteAirtableId),r=_.get(s.id)??0;return e.jsxs(ie,{className:"cursor-pointer",onClick:()=>oe(s),children:[e.jsx(m,{children:e.jsx("span",{className:"font-mono text-sm font-medium",children:s.numero})}),e.jsx(m,{className:"hidden md:table-cell",children:e.jsx("span",{className:"text-sm truncate max-w-[200px] block",children:s.titulo||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{className:"hidden sm:table-cell",children:e.jsx("span",{className:"text-sm",children:a||e.jsx("span",{className:"text-muted-foreground italic",children:"—"})})}),e.jsx(m,{children:e.jsx(De,{variant:"secondary",className:Ae(s.status),children:s.status})}),e.jsx(m,{className:"hidden lg:table-cell",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:[s.vara,s.comarca].filter(Boolean).join(" • ")||"—"})}),e.jsx(m,{className:"hidden md:table-cell text-right",children:e.jsx("span",{className:"text-sm font-medium",children:s.valorCausa!=null?ce(s.valorCausa):e.jsx("span",{className:"text-muted-foreground",children:"—"})})}),e.jsx(m,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-muted-foreground",children:[e.jsx(rs,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:r})]})}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",onClick:o=>o.stopPropagation(),children:[e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>oe(s),title:"Editar",children:e.jsx(ls,{className:"h-3.5 w-3.5"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>I(s.id),title:"Excluir",children:e.jsx(os,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(Ve,{open:je,onOpenChange:b,children:e.jsxs(Fe,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(qe,{children:e.jsx($e,{children:p?"Editar Processo":"Novo Processo"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Número do Processo *"}),e.jsx(v,{value:E,onChange:s=>L(Ie(s.target.value)),placeholder:"NNNNNNN-DD.AAAA.J.TR.OOOO",maxLength:25,autoFocus:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Título / Descrição breve"}),e.jsx(v,{value:ee,onChange:s=>O(s.target.value),placeholder:"Ex: Ação de Indenização por Danos Morais"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Cliente vinculado"}),e.jsx(ss,{value:ve,onValueChange:(s,a)=>{$(s),q(a)}})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Vara"}),e.jsx(v,{value:se,onChange:s=>B(s.target.value),placeholder:"Ex: 3ª Vara Cível"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Comarca"}),e.jsx(v,{value:ae,onChange:s=>M(s.target.value),placeholder:"Ex: São Paulo/SP"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Status"}),e.jsxs(Q,{value:te,onValueChange:R,children:[e.jsx(z,{children:e.jsx(H,{})}),e.jsx(K,{children:ne.map(s=>e.jsx(S,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Valor da Causa"}),e.jsx(v,{value:le,onChange:s=>F(Le(s.target.value)),placeholder:"R$ 0,00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Observações"}),e.jsx(Oe,{value:re,onChange:V,placeholder:"Notas internas sobre o processo, decisões relevantes, próximos passos...",modalTitle:"Editar Observações do Processo"})]}),p&&e.jsx(Be,{folder:`processos/${p.id}`})]}),e.jsxs(Qe,{children:[e.jsx(y,{variant:"outline",onClick:()=>b(!1),children:"Cancelar"}),e.jsxs(y,{onClick:ye,disabled:!E.trim()||X,children:[X&&e.jsx(cs,{className:"h-4 w-4 animate-spin mr-2"}),p?"Salvar":"Criar Processo"]})]})]})}),e.jsx(ze,{open:!!D,onOpenChange:s=>!s&&I(null),children:e.jsxs(He,{children:[e.jsxs(Ke,{children:[e.jsx(Ue,{children:"Excluir processo?"}),e.jsx(Ye,{children:"Esta ação é permanente e não pode ser desfeita. Tarefas vinculadas a este processo não serão removidas."})]}),e.jsxs(Je,{children:[e.jsx(Ge,{children:"Cancelar"}),e.jsx(We,{onClick:Se,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{Ws as default};
