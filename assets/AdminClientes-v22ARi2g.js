import{$ as H,r,j as e,m as K,s as N,h as m}from"./index-DRlkAaou.js";import{c as M,b as Q,a as R}from"./useAirtable-D1dj7Ls_.js";import{B as U,P as $}from"./badge-CNu_xf_F.js";import{B as x}from"./button-DLMKOCBr.js";import{I as T}from"./input-_XQ-klIu.js";import{L as G}from"./label-12wqLIL_.js";import{S as J}from"./skeleton-Bqf0-MrG.js";import{D as V,a as W,c as X,d as Y,f as Z}from"./dialog-CXaYH1Iw.js";import{A as ee,a as se,b as ae,c as te,d as re,e as le,f as ie,g as ne}from"./alert-dialog-DkT_OwZe.js";import{T as oe,a as ce,b as L,c as u,d as de,e as p}from"./table-CbpDXoFk.js";import{S as me}from"./search-Ci7U5frY.js";import{U as xe}from"./users-PcxS2OWG.js";import{F as he}from"./folder-kanban-Bw5gs8ZT.js";import{C as ue}from"./clipboard-list-kAJHLPFY.js";import{P as pe}from"./pencil-B-huywX_.js";import{T as je}from"./trash-2-COS8KViw.js";import{L as fe}from"./loader-circle-BmKbPMDk.js";import"./useQuery-mcZAZQAc.js";import"./index-DPdtjjzv.js";import"./index-OBiNSUo_.js";function Oe(){const{clients:l,loading:k}=M(),{projects:v}=Q(),{tasks:C}=R(),b=H(),[n,_]=r.useState(""),[q,o]=r.useState(!1),[h,w]=r.useState(null),[i,j]=r.useState(""),[y,D]=r.useState(!1),[f,g]=r.useState(null),B=r.useMemo(()=>{const s=new Map;return l.forEach(t=>{const a=t.name.toLowerCase(),O=v.filter(c=>{var d,E;return((d=c.cliente)==null?void 0:d.toLowerCase())===a||((E=c.name)==null?void 0:E.toLowerCase())===a}).length,z=C.filter(c=>{var d;return((d=c.client)==null?void 0:d.toLowerCase())===a||c.client===t.id}).length;s.set(t.id,{projetos:O,tarefas:z})}),s},[l,v,C]),A=r.useMemo(()=>{if(!n.trim())return l;const s=n.toLowerCase();return l.filter(t=>t.name.toLowerCase().includes(s))},[l,n]),F=()=>{w(null),j(""),o(!0)},P=s=>{w(s),j(s.name),o(!0)},S=async()=>{if(i.trim()){D(!0);try{const s=i.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");if(h){const{error:t}=await N.from("mladv_crm_clientes").update({nome:i.trim(),slug:s}).eq("airtable_id",h.id);if(t)throw t;m.success("Cliente atualizado!")}else{const t=`local_${Date.now()}`,{error:a}=await N.from("mladv_crm_clientes").insert({nome:i.trim(),slug:s,airtable_id:t});if(a)throw a;m.success("Cliente adicionado!")}b.invalidateQueries({queryKey:["crm","clientes"]}),o(!1)}catch(s){m.error("Erro: "+s.message)}finally{D(!1)}}},I=async()=>{if(f)try{const{error:s}=await N.from("mladv_crm_clientes").delete().eq("airtable_id",f);if(s)throw s;m.success("Cliente removido"),b.invalidateQueries({queryKey:["crm","clientes"]})}catch(s){m.error("Erro ao remover: "+s.message)}finally{g(null)}};return k?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(J,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(K.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsxs(U,{variant:"secondary",className:"text-xs",children:[l.length," clientes"]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(x,{onClick:F,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx($,{className:"mr-2 h-4 w-4"})," Novo Cliente"]})})]}),e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(me,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(T,{value:n,onChange:s=>_(s.target.value),placeholder:"Buscar cliente...",className:"pl-9 min-w-[220px]"})]}),A.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(xe,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum cliente encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:n?"Tente outro termo de busca.":"Adicione seu primeiro cliente."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card",children:e.jsxs(oe,{children:[e.jsx(ce,{children:e.jsxs(L,{children:[e.jsx(u,{children:"Nome"}),e.jsx(u,{className:"hidden sm:table-cell w-[120px] text-center",children:"Projetos"}),e.jsx(u,{className:"hidden sm:table-cell w-[120px] text-center",children:"Tarefas"}),e.jsx(u,{className:"w-[100px] text-right",children:"Ações"})]})}),e.jsx(de,{children:A.map((s,t)=>{const a=B.get(s.id);return e.jsxs(L,{children:[e.jsx(p,{className:"font-medium",children:s.name}),e.jsx(p,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx(he,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(a==null?void 0:a.projetos)??0})]})}),e.jsx(p,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx(ue,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(a==null?void 0:a.tarefas)??0})]})}),e.jsx(p,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>P(s),title:"Editar",children:e.jsx(pe,{className:"h-3.5 w-3.5"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>g(s.id),title:"Excluir",children:e.jsx(je,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(V,{open:q,onOpenChange:o,children:e.jsxs(W,{className:"sm:max-w-md",children:[e.jsx(X,{children:e.jsx(Y,{children:h?"Editar Cliente":"Novo Cliente"})}),e.jsx("div",{className:"space-y-4 py-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"client-name",children:"Nome"}),e.jsx(T,{id:"client-name",value:i,onChange:s=>j(s.target.value),placeholder:"Nome do cliente",autoFocus:!0,onKeyDown:s=>s.key==="Enter"&&S()})]})}),e.jsxs(Z,{children:[e.jsx(x,{variant:"outline",onClick:()=>o(!1),children:"Cancelar"}),e.jsxs(x,{onClick:S,disabled:!i.trim()||y,children:[y?e.jsx(fe,{className:"h-4 w-4 animate-spin mr-2"}):null,h?"Salvar":"Adicionar"]})]})]})}),e.jsx(ee,{open:!!f,onOpenChange:s=>!s&&g(null),children:e.jsxs(se,{children:[e.jsxs(ae,{children:[e.jsx(te,{children:"Excluir cliente?"}),e.jsx(re,{children:"Esta ação não pode ser desfeita. O cliente será removido permanentemente."})]}),e.jsxs(le,{children:[e.jsx(ie,{children:"Cancelar"}),e.jsx(ne,{onClick:I,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{Oe as default};
