import{$ as oe,r,j as e,m as ie,s as _,h as N}from"./index-DQ4BcdQP.js";import{f as ne,b as ce,a as de}from"./crmTypes-CBVLobRq.js";import{B as me,P as xe}from"./badge-OivbyGqf.js";import{B as C}from"./button-DH8xpC-k.js";import{I as p}from"./input-C6F89SOL.js";import{L as d}from"./label-mOsQqGGT.js";import{T as pe}from"./textarea-B2riuqP0.js";import{S as he}from"./skeleton-aLnbU5aI.js";import{D as ue,a as je,c as fe,d as ge,f as ve}from"./dialog-2MZX0QV0.js";import{A as Ne,a as Ce,b as be,c as ye,d as we,e as Se,f as De,g as Ae}from"./alert-dialog-D9IQb3L1.js";import{T as Te,a as Le,b as W,c as y,d as Ee,e as w}from"./table-DUbkd8gN.js";import{S as Fe,a as Pe,b as ke,c as _e,d as X}from"./select-DAXKJtub.js";import{f as Be,a as Ie,b as qe,A as Oe}from"./formatters-BO9yuSla.js";import{P as ze}from"./ProcessosList-CnCP36LV.js";import{S as He}from"./search-Bj8fSYqN.js";import{U as Re}from"./users-BCXgrLBD.js";import{F as Ue}from"./folder-kanban-FsQx6BL7.js";import{C as $e}from"./clipboard-list-qQzzS2SP.js";import{P as Je}from"./pencil-DhzgQOHl.js";import{T as Ke}from"./trash-2-BJ5LbWD2.js";import{L as Me}from"./loader-circle-C0_UrFHt.js";import{A as Qe}from"./arrow-up-down-wCiWMFFy.js";import"./useQuery-CY_b4SRx.js";import"./index-DlOXUKP_.js";import"./index-BbAhL-mP.js";import"./index-CJ_y7zwL.js";import"./index-AkQFuhpZ.js";import"./chevron-up-BWaheX2M.js";import"./check-Cq8YYEDK.js";import"./download-DDa0nS9m.js";import"./file-text-BdlPsLJJ.js";import"./tabs-DGyYuTHF.js";import"./index-B8TJVCQv.js";import"./TipTapEditor-BYcZjLY_.js";import"./index-B_xqSBte.js";import"./dropdown-menu-DcvD4Blc.js";import"./chevron-right-ByjQVqUK.js";import"./link-CplEW1Wr.js";import"./list-JvkBbfBM.js";import"./quote-Ce0P7SCO.js";import"./purify.es-D9RiKzGB.js";import"./scale-ByEFtVWQ.js";function Is(){const{clients:h,loading:Y}=ne(),{projects:B}=ce(),{tasks:I}=de(),q=oe(),[u,Z]=r.useState(""),[ee,j]=r.useState(!1),[o,O]=r.useState(null),[z,H]=r.useState(!1),[S,D]=r.useState(null),[f,A]=r.useState(""),[R,T]=r.useState(""),[U,L]=r.useState(""),[$,E]=r.useState(""),[J,b]=r.useState(""),[m,F]=r.useState("cpf"),[K,P]=r.useState(""),[g,se]=r.useState("name"),[M,Q]=r.useState("asc"),te=s=>{g===s?Q(t=>t==="asc"?"desc":"asc"):(se(s),Q("asc"))},x=r.useMemo(()=>{const s=new Map;return h.forEach(t=>{const a=t.name.toLowerCase(),l=B.filter(i=>{var n,v;return((n=i.cliente)==null?void 0:n.toLowerCase())===a||((v=i.name)==null?void 0:v.toLowerCase())===a}).length,c=I.filter(i=>{var n;return((n=i.client)==null?void 0:n.toLowerCase())===a||i.client===t.id}).length;s.set(t.id,{projetos:l,tarefas:c})}),s},[h,B,I]),V=r.useMemo(()=>{let s=h;if(u.trim()){const t=u.toLowerCase();s=s.filter(a=>{var l,c;return a.name.toLowerCase().includes(t)||((l=a.email)==null?void 0:l.toLowerCase().includes(t))||((c=a.documento)==null?void 0:c.includes(t))})}return[...s].sort((t,a)=>{var c,i,n,v;let l=0;return g==="name"?l=t.name.localeCompare(a.name,"pt-BR"):g==="projetos"?l=(((c=x.get(t.id))==null?void 0:c.projetos)??0)-(((i=x.get(a.id))==null?void 0:i.projetos)??0):l=(((n=x.get(t.id))==null?void 0:n.tarefas)??0)-(((v=x.get(a.id))==null?void 0:v.tarefas)??0),M==="asc"?l:-l})},[h,u,g,M,x]),ae=()=>{O(null),A(""),T(""),L(""),E(""),b(""),F("cpf"),P(""),j(!0)},G=s=>{O(s),A(s.name),T(s.email||""),L(s.telefone||""),E(s.endereco||""),b(s.documento||""),F(s.tipoDocumento||"cpf"),P(s.dataNascimento||""),j(!0)},re=async()=>{if(f.trim()){H(!0);try{const s=f.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),t={nome:f.trim(),slug:s,email:R.trim()||null,telefone:U.trim()||null,endereco:$.trim()||null,documento:J.trim()||null,tipo_documento:m,data_nascimento:K||null};if(o){const{error:a}=await _.from("mladv_crm_clientes").update(t).eq("airtable_id",o.id);if(a)throw a;N.success("Cliente atualizado!")}else{const a=`local_${Date.now()}`,{error:l}=await _.from("mladv_crm_clientes").insert({...t,airtable_id:a});if(l)throw l;N.success("Cliente adicionado!")}q.invalidateQueries({queryKey:["crm","clientes"]}),j(!1)}catch(s){N.error("Erro: "+s.message)}finally{H(!1)}}},le=async()=>{if(S)try{const{error:s}=await _.from("mladv_crm_clientes").delete().eq("airtable_id",S);if(s)throw s;N.success("Cliente removido"),q.invalidateQueries({queryKey:["crm","clientes"]})}catch(s){N.error("Erro ao remover: "+s.message)}finally{D(null)}},k=({field:s,label:t})=>e.jsxs("button",{onClick:()=>te(s),className:"flex items-center gap-1 hover:text-foreground transition-colors",children:[t,e.jsx(Qe,{className:`h-3 w-3 ${g===s?"text-primary":"text-muted-foreground/50"}`})]});return Y?e.jsxs("div",{className:"space-y-6 pb-20 md:pb-0",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx(he,{className:"h-14 w-full rounded-lg"},s))})]}):e.jsxs(ie.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Clientes"}),e.jsxs(me,{variant:"secondary",className:"text-xs",children:[h.length," clientes"]})]}),e.jsxs(C,{onClick:ae,className:"gold-gradient text-primary-foreground shadow-md hover:opacity-90 transition-opacity",children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Novo Cliente"]})]}),e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(He,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(p,{value:u,onChange:s=>Z(s.target.value),placeholder:"Buscar cliente, e-mail ou documento...",className:"pl-9 min-w-[220px]"})]}),V.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Re,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhum cliente encontrado"}),e.jsx("p",{className:"text-sm mt-1",children:u?"Tente outro termo de busca.":"Adicione seu primeiro cliente."})]}):e.jsx("div",{className:"rounded-lg border border-border bg-card",children:e.jsxs(Te,{children:[e.jsx(Le,{children:e.jsxs(W,{children:[e.jsx(y,{children:e.jsx(k,{field:"name",label:"Nome"})}),e.jsx(y,{className:"hidden sm:table-cell w-[120px] text-center",children:e.jsx(k,{field:"projetos",label:"Projetos"})}),e.jsx(y,{className:"hidden sm:table-cell w-[120px] text-center",children:e.jsx(k,{field:"tarefas",label:"Tarefas"})}),e.jsx(y,{className:"w-[100px] text-right",children:"Ações"})]})}),e.jsx(Ee,{children:V.map(s=>{const t=x.get(s.id);return e.jsxs(W,{className:"cursor-pointer",onClick:()=>G(s),children:[e.jsx(w,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.name}),s.email&&e.jsx("span",{className:"block text-xs text-muted-foreground",children:s.email})]})}),e.jsx(w,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx(Ue,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(t==null?void 0:t.projetos)??0})]})}),e.jsx(w,{className:"hidden sm:table-cell text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 text-muted-foreground",children:[e.jsx($e,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-sm",children:(t==null?void 0:t.tarefas)??0})]})}),e.jsx(w,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",onClick:a=>a.stopPropagation(),children:[e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>G(s),title:"Editar",children:e.jsx(Je,{className:"h-3.5 w-3.5"})}),e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>D(s.id),title:"Excluir",children:e.jsx(Ke,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]})}),e.jsx(ue,{open:ee,onOpenChange:j,children:e.jsxs(je,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsx(ge,{children:o?"Editar Cliente":"Novo Cliente"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-name",children:"Nome *"}),e.jsx(p,{id:"client-name",value:f,onChange:s=>A(s.target.value),placeholder:"Nome do cliente",autoFocus:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-email",children:"E-mail"}),e.jsx(p,{id:"client-email",type:"email",value:R,onChange:s=>T(s.target.value),placeholder:"email@exemplo.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-phone",children:"Telefone"}),e.jsx(p,{id:"client-phone",value:U,onChange:s=>L(Be(s.target.value)),placeholder:"(00) 00000-0000",maxLength:16})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[140px_1fr] gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Tipo"}),e.jsxs(Fe,{value:m,onValueChange:s=>{F(s),b("")},children:[e.jsx(Pe,{children:e.jsx(ke,{})}),e.jsxs(_e,{children:[e.jsx(X,{value:"cpf",children:"CPF"}),e.jsx(X,{value:"cnpj",children:"CNPJ"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-doc",children:m==="cpf"?"CPF":"CNPJ"}),e.jsx(p,{id:"client-doc",value:J,onChange:s=>b(m==="cpf"?Ie(s.target.value):qe(s.target.value)),placeholder:m==="cpf"?"000.000.000-00":"00.000.000/0000-00",maxLength:m==="cpf"?14:18})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-address",children:"Endereço"}),e.jsx(pe,{id:"client-address",value:$,onChange:s=>E(s.target.value),placeholder:"Rua, número, bairro, cidade - UF",rows:2})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"client-dob",children:"Data de Nascimento"}),e.jsx(p,{id:"client-dob",type:"date",value:K,onChange:s=>P(s.target.value)})]}),o&&e.jsx(ze,{clienteAirtableId:o.id}),o&&e.jsx(Oe,{folder:`clientes/${o.id}`})]}),e.jsxs(ve,{children:[e.jsx(C,{variant:"outline",onClick:()=>j(!1),children:"Cancelar"}),e.jsxs(C,{onClick:re,disabled:!f.trim()||z,children:[z&&e.jsx(Me,{className:"h-4 w-4 animate-spin mr-2"}),o?"Salvar":"Adicionar"]})]})]})}),e.jsx(Ne,{open:!!S,onOpenChange:s=>!s&&D(null),children:e.jsxs(Ce,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Excluir cliente?"}),e.jsx(we,{children:"Esta ação não pode ser desfeita. O cliente será removido permanentemente."})]}),e.jsxs(Se,{children:[e.jsx(De,{children:"Cancelar"}),e.jsx(Ae,{onClick:le,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Excluir"})]})]})})]})}export{Is as default};
