import{a as g,u as q}from"./useMutation-CKzEo1M2.js";import{ae as w,I as o}from"./index-C51VJEu4.js";async function _(e){if(e.length===0)return new Map;const{data:t,error:a}=await o.from("mladv_post_categories").select("post_id, category_id").in("post_id",e);if(a||!t)return new Map;const s=[...new Set(t.map(u=>u.category_id))];if(s.length===0)return new Map;const{data:r,error:i}=await o.from("mladv_categories").select("*").in("id",s);if(i||!r)return new Map;const l=new Map(r.map(u=>[u.id,u])),n=new Map;return e.forEach(u=>{const f=t.filter(d=>d.post_id===u).map(d=>l.get(d.category_id)).filter(d=>d!==void 0);n.set(u,f)}),n}function $(e={}){const{published:t,page:a=1,pageSize:s=10,search:r,categorySlug:i,tag:l}=e;return g({queryKey:["posts",{published:t,page:a,pageSize:s,search:r,categorySlug:i,tag:l}],queryFn:async()=>{if(i){const{data:p}=await o.from("mladv_categories").select("id").eq("slug",i).maybeSingle();if(!p)return{posts:[],total:0,totalPages:0};const{data:y}=await o.from("mladv_post_categories").select("post_id").eq("category_id",p.id),h=(y==null?void 0:y.map(m=>m.post_id))||[];if(h.length===0)return{posts:[],total:0,totalPages:0};let c=o.from("mladv_posts").select("*",{count:"exact"}).in("id",h);t!==void 0&&(c=c.eq("published",t)),r&&(c=c.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),l&&(c=c.contains("tags",[l])),c=c.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((a-1)*s,a*s-1);const{data:Q,error:b,count:K}=await c;if(b)throw b;const M=Q||[],S=await _(M.map(m=>m.id));return{posts:M.map(m=>({...m,categories:S.get(m.id)||[]})),total:K??0,totalPages:Math.ceil((K??0)/s)}}let n=o.from("mladv_posts").select("*",{count:"exact"});t!==void 0&&(n=n.eq("published",t)),r&&(n=n.or(`title.ilike.%${r}%,content_html.ilike.%${r}%`)),l&&(n=n.contains("tags",[l])),n=n.order("published_at",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}).range((a-1)*s,a*s-1);const{data:u,error:f,count:d}=await n;if(f)throw f;const v=u||[],P=await _(v.map(p=>p.id));return{posts:v.map(p=>({...p,categories:P.get(p.id)||[]})),total:d??0,totalPages:Math.ceil((d??0)/s)}}})}function W(){return g({queryKey:["featured-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").eq("published",!0).eq("featured",!0).order("published_at",{ascending:!1}).limit(3);if(t)throw t;const a=e||[],s=await _(a.map(i=>i.id));return a.map(i=>({...i,categories:s.get(i.id)||[]}))}})}function x(){return g({queryKey:["all-tags"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("tags").eq("published",!0);if(t)throw t;const a=(e==null?void 0:e.flatMap(r=>r.tags||[]))||[];return[...new Set(a)].sort()}})}function T(e){return g({queryKey:["post",e],queryFn:async()=>{const{data:t,error:a}=await o.from("mladv_posts").select("*").eq("slug",e).eq("published",!0).maybeSingle();if(a)throw a;return t},enabled:!!e})}function A(e){return g({queryKey:["post-by-id",e],queryFn:async()=>{const{data:t,error:a}=await o.from("mladv_posts").select("*").eq("id",e).maybeSingle();if(a)throw a;return t},enabled:!!e})}function D(){return g({queryKey:["all-posts"],queryFn:async()=>{const{data:e,error:t}=await o.from("mladv_posts").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function I(){const e=w();return q({mutationFn:async t=>{const{data:a,error:s}=await o.from("mladv_posts").insert(t).select().single();if(s)throw s;return a},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]})}})}function R(){const e=w();return q({mutationFn:async({id:t,...a})=>{const{data:s,error:r}=await o.from("mladv_posts").update({...a,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(r)throw r;return s},onSuccess:t=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post",t.slug]}),e.invalidateQueries({queryKey:["post-by-id",t.id]})}})}function z(){const e=w();return q({mutationFn:async t=>{(await Promise.all([{table:"mladv_post_categories",result:o.from("mladv_post_categories").delete().eq("post_id",t)},{table:"mladv_newsletter_campaigns",result:o.from("mladv_newsletter_campaigns").update({post_id:null}).eq("post_id",t)},{table:"mladv_post_views",result:o.from("mladv_post_views").delete().eq("post_id",t)},{table:"mladv_post_likes",result:o.from("mladv_post_likes").delete().eq("post_id",t)},{table:"mladv_post_comments",result:o.from("mladv_post_comments").delete().eq("post_id",t)}])).forEach(({table:r,result:i})=>{var l;if(i.error){const n=typeof((l=i.error)==null?void 0:l.message)=="string"?i.error.message:String(i.error);throw new Error(`Erro ao limpar ${r}: ${n}`)}});const{error:s}=await o.from("mladv_posts").delete().eq("id",t);if(s){const r=typeof(s==null?void 0:s.message)=="string"?s.message:String(s);throw new Error(`Erro ao excluir post: ${r}`)}},onSuccess:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["all-posts"]}),e.invalidateQueries({queryKey:["post-views"]}),e.invalidateQueries({queryKey:["post-likes"]}),e.invalidateQueries({queryKey:["post-comments"]}),e.invalidateQueries({queryKey:["all-comments"]})}})}export{W as a,$ as b,T as c,D as d,R as e,z as f,I as g,A as h,x as u};
