import{c as re,r as m,j as e,e as $,h as le}from"./index-DRlkAaou.js";import{u as ie,F as oe,a as v,b as S,c as C,d as T,e as N,t as ce}from"./form-C2Ws4Von.js";import{u as de}from"./useCrmFieldOptions-DSOdz-P_.js";import{S as he,b as me,c as xe,d as ue,e as pe,f as je}from"./sheet-C2hoj6sE.js";import{I as V}from"./input-_XQ-klIu.js";import{B as p}from"./button-DLMKOCBr.js";import{T as ge}from"./textarea-Dm-D92i2.js";import{D as fe,a as ve,c as Se,d as Ce,f as Ne}from"./dialog-CXaYH1Iw.js";import{T as be}from"./TipTapEditor-DtwyAVgX.js";import{B as W,P as ye}from"./badge-CNu_xf_F.js";import{S as we}from"./separator-DiOvrQjp.js";import{S as E,c as A,d as _,e as I,f as g}from"./popover-BVRC4BIT.js";import{A as Te,a as De,b as Ee,c as Ae,d as _e,e as Ie,f as Fe,g as ze}from"./alert-dialog-DkT_OwZe.js";import{C as Me,d as q,e as Oe,S as G}from"./crmTypes-Cf4doRlX.js";import{c as $e,b as Ve}from"./useAirtable-D1dj7Ls_.js";import{L as J}from"./loader-circle-BmKbPMDk.js";import{C as Le}from"./chevron-up-DH1nAqaL.js";import{C as Pe}from"./chevron-right-DdYfdTTh.js";import{U as Q}from"./user-D2kJ7ZpK.js";import{C as Be}from"./circle-check-K-BUcD2F.js";import{C as Re}from"./dropdown-menu-DRnLd-MZ.js";import{C as He}from"./clock-DtdpRlkM.js";import{P as Ue}from"./pencil-B-huywX_.js";import{T as Ke}from"./trash-2-COS8KViw.js";import{o as We,s as b}from"./types-C9wiu8_K.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=re("Expand",[["path",{d:"m21 21-6-6m6 6v-4.8m0 4.8h-4.8",key:"1c15vz"}],["path",{d:"M3 16.2V21m0 0h4.8M3 21l6-6",key:"1fsnz2"}],["path",{d:"M21 7.8V3m0 0h-4.8M21 3l-6 6",key:"hawz9i"}],["path",{d:"M3 7.8V3m0 0h4.8M3 3l6 6",key:"u9ee12"}]]);function Ge({open:n,onOpenChange:c,title:r="Editar Observações",value:i,onChange:h}){const[d,a]=m.useState(i),l=m.useCallback(x=>{x&&a(i),c(x)},[i,c]),o=()=>{h(d),c(!1)};return e.jsx(fe,{open:n,onOpenChange:l,children:e.jsxs(ve,{className:"max-w-4xl w-[95vw] max-h-[90vh] flex flex-col p-0",children:[e.jsx(Se,{className:"px-6 pt-6 pb-0",children:e.jsx(Ce,{children:r})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4 min-h-0",children:e.jsx("div",{className:"[&_.border]:overflow-visible [&_.border]:flex [&_.border]:flex-col [&_.border]:max-h-full",children:e.jsx(be,{content:d,onChange:a,placeholder:"Escreva suas observações aqui..."})})}),e.jsxs(Ne,{className:"px-6 pb-6 pt-2 gap-2 border-t border-border",children:[e.jsx(p,{variant:"outline",onClick:()=>c(!1),children:"Cancelar"}),e.jsx(p,{onClick:o,children:"Salvar"})]})]})})}function Je(n){if(!n)return"";const c=String(n).trim();if(!c)return"";if(/<[a-z][\s\S]*>/i.test(c))return c;const r=c.split(/\r?\n/),i=[];let h=!1;const d=l=>{let o=l.replace(/\\-/g,"-");return o=o.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),o},a=()=>{h&&(i.push("</ul>"),h=!1)};for(const l of r){const o=l.trim();if(!o){a();continue}const x=o.match(/^(#{1,6})\s+(.+)$/);if(x){a();const j=Math.min(x[1].length,6);i.push(`<h${j}>${d(x[2])}</h${j}>`);continue}const y=o.match(/^\*\*(.+?)\*\*:?$/);if(y){a();const j=y[1];j.match(/^(\d+)\)\s+(.+)$/)?i.push(`<h3>${d(j)}</h3>`):i.push(`<p><strong>${d(j)}${o.endsWith(":")?":":""}</strong></p>`);continue}const D=o.match(/^(\d+)\)\s+(.+)$/);if(D){a(),i.push(`<h3>${D[1]}) ${d(D[2])}</h3>`);continue}const w=o.replace(/^\\-/,"-"),M=w.match(/^(-|•|\*)\s+(.+)$/);if(M&&!w.startsWith("**")){h||(i.push("<ul>"),h=!0),i.push(`<li>${d(M[2])}</li>`);continue}a(),i.push(`<p>${d(o)}</p>`)}return a(),i.join("")}function Qe(n){return n?/<[a-z][\s\S]*>/i.test(n)?new DOMParser().parseFromString(n,"text/html").body.textContent||"":n:""}function X({value:n,onChange:c,placeholder:r="Observações...",className:i,modalTitle:h="Editar Observações"}){const[d,a]=m.useState(!1),l=Je(n)||n,o=Qe(l),x=l!==o&&l.includes("<");return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative group",children:[e.jsx(ge,{placeholder:r,className:$("resize-none min-h-[80px] pr-10",i),value:o,onChange:y=>c(y.target.value)}),e.jsx(p,{type:"button",variant:"ghost",size:"icon",className:"absolute top-1.5 right-1.5 h-7 w-7 opacity-50 group-hover:opacity-100 transition-opacity",onClick:()=>a(!0),title:"Expandir editor",children:e.jsx(qe,{className:"w-3.5 h-3.5"})}),x&&e.jsx("span",{className:"absolute bottom-1.5 right-1.5 text-[10px] text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:"Texto formatado"})]}),e.jsx(Ge,{open:d,onOpenChange:a,title:h,value:l,onChange:c})]})}const Xe=We({title:b().trim().min(1,"Título obrigatório").max(200),deadline:b().optional(),priority:b().min(1),status:b().min(1),clientName:b().optional(),projectId:b().optional(),assignee:b().optional(),description:b().max(2e3).optional()}),Ye=Object.entries(G);function K({initial:n,onSave:c,onCancel:r,saving:i}){const[h,d]=m.useState(n??{title:"",deadline:"",status:"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(V,{placeholder:"Título da sub-tarefa *",value:h.title,onChange:a=>d(l=>({...l,title:a.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(V,{type:"date",value:h.deadline,onChange:a=>d(l=>({...l,deadline:a.target.value}))}),e.jsxs(E,{value:h.status,onValueChange:a=>d(l=>({...l,status:a})),children:[e.jsx(A,{children:e.jsx(_,{})}),e.jsx(I,{children:Ye.map(([a,l])=>e.jsx(g,{value:a,children:l},a))})]})]}),e.jsxs(E,{value:h.assignee||"_none_",onValueChange:a=>d(l=>({...l,assignee:a==="_none_"?"":a})),children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(_,{placeholder:"Responsável..."})]})}),e.jsxs(I,{children:[e.jsx(g,{value:"_none_",children:"— Sem responsável —"}),q.map(a=>e.jsx(g,{value:a,children:a},a))]})]}),e.jsx(X,{value:h.notes,onChange:a=>d(l=>({...l,notes:a})),placeholder:"Observações...",className:"min-h-[60px]",modalTitle:"Editar Observações da Subtarefa"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(p,{type:"button",variant:"ghost",size:"sm",onClick:r,disabled:i,children:"Cancelar"}),e.jsxs(p,{type:"button",size:"sm",disabled:!h.title.trim()||i,onClick:()=>c(h),children:[i&&e.jsx(J,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function Ze({sub:n,onEdit:c,onDelete:r,onToggleStatus:i}){const h=n.dueDate&&n.dueDate<new Date().toISOString().split("T")[0]&&n.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:i,className:"mt-0.5 shrink-0",children:n.completed?e.jsx(Be,{className:"w-4 h-4 text-primary"}):e.jsx(Re,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:$("text-sm",n.completed&&"line-through text-muted-foreground"),children:n.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx(W,{variant:"secondary",className:$("text-[10px]",Oe[n.status]),children:G[n.status]}),n.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(Q,{className:"w-3 h-3"}),n.assignee]}),n.dueDate&&e.jsxs("span",{className:$("text-[10px] flex items-center gap-0.5",h?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(He,{className:"w-3 h-3"}),new Date(n.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),n.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:n.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(p,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:c,children:e.jsx(Ue,{className:"w-3 h-3"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:r,children:e.jsx(Ke,{className:"w-3 h-3"})})]})]})}function ys({open:n,onOpenChange:c,task:r,defaultClientName:i,onSave:h,onCreateSubtask:d,onUpdateSubtask:a,onDeleteSubtask:l}){const o=!r,[x,y]=m.useState(!1),[D,w]=m.useState(!1);$e();const{projects:M}=Ve(),{getOptions:j}=de(),B=j("tarefa_status"),Y=j("tarefa_prioridade"),[L,Z]=m.useState(!0),[R,F]=m.useState(!1),[k,z]=m.useState(null),[O,P]=m.useState(null),u=ie({resolver:ce(Xe),defaultValues:{title:"",deadline:"",priority:"media",status:"pendente",clientName:"",projectId:"",assignee:"",description:""}});m.useEffect(()=>{n&&(F(!1),z(null),r?u.reset({title:r.title,deadline:r.dueDate??"",priority:r.priority,status:r.status,clientName:r.client??"",projectId:r.projectId??"",assignee:r.assignee??"",description:r.description??""}):u.reset({title:"",deadline:"",priority:"media",status:"pendente",clientName:i??"",projectId:"",assignee:"",description:""}))},[n,r]);const ee=async s=>{y(!0);try{await h(s,o,r==null?void 0:r.airtableId),c(!1)}catch(t){le.error("Erro ao salvar tarefa: "+t.message),console.error("Erro ao salvar tarefa:",t)}finally{y(!1)}},se=m.useCallback(async s=>{if(!(!(r!=null&&r.airtableId)||!d)){w(!0);try{await d(r.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),F(!1)}finally{w(!1)}}},[r,d]),ae=m.useCallback(async(s,t)=>{if(a){w(!0);try{await a(s,{title:t.title,deadline:t.deadline||void 0,status:t.status,assignee:t.assignee||void 0,notes:t.notes||void 0}),z(null)}finally{w(!1)}}},[a]),te=m.useCallback(async s=>{if(!a)return;const t=s.completed?"A fazer":"Concluído";await a(s.id,{status:t})},[a]),ne=m.useCallback(async()=>{if(!(!O||!l))try{await l(O)}finally{P(null)}},[O,l]),f=(r==null?void 0:r.subtasks)??[],H=f.filter(s=>s.completed).length,U=f.length>0?Math.round(H/f.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(he,{open:n,onOpenChange:c,children:e.jsxs(me,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(xe,{className:"mb-6",children:[e.jsx(ue,{children:o?"Nova Tarefa":"Editar Tarefa"}),e.jsx(pe,{children:o?"Preencha os dados para criar a tarefa e sincronizar com o Airtable.":"Altere os campos e salve. A atualização será sincronizada automaticamente."})]}),e.jsx(oe,{...u,children:e.jsxs("form",{onSubmit:u.handleSubmit(ee),className:"space-y-5",children:[e.jsx(v,{control:u.control,name:"title",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Título *"}),e.jsx(T,{children:e.jsx(V,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(N,{})]})}),e.jsx(v,{control:u.control,name:"deadline",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Prazo"}),e.jsx(T,{children:e.jsx(V,{type:"date",...s})}),e.jsx(N,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(v,{control:u.control,name:"priority",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Prioridade"}),e.jsxs(E,{onValueChange:s.onChange,value:s.value,children:[e.jsx(T,{children:e.jsx(A,{children:e.jsx(_,{})})}),e.jsx(I,{children:Y.map(t=>e.jsx(g,{value:t.value,children:t.label},t.value))})]}),e.jsx(N,{})]})}),e.jsx(v,{control:u.control,name:"status",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Status"}),e.jsxs(E,{onValueChange:s.onChange,value:s.value,children:[e.jsx(T,{children:e.jsx(A,{children:e.jsx(_,{})})}),e.jsx(I,{children:B.map(t=>e.jsx(g,{value:t.value,children:t.label},t.value))})]}),e.jsx(N,{})]})})]}),e.jsx(v,{control:u.control,name:"projectId",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Projeto"}),e.jsxs(E,{onValueChange:t=>s.onChange(t==="none"?"":t),value:s.value||"none",children:[e.jsx(T,{children:e.jsx(A,{children:e.jsx(_,{placeholder:"Selecione..."})})}),e.jsxs(I,{children:[e.jsx(g,{value:"none",children:"— Sem projeto —"}),M.map(t=>e.jsx(g,{value:t.id,children:t.name},t.id))]})]}),e.jsx(N,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(v,{control:u.control,name:"clientName",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Cliente"}),e.jsx(Me,{value:s.value,onValueChange:t=>s.onChange(t)}),e.jsx(N,{})]})}),e.jsx(v,{control:u.control,name:"assignee",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Responsável"}),e.jsxs(E,{onValueChange:t=>s.onChange(t==="_none_"?"":t),value:s.value||"_none_",children:[e.jsx(T,{children:e.jsx(A,{children:e.jsx(_,{placeholder:"Selecione..."})})}),e.jsxs(I,{children:[e.jsx(g,{value:"_none_",children:"— Sem responsável —"}),q.map(t=>e.jsx(g,{value:t,children:t},t))]})]}),e.jsx(N,{})]})})]}),e.jsx(v,{control:u.control,name:"description",render:({field:s})=>e.jsxs(S,{children:[e.jsx(C,{children:"Descrição"}),e.jsx(T,{children:e.jsx(X,{value:s.value??"",onChange:s.onChange,placeholder:"Detalhes sobre a tarefa...",modalTitle:"Editar Descrição da Tarefa"})}),e.jsx(N,{})]})}),e.jsxs(je,{className:"pt-2 gap-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:x,children:"Cancelar"}),e.jsxs(p,{type:"submit",disabled:x,children:[x&&e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),o?"Criar tarefa":"Salvar alterações"]})]})]})}),!o&&r&&e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>Z(!L),children:[L?e.jsx(Le,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"}),"Sub-tarefas",f.length>0&&e.jsxs(W,{variant:"secondary",className:"text-[10px] ml-1",children:[H,"/",f.length]})]}),e.jsxs(p,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{F(!0),z(null)},children:[e.jsx(ye,{className:"w-3.5 h-3.5"})," Nova"]})]}),f.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${U}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[U,"%"]})]}),L&&e.jsxs("div",{className:"space-y-1",children:[f.map(s=>k===s.id?e.jsx(K,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:t=>ae(s.id,t),onCancel:()=>z(null),saving:D},s.id):e.jsx(Ze,{sub:s,onEdit:()=>{z(s.id),F(!1)},onDelete:()=>P(s.id),onToggleStatus:()=>te(s)},s.id)),f.length===0&&!R&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),R&&e.jsx(K,{onSave:se,onCancel:()=>F(!1),saving:D})]})]})]})]})}),e.jsx(Te,{open:!!O,onOpenChange:s=>!s&&P(null),children:e.jsxs(De,{children:[e.jsxs(Ee,{children:[e.jsx(Ae,{children:"Excluir sub-tarefa?"}),e.jsx(_e,{children:"Esta ação removerá a sub-tarefa do Airtable e não pode ser desfeita."})]}),e.jsxs(Ie,{children:[e.jsx(Fe,{children:"Cancelar"}),e.jsx(ze,{onClick:ne,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{X as E,ys as T,Je as m};
