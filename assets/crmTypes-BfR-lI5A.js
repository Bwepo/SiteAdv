import{$ as q,r as m,h as b,s as h}from"./index-CzndBbIM.js";import{u as P}from"./useQuery-Cznpg9ws.js";const d=t=>h.from(t),w={agenda:["crm","agenda"],tarefas:["crm","tarefas"],clientes:["crm","clientes"],projetos:["crm","projetos"],all:["crm"]};function j(){return`local_${crypto.randomUUID().slice(0,12)}`}async function f(){const{data:t,error:s}=await d("mladv_crm_agenda").select("airtable_id,titulo,data_local,hora_local,tipo,status,cliente,local_evento,descricao,projeto_airtable_id").order("data_local",{ascending:!1});if(s)throw s;return{events:(t||[]).map(a=>({id:a.airtable_id,title:a.titulo||"",date:a.data_local||"",time:a.hora_local||void 0,type:a.tipo||"reuniao",status:a.status||"pendente",client:a.cliente||void 0,location:a.local_evento||void 0,description:a.descricao||void 0,projectId:a.projeto_airtable_id||void 0,airtableId:a.airtable_id}))}}async function x(){const[{data:t,error:s},{data:g,error:a}]=await Promise.all([d("mladv_crm_tarefas").select("airtable_id,titulo,descricao,status,prioridade,deadline,cliente,responsavel,projeto_airtable_id,numero_processo").order("deadline",{ascending:!0,nullsFirst:!1}),d("mladv_crm_subtarefas").select("airtable_id,titulo,status,deadline,responsavel,tarefa_airtable_id,numero_processo,raw_fields")]);if(s)throw s;if(a)throw a;return{tasks:(t||[]).map(u=>{const r=(g||[]).filter(p=>p.tarefa_airtable_id===u.airtable_id).map(p=>{const S=p.raw_fields||{},E=p.status||"A fazer";return{id:p.airtable_id,title:p.titulo||"",completed:E==="Concluído",status:E,dueDate:p.deadline||void 0,assignee:p.responsavel||void 0,notes:S.Observações||void 0,numeroProcesso:p.numero_processo||void 0,parentTaskId:u.airtable_id}});return{id:u.airtable_id,title:u.titulo||"",description:u.descricao||void 0,status:u.status||"pendente",priority:u.prioridade||"media",dueDate:u.deadline||void 0,client:u.cliente||void 0,assignee:u.responsavel||void 0,projectId:u.projeto_airtable_id||void 0,numeroProcesso:u.numero_processo||void 0,subtasks:r,createdAt:"",updatedAt:"",airtableId:u.airtable_id}})}}async function L(){const{data:t,error:s}=await d("mladv_crm_clientes").select("airtable_id,nome,slug,numero_processo,raw_fields").order("nome",{ascending:!0});if(s)throw console.error("[CRM] fetchClientes error:",s),s;return console.log("[CRM] fetchClientes returned",t==null?void 0:t.length,"rows"),{clients:(t||[]).map(a=>{const l=a.raw_fields||{};return{id:a.airtable_id,name:a.nome||"",slug:a.slug||"",email:l.email||l.Email||void 0,telefone:l.telefone||l.Telefone||void 0,endereco:l.endereco||l.Endereco||l.Endereço||void 0,documento:l.documento||l.Documento||l.CPF||l.CNPJ||void 0,tipoDocumento:l.tipo_documento||"cpf",numeroProcesso:a.numero_processo||void 0,dataNascimento:l.data_nascimento||l["Data de Nascimento"]||void 0}})}}async function R(){console.log("[CRM] fetchProjetos: starting query...");const{data:t,error:s}=await d("mladv_crm_projetos").select("airtable_id,nome,slug,status,tipo,data_inicio,observacoes,raw_fields,cover_url,cliente").order("nome",{ascending:!0});if(console.log("[CRM] fetchProjetos result:",{rows:t==null?void 0:t.length,error:s}),s)throw console.error("[CRM] fetchProjetos error:",s),s;return{projects:(t||[]).map(a=>{const l=a.raw_fields||{};return{id:a.airtable_id,name:a.nome||"",slug:a.slug||"",status:a.status||"Ativo",tipo:a.tipo||void 0,dataInicio:a.data_inicio||void 0,observacoes:a.observacoes||void 0,coverUrl:a.cover_url||l.cover_url||void 0,cliente:a.cliente||void 0}})}}function z(){const t=q(),{data:s,isLoading:g,error:a}=P({queryKey:w.agenda,queryFn:f}),l=(s==null?void 0:s.events)??[],u=a?a.message:null,r=m.useCallback(()=>{t.invalidateQueries({queryKey:w.agenda})},[t]),p=m.useCallback(async(n,o)=>{t.setQueryData(w.agenda,_=>_&&{..._,events:_.events.map(A=>A.id===n?{...A,status:o}:A)});try{await d("mladv_crm_agenda").update({status:o}).eq("airtable_id",n)}catch{r()}},[r,t]),S=m.useCallback(async n=>{await d("mladv_crm_agenda").delete().eq("airtable_id",n),r(),b.success("Compromisso removido com sucesso.")},[r]),E=m.useCallback(async n=>{const o=j();await d("mladv_crm_agenda").insert({airtable_id:o,titulo:n.title,data_local:n.date,hora_local:n.time||null,tipo:n.type,status:n.status,cliente:n.clientName||null,local_evento:n.location||null,descricao:n.description||null,projeto_airtable_id:n.projectAirtableId||null}),r(),b.success("Compromisso criado.")},[r]),v=m.useCallback(async(n,o)=>{const _={};o.title!==void 0&&(_.titulo=o.title),o.date!==void 0&&(_.data_local=o.date),o.time!==void 0&&(_.hora_local=o.time||null),o.type!==void 0&&(_.tipo=o.type),o.status!==void 0&&(_.status=o.status),o.clientName!==void 0&&(_.cliente=o.clientName||null),o.location!==void 0&&(_.local_evento=o.location||null),o.description!==void 0&&(_.descricao=o.description||null),await d("mladv_crm_agenda").update(_).eq("airtable_id",n),r(),b.success("Compromisso atualizado.")},[r]);return{events:l,loading:g,error:u,updateEventStatus:p,updateEvent:v,createEvent:E,deleteEvent:S}}function U(){const t=q(),{data:s,isLoading:g,error:a}=P({queryKey:w.tarefas,queryFn:x}),l=(s==null?void 0:s.tasks)??[],u=a?a.message:null,r=m.useCallback(()=>{t.invalidateQueries({queryKey:w.tarefas})},[t]),p=m.useCallback(i=>{t.setQueryData(w.tarefas,e=>{if(!e)return e;const c=typeof i=="function"?i(e.tasks):i;return{...e,tasks:c}})},[t]),S=m.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,c=>c&&{...c,tasks:c.tasks.map(y=>y.id===i?{...y,status:e}:y)});try{await d("mladv_crm_tarefas").update({status:e}).eq("airtable_id",i)}catch{r()}},[r,t]),E=m.useCallback(async i=>{await d("mladv_crm_tarefas").delete().eq("airtable_id",i),r(),b.success("Tarefa removida.")},[r]),v=m.useCallback(async i=>{const e=j();await d("mladv_crm_tarefas").insert({airtable_id:e,titulo:i.title,deadline:i.deadline||null,prioridade:i.priority,status:i.status,cliente:i.clientName||null,responsavel:i.assignee||null,descricao:i.description||null,projeto_airtable_id:i.projectId||null,numero_processo:i.numeroProcesso||null}),r(),b.success("Tarefa criada.")},[r]),n=m.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,y=>y&&{...y,tasks:y.tasks.map(k=>{if(k.id!==i)return k;const C={...k};return e.title!==void 0&&(C.title=e.title),e.deadline!==void 0&&(C.dueDate=e.deadline||void 0),e.priority!==void 0&&(C.priority=e.priority),e.status!==void 0&&(C.status=e.status),e.clientName!==void 0&&(C.client=e.clientName||void 0),e.assignee!==void 0&&(C.assignee=e.assignee||void 0),e.description!==void 0&&(C.description=e.description||void 0),C})});const c={};e.title!==void 0&&(c.titulo=e.title),e.deadline!==void 0&&(c.deadline=e.deadline||null),e.priority!==void 0&&(c.prioridade=e.priority),e.status!==void 0&&(c.status=e.status),e.clientName!==void 0&&(c.cliente=e.clientName||null),e.assignee!==void 0&&(c.responsavel=e.assignee||null),e.description!==void 0&&(c.descricao=e.description||null),e.projectId!==void 0&&(c.projeto_airtable_id=e.projectId||null),e.numeroProcesso!==void 0&&(c.numero_processo=e.numeroProcesso||null);try{await d("mladv_crm_tarefas").update(c).eq("airtable_id",i)}catch{r(),b.error("Erro ao atualizar tarefa.");return}b.success("Tarefa atualizada.")},[r,t]),o=m.useCallback(async(i,e)=>{const c=j();return await d("mladv_crm_subtarefas").insert({airtable_id:c,titulo:e.title,tarefa_airtable_id:i,status:e.status??"A fazer",deadline:e.deadline||null,responsavel:e.assignee||null,raw_fields:e.notes?{Observações:e.notes}:{},numero_processo:e.numeroProcesso||null}),r(),b.success("Sub-tarefa criada."),c},[r]),_=m.useCallback(async(i,e)=>{t.setQueryData(w.tarefas,y=>y&&{...y,tasks:y.tasks.map(k=>({...k,subtasks:k.subtasks.map(C=>{if(C.id!==i)return C;const T={...C};return e.title!==void 0&&(T.title=e.title),e.status!==void 0&&(T.status=e.status,T.completed=e.status==="Concluído"),e.deadline!==void 0&&(T.dueDate=e.deadline||void 0),e.assignee!==void 0&&(T.assignee=e.assignee||void 0),T})}))});const c={};e.title!==void 0&&(c.titulo=e.title),e.status!==void 0&&(c.status=e.status),e.deadline!==void 0&&(c.deadline=e.deadline||null),e.assignee!==void 0&&(c.responsavel=e.assignee||null),e.numeroProcesso!==void 0&&(c.numero_processo=e.numeroProcesso||null);try{await d("mladv_crm_subtarefas").update(c).eq("airtable_id",i)}catch{r(),b.error("Erro ao atualizar sub-tarefa.");return}b.success("Sub-tarefa atualizada.")},[r,t]),A=m.useCallback(async i=>{await d("mladv_crm_subtarefas").delete().eq("airtable_id",i),r(),b.success("Sub-tarefa removida.")},[r]);return{tasks:l,setTasks:p,loading:g,error:u,updateTaskStatus:S,deleteTask:E,createTask:v,updateTask:n,createSubtask:o,updateSubtask:_,deleteSubtask:A}}function N(){const{data:t,isLoading:s,error:g}=P({queryKey:w.clientes,queryFn:L}),a=(t==null?void 0:t.clients)??[],l=g?g.message:null;return{clients:a,loading:s,error:l}}function K(){const t=q(),{data:s,isLoading:g,error:a}=P({queryKey:w.projetos,queryFn:R}),l=(s==null?void 0:s.projects)??[],u=a?a.message:null,r=m.useCallback(()=>{t.invalidateQueries({queryKey:w.projetos})},[t]),p=m.useCallback(async v=>{const n=j(),o=v.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");await d("mladv_crm_projetos").insert({airtable_id:n,nome:v.name,slug:o,status:v.status||"Ativo",tipo:v.tipo||null,observacoes:v.observacoes||null,cliente:v.cliente||null}),r(),b.success("Projeto criado.")},[r]),S=m.useCallback(async(v,n)=>{const o={};n.name!==void 0&&(o.nome=n.name,o.slug=n.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")),n.status!==void 0&&(o.status=n.status),n.tipo!==void 0&&(o.tipo=n.tipo||null),n.observacoes!==void 0&&(o.observacoes=n.observacoes||null),n.cliente!==void 0&&(o.cliente=n.cliente||null),await d("mladv_crm_projetos").update(o).eq("airtable_id",v),r(),b.success("Projeto atualizado.")},[r]),E=m.useCallback(async v=>{await d("mladv_crm_projetos").delete().eq("airtable_id",v),r(),b.success("Projeto removido.")},[r]);return{projects:l,loading:g,error:u,createProject:p,updateProject:S,deleteProject:E}}const D={"A fazer":"A fazer","Em andamento":"Em andamento",Concluído:"Concluído"},M={"A fazer":"bg-red-100 text-red-800","Em andamento":"bg-yellow-100 text-yellow-800",Concluído:"bg-green-100 text-green-800"},Q=["Ativo","Arquivado","Encerrado","Suspenso"],B={reuniao:"Reunião",audiencia:"Audiência",prazo:"Prazo",consulta:"Consulta",lembrete:"Lembrete",outro:"Outro"},F={confirmado:"Confirmado",pendente:"Pendente",cancelado:"Cancelado",reagendado:"Reagendado"},Y={pendente:"Pendente",agendado:"Agendado",em_andamento:"Em Andamento",em_tramite:"Em Trâmite",concluida:"Concluída",cancelada:"Cancelada"},V={alta:"Alta",media:"Média",baixa:"Baixa"},$={reuniao:"bg-blue-100 text-blue-800",audiencia:"bg-purple-100 text-purple-800",prazo:"bg-red-100 text-red-800",consulta:"bg-green-100 text-green-800",lembrete:"bg-yellow-100 text-yellow-800",outro:"bg-gray-100 text-gray-800"},J={alta:"bg-red-100 text-red-800",media:"bg-yellow-100 text-yellow-800",baixa:"bg-green-100 text-green-800"},G={pendente:"bg-red-100 text-red-800",agendado:"bg-slate-100 text-slate-800",em_andamento:"bg-yellow-100 text-yellow-800",em_tramite:"bg-blue-100 text-blue-800",concluida:"bg-green-100 text-green-800",cancelada:"bg-gray-100 text-gray-800"},H=["Mariana Lima","Equipe ML"];export{$ as E,Q as P,D as S,J as T,U as a,K as b,V as c,B as d,F as e,N as f,H as g,M as h,G as i,Y as j,z as u};
