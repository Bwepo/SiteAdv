import{r as o,j as e,e as B,h as ne}from"./index-BQQTb6fi.js";import{u as le,F as ie,a as j,b as p,c as g,d as C,e as f,t as oe}from"./form-hJojq2nQ.js";import{E as H,A as ce}from"./formatters-Bj0D2YiU.js";import{u as de}from"./useCrmFieldOptions-C6JGyQjT.js";import{S as me,b as xe,c as ue,d as he,e as je,f as pe}from"./sheet-4Od2LD5-.js";import{I}from"./input-CE2c-gnk.js";import{B as T}from"./button-BYLOxE-2.js";import{B as $,P as ge}from"./badge-AZvcS7pt.js";import{S as fe}from"./separator-iHZbXC_6.js";import{S as N,a as y,b,c as w,d as x}from"./select-DQAAOv5a.js";import{A as ve,a as Se,b as Ce,c as Ne,d as ye,e as be,f as we,g as Te}from"./alert-dialog-ChmPdjXe.js";import{f as De,b as Ae,g as q,h as Ee,S as J}from"./crmTypes-CAMEoS1a.js";import{C as Ie}from"./ClientSelect-lI4Gz5nG.js";import{u as _e}from"./ProcessosList-CljVwuyv.js";import{S as Pe}from"./search-CUmnT7KL.js";import{L as G}from"./loader-circle-xgMqgjFX.js";import{C as Fe}from"./chevron-up-B-WZdaNo.js";import{C as Oe}from"./chevron-right-CI2J5RP5.js";import{U as Q}from"./user-BUfEaEVo.js";import{C as Be}from"./circle-check-DIlz5WY7.js";import{C as Le}from"./dropdown-menu-Dd49uv-w.js";import{C as Ve}from"./clock-BDyA_6pe.js";import{P as ze}from"./pencil-CSW1l7Ok.js";import{T as Re}from"./trash-2-BJDwYsZn.js";import{o as Me,s as v}from"./types-C9wiu8_K.js";function Ue({value:l,onValueChange:u,placeholder:t="Selecione um processo..."}){const{processos:d}=_e(),[i,m]=o.useState(""),n=o.useMemo(()=>{if(!i.trim())return d;const r=i.toLowerCase();return d.filter(h=>{var D;return h.numero.toLowerCase().includes(r)||((D=h.titulo)==null?void 0:D.toLowerCase().includes(r))})},[d,i]);return e.jsxs(N,{value:l||"none",onValueChange:r=>u(r==="none"?"":r),children:[e.jsx(y,{children:e.jsx(b,{placeholder:t})}),e.jsxs(w,{children:[e.jsx("div",{className:"px-2 pb-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),e.jsx(I,{value:i,onChange:r=>m(r.target.value),placeholder:"Buscar processo...",className:"h-8 pl-7 text-sm",onKeyDown:r=>r.stopPropagation()})]})}),e.jsx(x,{value:"none",children:"— Sem processo —"}),n.map(r=>e.jsxs(x,{value:r.numero,children:[e.jsx("span",{className:"font-mono text-xs",children:r.numero}),r.titulo&&e.jsxs("span",{className:"ml-1 text-xs text-muted-foreground",children:["• ",r.titulo]})]},r.id)),n.length===0&&i.trim()&&e.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"Nenhum processo encontrado"})]})]})}const Ke=Me({title:v().trim().min(1,"Título obrigatório").max(200),deadline:v().optional(),priority:v().min(1),status:v().min(1),clientName:v().optional(),projectId:v().optional(),assignee:v().optional(),description:v().max(2e3).optional(),numeroProcesso:v().max(25).optional()}),He=Object.entries(J);function K({initial:l,onSave:u,onCancel:t,saving:d}){const[i,m]=o.useState(l??{title:"",deadline:"",status:"A fazer",assignee:"",notes:""});return e.jsxs("div",{className:"space-y-3 p-3 bg-muted/50 rounded-lg border border-border",children:[e.jsx(I,{placeholder:"Título da sub-tarefa *",value:i.title,onChange:n=>m(r=>({...r,title:n.target.value})),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(I,{type:"date",value:i.deadline,onChange:n=>m(r=>({...r,deadline:n.target.value}))}),e.jsxs(N,{value:i.status,onValueChange:n=>m(r=>({...r,status:n})),children:[e.jsx(y,{children:e.jsx(b,{})}),e.jsx(w,{children:He.map(([n,r])=>e.jsx(x,{value:n,children:r},n))})]})]}),e.jsxs(N,{value:i.assignee||"_none_",onValueChange:n=>m(r=>({...r,assignee:n==="_none_"?"":n})),children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx(b,{placeholder:"Responsável..."})]})}),e.jsxs(w,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),q.map(n=>e.jsx(x,{value:n,children:n},n))]})]}),e.jsx(H,{value:i.notes,onChange:n=>m(r=>({...r,notes:n})),placeholder:"Observações...",className:"min-h-[60px]",modalTitle:"Editar Observações da Subtarefa"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(T,{type:"button",variant:"ghost",size:"sm",onClick:t,disabled:d,children:"Cancelar"}),e.jsxs(T,{type:"button",size:"sm",disabled:!i.title.trim()||d,onClick:()=>u(i),children:[d&&e.jsx(G,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Salvar"]})]})]})}function $e({sub:l,onEdit:u,onDelete:t,onToggleStatus:d}){const i=l.dueDate&&l.dueDate<new Date().toISOString().split("T")[0]&&l.status!=="Concluído";return e.jsxs("div",{className:"flex items-start gap-2 group p-2 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("button",{onClick:d,className:"mt-0.5 shrink-0",children:l.completed?e.jsx(Be,{className:"w-4 h-4 text-primary"}):e.jsx(Le,{className:"w-4 h-4 text-muted-foreground hover:text-primary transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:B("text-sm",l.completed&&"line-through text-muted-foreground"),children:l.title}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-0.5",children:[e.jsx($,{variant:"secondary",className:B("text-[10px]",Ee[l.status]),children:J[l.status]}),l.assignee&&e.jsxs("span",{className:"text-[10px] flex items-center gap-0.5 text-muted-foreground",children:[e.jsx(Q,{className:"w-3 h-3"}),l.assignee]}),l.dueDate&&e.jsxs("span",{className:B("text-[10px] flex items-center gap-0.5",i?"text-destructive font-medium":"text-muted-foreground"),children:[e.jsx(Ve,{className:"w-3 h-3"}),new Date(l.dueDate+"T12:00:00").toLocaleDateString("pt-BR")]})]}),l.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:l.notes})]}),e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",children:[e.jsx(T,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:u,children:e.jsx(ze,{className:"w-3 h-3"})}),e.jsx(T,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive",onClick:t,children:e.jsx(Re,{className:"w-3 h-3"})})]})]})}function ps({open:l,onOpenChange:u,task:t,defaultClientName:d,onSave:i,onCreateSubtask:m,onUpdateSubtask:n,onDeleteSubtask:r}){const h=!t,[D,L]=o.useState(!1),[V,_]=o.useState(!1);De();const{projects:W}=Ae(),{getOptions:z}=de(),X=z("tarefa_status"),Y=z("tarefa_prioridade"),[F,Z]=o.useState(!0),[R,A]=o.useState(!1),[k,E]=o.useState(null),[P,O]=o.useState(null),c=le({resolver:oe(Ke),defaultValues:{title:"",deadline:"",priority:"media",status:"pendente",clientName:"",projectId:"",assignee:"",description:""}});o.useEffect(()=>{l&&(A(!1),E(null),t?c.reset({title:t.title,deadline:t.dueDate??"",priority:t.priority,status:t.status,clientName:t.client??"",projectId:t.projectId??"",assignee:t.assignee??"",description:t.description??"",numeroProcesso:t.numeroProcesso??""}):c.reset({title:"",deadline:"",priority:"media",status:"pendente",clientName:d??"",projectId:"",assignee:"",description:"",numeroProcesso:""}))},[l,t]);const ee=async s=>{L(!0);try{await i(s,h,t==null?void 0:t.airtableId),u(!1)}catch(a){ne.error("Erro ao salvar tarefa: "+a.message),console.error("Erro ao salvar tarefa:",a)}finally{L(!1)}},se=o.useCallback(async s=>{if(!(!(t!=null&&t.airtableId)||!m)){_(!0);try{await m(t.airtableId,{title:s.title,deadline:s.deadline||void 0,status:s.status,assignee:s.assignee||void 0,notes:s.notes||void 0}),A(!1)}finally{_(!1)}}},[t,m]),ae=o.useCallback(async(s,a)=>{if(n){_(!0);try{await n(s,{title:a.title,deadline:a.deadline||void 0,status:a.status,assignee:a.assignee||void 0,notes:a.notes||void 0}),E(null)}finally{_(!1)}}},[n]),te=o.useCallback(async s=>{if(!n)return;const a=s.completed?"A fazer":"Concluído";await n(s.id,{status:a})},[n]),re=o.useCallback(async()=>{if(!(!P||!r))try{await r(P)}finally{O(null)}},[P,r]),S=(t==null?void 0:t.subtasks)??[],M=S.filter(s=>s.completed).length,U=S.length>0?Math.round(M/S.length*100):0;return e.jsxs(e.Fragment,{children:[e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(xe,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsxs(ue,{className:"mb-6",children:[e.jsx(he,{children:h?"Nova Tarefa":"Editar Tarefa"}),e.jsx(je,{children:h?"Preencha os dados para criar a tarefa.":"Altere os campos e salve."})]}),e.jsx(ie,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(ee),className:"space-y-5",children:[e.jsx(j,{control:c.control,name:"title",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Título *"}),e.jsx(C,{children:e.jsx(I,{placeholder:"Ex: Elaborar petição inicial",...s})}),e.jsx(f,{})]})}),e.jsx(j,{control:c.control,name:"deadline",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Prazo"}),e.jsx(C,{children:e.jsx(I,{type:"date",...s})}),e.jsx(f,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:c.control,name:"priority",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Prioridade"}),e.jsxs(N,{onValueChange:s.onChange,value:s.value,children:[e.jsx(C,{children:e.jsx(y,{children:e.jsx(b,{})})}),e.jsx(w,{children:Y.map(a=>e.jsx(x,{value:a.value,children:a.label},a.value))})]}),e.jsx(f,{})]})}),e.jsx(j,{control:c.control,name:"status",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Status"}),e.jsxs(N,{onValueChange:s.onChange,value:s.value,children:[e.jsx(C,{children:e.jsx(y,{children:e.jsx(b,{})})}),e.jsx(w,{children:X.map(a=>e.jsx(x,{value:a.value,children:a.label},a.value))})]}),e.jsx(f,{})]})})]}),e.jsx(j,{control:c.control,name:"projectId",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Projeto"}),e.jsxs(N,{onValueChange:a=>s.onChange(a==="none"?"":a),value:s.value||"none",children:[e.jsx(C,{children:e.jsx(y,{children:e.jsx(b,{placeholder:"Selecione..."})})}),e.jsxs(w,{children:[e.jsx(x,{value:"none",children:"— Sem projeto —"}),W.map(a=>e.jsx(x,{value:a.id,children:a.name},a.id))]})]}),e.jsx(f,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(j,{control:c.control,name:"clientName",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Cliente"}),e.jsx(Ie,{value:s.value,onValueChange:a=>s.onChange(a)}),e.jsx(f,{})]})}),e.jsx(j,{control:c.control,name:"assignee",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Responsável"}),e.jsxs(N,{onValueChange:a=>s.onChange(a==="_none_"?"":a),value:s.value||"_none_",children:[e.jsx(C,{children:e.jsx(y,{children:e.jsx(b,{placeholder:"Selecione..."})})}),e.jsxs(w,{children:[e.jsx(x,{value:"_none_",children:"— Sem responsável —"}),q.map(a=>e.jsx(x,{value:a,children:a},a))]})]}),e.jsx(f,{})]})})]}),e.jsx(j,{control:c.control,name:"numeroProcesso",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Processo Judicial"}),e.jsx(Ue,{value:s.value??"",onValueChange:s.onChange}),e.jsx(f,{})]})}),e.jsx(j,{control:c.control,name:"description",render:({field:s})=>e.jsxs(p,{children:[e.jsx(g,{children:"Descrição"}),e.jsx(C,{children:e.jsx(H,{value:s.value??"",onChange:s.onChange,placeholder:"Detalhes sobre a tarefa...",modalTitle:"Editar Descrição da Tarefa"})}),e.jsx(f,{})]})}),!h&&(t==null?void 0:t.airtableId)&&e.jsx(ce,{folder:`tarefas/${t.airtableId}`}),e.jsxs(pe,{className:"pt-2 gap-2",children:[e.jsx(T,{type:"button",variant:"outline",onClick:()=>u(!1),disabled:D,children:"Cancelar"}),e.jsxs(T,{type:"submit",disabled:D,children:[D&&e.jsx(G,{className:"w-4 h-4 mr-2 animate-spin"}),h?"Criar tarefa":"Salvar alterações"]})]})]})}),!h&&t&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"my-6"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{className:"flex items-center gap-1.5 text-sm font-semibold hover:text-primary transition-colors",onClick:()=>Z(!F),children:[F?e.jsx(Fe,{className:"w-4 h-4"}):e.jsx(Oe,{className:"w-4 h-4"}),"Sub-tarefas",S.length>0&&e.jsxs($,{variant:"secondary",className:"text-[10px] ml-1",children:[M,"/",S.length]})]}),e.jsxs(T,{type:"button",variant:"outline",size:"sm",className:"gap-1",onClick:()=>{A(!0),E(null)},children:[e.jsx(ge,{className:"w-3.5 h-3.5"})," Nova"]})]}),S.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary rounded-full h-2 transition-all",style:{width:`${U}%`}})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[U,"%"]})]}),F&&e.jsxs("div",{className:"space-y-1",children:[S.map(s=>k===s.id?e.jsx(K,{initial:{title:s.title,deadline:s.dueDate??"",status:s.status,assignee:s.assignee??"",notes:s.notes??""},onSave:a=>ae(s.id,a),onCancel:()=>E(null),saving:V},s.id):e.jsx($e,{sub:s,onEdit:()=>{E(s.id),A(!1)},onDelete:()=>O(s.id),onToggleStatus:()=>te(s)},s.id)),S.length===0&&!R&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"Nenhuma sub-tarefa ainda."}),R&&e.jsx(K,{onSave:se,onCancel:()=>A(!1),saving:V})]})]})]})]})}),e.jsx(ve,{open:!!P,onOpenChange:s=>!s&&O(null),children:e.jsxs(Se,{children:[e.jsxs(Ce,{children:[e.jsx(Ne,{children:"Excluir sub-tarefa?"}),e.jsx(ye,{children:"Esta ação removerá a sub-tarefa permanentemente e não pode ser desfeita."})]}),e.jsxs(be,{children:[e.jsx(we,{children:"Cancelar"}),e.jsx(Te,{onClick:re,className:"bg-destructive text-destructive-foreground",children:"Excluir"})]})]})})]})}export{Ue as P,ps as T};
