import{a as c,u as l}from"./skeleton-DIB-6xDC.js";import{ad as m,I as o}from"./index-ldgMa1ZI.js";function y(){const t=m();return c({mutationFn:async e=>{const{error:s}=await o.from("mladv_newsletter_subscribers").insert({email:e.email,name:e.name||null,source:e.source||"website",consent_ip:e.consent_ip??null});if(s)throw s;return{email:e.email,name:e.name??null,source:e.source??"website"}},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function f(){const t=m();return c({mutationFn:async e=>{const{data:s,error:r}=await o.rpc("mladv_admin_add_newsletter_subscriber",{p_email:e.email,p_name:e.name??null});if(r)throw r;return s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function _(){return l({queryKey:["newsletter-subscribers"],queryFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_subscribers").select("*").order("subscribed_at",{ascending:!1});if(e)throw e;return t||[]}})}function p(){return l({queryKey:["newsletter-stats"],queryFn:async()=>{const{data:t,error:e,count:s}=await o.from("mladv_newsletter_subscribers").select("*",{count:"exact"}).is("unsubscribed_at",null);if(e)throw e;const r=new Date;r.setDate(r.getDate()-7);const a=(t||[]).filter(n=>new Date(n.subscribed_at)>=r).length;return{total:s||0,active:s||0,newThisWeek:a}}})}function v(){const t=m();return c({mutationFn:async e=>{const{error:s}=await o.from("mladv_newsletter_subscribers").delete().eq("id",e);if(s)throw s},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-subscribers"]}),t.invalidateQueries({queryKey:["newsletter-stats"]})}})}function g(){return c({mutationFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_subscribers").select("email, name, subscribed_at").is("unsubscribed_at",null).order("subscribed_at",{ascending:!1});if(e)throw e;const s=["Email","Nome","Data de Inscrição"],r=(t||[]).map(u=>[u.email,u.name||"",new Date(u.subscribed_at).toLocaleDateString("pt-BR")]),a=[s.join(","),...r.map(u=>u.map(w=>`"${w}"`).join(","))].join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");return i.href=URL.createObjectURL(n),i.download=`newsletter-subscribers-${new Date().toISOString().split("T")[0]}.csv`,i.click(),a}})}function h(){return l({queryKey:["newsletter-campaigns"],queryFn:async()=>{const{data:t,error:e}=await o.from("mladv_newsletter_campaigns").select("id, subject, status, created_at, sent_at, post:mladv_posts(title, slug)").order("created_at",{ascending:!1});if(e)throw e;return t||[]}})}function q(t){return l({queryKey:["newsletter-campaign",t],enabled:!!t,queryFn:async()=>{if(!t)return null;const{data:e,error:s}=await o.from("mladv_newsletter_campaigns").select("*, post:mladv_posts(title, slug)").eq("id",t).maybeSingle();if(s)throw s;const{data:r,error:a}=await o.from("mladv_newsletter_deliveries").select("status").eq("campaign_id",t);if(a)throw a;const n={queued:0,sent:0,failed:0,skipped:0};return(r||[]).forEach(i=>{i.status&&i.status in n&&(n[i.status]+=1)}),{campaign:e,deliveryCounts:n}}})}function S(){const t=m();return c({mutationFn:async e=>{var i;const{data:s,error:r}=await o.auth.getSession();if(r||!((i=s.session)!=null&&i.access_token))throw r||new Error("Sessão inválida.");const a=await fetch("https://bnflexlwuingvohzxerg.supabase.co/functions/v1/send-newsletter-campaign",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.session.access_token}`},body:JSON.stringify({campaign_id:e})}),n=await a.json();if(!a.ok)throw new Error((n==null?void 0:n.message)||"Falha ao iniciar envio.");return n},onSuccess:()=>{t.invalidateQueries({queryKey:["newsletter-campaigns"]}),t.invalidateQueries({queryKey:["newsletter-campaign"]})}})}export{_ as a,p as b,f as c,v as d,g as e,h as f,S as g,q as h,y as u};
