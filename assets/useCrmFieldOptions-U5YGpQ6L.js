import{u as x}from"./useQuery-0YKFqAJ_.js";import{$ as K,s as n,h as i}from"./index-DuYpUTKK.js";import{u as f}from"./useMutation-DamW9zaN.js";const d="crm-field-options";function j(){const m=K(),{data:l=[],isLoading:v}=x({queryKey:[d],queryFn:async()=>{const{data:e,error:r}=await n.from("mladv_crm_field_options").select("*").order("sort_order",{ascending:!0});if(r)throw r;return e},staleTime:1e3*60*5}),u=e=>l.filter(r=>r.field_name===e),g=e=>{const r=u(e);return Object.fromEntries(r.map(t=>[t.value,t.label]))},y=e=>{const r=u(e);return Object.fromEntries(r.map(t=>[t.value,t.color]))},b=e=>{const r=u(e);return Object.fromEntries(r.map(t=>{const a=t.color.match(/bg-(\w+)-\d+/),o=a?a[1]:"muted";return[t.value,`border-t-${o}-500/60`]}))},w=e=>u(e).map(r=>r.value),O=f({mutationFn:async e=>{const r=l.filter(o=>o.field_name===e.field_name),t=r.length>0?Math.max(...r.map(o=>o.sort_order)):0,{error:a}=await n.from("mladv_crm_field_options").insert({field_name:e.field_name,value:e.value,label:e.label,color:e.color,sort_order:t+1});if(a)throw a},onSuccess:()=>{m.invalidateQueries({queryKey:[d]}),i.success("Opção adicionada!")},onError:e=>i.error("Erro ao adicionar: "+e.message)}),h=f({mutationFn:async e=>{const{id:r,value:t,...a}=e;if(t){const s=l.find(Q=>Q.id===r);s&&s.value!==t&&await p(s.field_name,s.value,t)}const o=t?{...a,value:t}:a,{error:c}=await n.from("mladv_crm_field_options").update(o).eq("id",r);if(c)throw c},onSuccess:()=>{m.invalidateQueries({queryKey:[d]}),i.success("Opção atualizada!")},onError:e=>i.error("Erro ao atualizar: "+e.message)}),_=e=>{switch(e){case"tarefa_status":return{table:"mladv_crm_tarefas",column:"status"};case"tarefa_prioridade":return{table:"mladv_crm_tarefas",column:"prioridade"};case"agenda_tipo":return{table:"mladv_crm_agenda",column:"tipo"};case"agenda_status":return{table:"mladv_crm_agenda",column:"status"};case"subtarefa_status":return{table:"mladv_crm_subtarefas",column:"status"}}},E=async(e,r)=>{const{table:t,column:a}=_(e),o=n,{count:c,error:s}=await o.from(t).select("id",{count:"exact",head:!0}).eq(a,r);if(s)throw s;return c??0},p=async(e,r,t)=>{const{table:a,column:o}=_(e),c=n,{error:s}=await c.from(a).update({[o]:t}).eq(o,r);if(s)throw s},q=f({mutationFn:async({id:e,migrateToValue:r})=>{const t=l.find(o=>o.id===e);t&&r&&await p(t.field_name,t.value,r);const{error:a}=await n.from("mladv_crm_field_options").delete().eq("id",e);if(a)throw a},onSuccess:()=>{m.invalidateQueries({queryKey:[d]}),i.success("Opção removida e registros migrados!")},onError:e=>i.error("Erro ao remover: "+e.message)}),F=f({mutationFn:async e=>{const r=e.map(o=>n.from("mladv_crm_field_options").update({sort_order:o.sort_order}).eq("id",o.id)),a=(await Promise.all(r)).find(o=>o.error);if(a!=null&&a.error)throw a.error},onSuccess:()=>{m.invalidateQueries({queryKey:[d]})},onError:e=>i.error("Erro ao reordenar: "+e.message)});return{allOptions:l,isLoading:v,getOptions:u,getLabelsMap:g,getColorsMap:y,getBorderColorsMap:b,getOrderedValues:w,countRecords:E,addOption:O,updateOption:h,deleteOption:q,reorderOptions:F}}export{j as u};
