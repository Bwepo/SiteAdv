import{u as c,a as m}from"./useMutation-DncFD02b.js";import{ae as l,I as u}from"./index-ziHXrAGQ.js";function f(){const e=l();return c({mutationFn:async t=>{var r,a,o;const n=t.email.trim().toLowerCase(),s=((r=t.source)==null?void 0:r.trim())||"website",{error:i}=await u.from("mladv_newsletter_subscribers").upsert({email:n,name:((a=t.name)==null?void 0:a.trim())||null,source:s,confirmed:!0,unsubscribed_at:null},{onConflict:"email"});if(i)throw i;return{email:n,name:((o=t.name)==null?void 0:o.trim())||null,source:s}},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function y(){const e=l();return c({mutationFn:async t=>{var o;const n=t.email.trim().toLowerCase(),s=((o=t.name)==null?void 0:o.trim())||null,{data:i,error:r}=await u.rpc("mladv_admin_add_newsletter_subscriber",{p_email:n,p_name:s});if(!r)return i;const a=await u.from("mladv_newsletter_subscribers").upsert({email:n,name:s,source:"admin",confirmed:!0,unsubscribed_at:null},{onConflict:"email"}).select("*").single();if(a.error)throw a.error;return a.data},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function _(){return m({queryKey:["newsletter-subscribers"],queryFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_subscribers").select("*").order("subscribed_at",{ascending:!1});if(t)throw t;return e||[]}})}function p(){return m({queryKey:["newsletter-stats"],queryFn:async()=>{const{data:e,error:t,count:n}=await u.from("mladv_newsletter_subscribers").select("*",{count:"exact"}).is("unsubscribed_at",null);if(t)throw t;const s=new Date;s.setDate(s.getDate()-7);const i=(e||[]).filter(r=>new Date(r.subscribed_at)>=s).length;return{total:n||0,active:n||0,newThisWeek:i}}})}function g(){const e=l();return c({mutationFn:async t=>{const{error:n}=await u.from("mladv_newsletter_subscribers").delete().eq("id",t);if(n)throw n},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-subscribers"]}),e.invalidateQueries({queryKey:["newsletter-stats"]})}})}function v(){return c({mutationFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_subscribers").select("email, name, subscribed_at").is("unsubscribed_at",null).order("subscribed_at",{ascending:!1});if(t)throw t;const n=["Email","Nome","Data de Inscrição"],s=(e||[]).map(o=>[o.email,o.name||"",new Date(o.subscribed_at).toLocaleDateString("pt-BR")]),i=[n.join(","),...s.map(o=>o.map(d=>`"${d}"`).join(","))].join(`
`),r=new Blob([i],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");return a.href=URL.createObjectURL(r),a.download=`newsletter-subscribers-${new Date().toISOString().split("T")[0]}.csv`,a.click(),i}})}function h(){return m({queryKey:["newsletter-campaigns"],queryFn:async()=>{const{data:e,error:t}=await u.from("mladv_newsletter_campaigns").select("id, subject, status, created_at, sent_at, post:mladv_posts(title, slug)").order("created_at",{ascending:!1});if(t)throw t;return e||[]}})}function q(e){return m({queryKey:["newsletter-campaign",e],enabled:!!e,queryFn:async()=>{if(!e)return null;const{data:t,error:n}=await u.from("mladv_newsletter_campaigns").select("*, post:mladv_posts(title, slug)").eq("id",e).maybeSingle();if(n)throw n;const{data:s,error:i}=await u.from("mladv_newsletter_deliveries").select("status").eq("campaign_id",e);if(i)throw i;const r={queued:0,sent:0,failed:0,skipped:0};return(s||[]).forEach(a=>{a.status&&a.status in r&&(r[a.status]+=1)}),{campaign:t,deliveryCounts:r}}})}function S(){const e=l();return c({mutationFn:async t=>{var a;const{data:n,error:s}=await u.auth.getSession();if(s||!((a=n.session)!=null&&a.access_token))throw s||new Error("Sessão inválida.");const i=await fetch("https://bnflexlwuingvohzxerg.supabase.co/functions/v1/send-newsletter-campaign",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.session.access_token}`},body:JSON.stringify({campaign_id:t})}),r=await i.json();if(!i.ok)throw new Error((r==null?void 0:r.message)||"Falha ao iniciar envio.");return r},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-campaigns"]}),e.invalidateQueries({queryKey:["newsletter-campaign"]})}})}function C(){const e=l();return c({mutationFn:async t=>{(await Promise.all([{table:"mladv_newsletter_deliveries",result:u.from("mladv_newsletter_deliveries").delete().eq("campaign_id",t)}])).forEach(({table:i,result:r})=>{var a;if(r.error){const o=typeof((a=r.error)==null?void 0:a.message)=="string"?r.error.message:String(r.error);throw new Error(`Erro ao limpar ${i}: ${o}`)}});const{error:s}=await u.from("mladv_newsletter_campaigns").delete().eq("id",t);if(s){const i=typeof(s==null?void 0:s.message)=="string"?s.message:String(s);throw new Error(`Erro ao excluir campanha: ${i}`)}},onSuccess:()=>{e.invalidateQueries({queryKey:["newsletter-campaigns"]}),e.invalidateQueries({queryKey:["newsletter-campaign"]})}})}export{p as a,h as b,_ as c,y as d,g as e,v as f,S as g,C as h,q as i,f as u};
